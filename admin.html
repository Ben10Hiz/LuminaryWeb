<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luminary | Communications Command Center</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600&family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #0a0a0f;
            --bg-card: #12121a;
            --bg-elevated: #1a1a24;
            --bg-input: #0d0d12;
            --gold-primary: #D4A853;
            --gold-light: #E8C875;
            --gold-dark: #B8923F;
            --text-primary: #F5F5F5;
            --text-secondary: #A0A0A0;
            --text-muted: #666;
            --border-subtle: rgba(212, 168, 83, 0.2);
            --border-strong: rgba(212, 168, 83, 0.4);
            --success: #4ade80;
            --success-bg: rgba(74, 222, 128, 0.1);
            --warning: #fbbf24;
            --warning-bg: rgba(251, 191, 36, 0.1);
            --error: #f87171;
            --error-bg: rgba(248, 113, 113, 0.1);
            --info: #60a5fa;
            --info-bg: rgba(96, 165, 250, 0.1);
            --media-accent: #FF6B35;
            --media-bg: rgba(255, 107, 53, 0.1);
            --university-accent: #D4A853;
            --university-bg: rgba(212, 168, 83, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Cormorant Garamond', Georgia, serif; 
            background: var(--bg-deep); 
            color: var(--text-primary); 
            min-height: 100vh;
            font-size: 16px;
            line-height: 1.6;
        }

        /* ===== LOGIN GATE ===== */
        .login-gate {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-deep);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-gate.hidden { display: none; }

        .login-container {
            width: 100%;
            max-width: 420px;
            padding: 2rem;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .login-logo svg {
            width: 48px;
            height: 48px;
            color: var(--gold-primary);
            margin-bottom: 1rem;
        }

        .login-logo h1 {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            letter-spacing: 0.2em;
            color: var(--gold-primary);
            margin-bottom: 0.25rem;
        }

        .login-logo p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            letter-spacing: 0.1em;
        }

        .login-box {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 2rem;
        }

        .login-title {
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            text-align: center;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .login-field {
            margin-bottom: 1.25rem;
        }

        .login-label {
            display: block;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .login-input {
            width: 100%;
            padding: 0.85rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            letter-spacing: 0.15em;
            text-align: center;
            transition: all 0.2s ease;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--gold-primary);
            box-shadow: 0 0 0 3px rgba(212, 168, 83, 0.1);
        }

        .login-input.error {
            border-color: var(--error);
            animation: shake 0.4s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        .login-btn {
            width: 100%;
            padding: 0.9rem;
            background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
            border: none;
            border-radius: 6px;
            color: var(--bg-deep);
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            font-weight: 600;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(212, 168, 83, 0.3);
        }

        .login-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .login-error {
            margin-top: 1rem;
            padding: 0.75rem;
            background: var(--error-bg);
            border: 1px solid var(--error);
            border-radius: 6px;
            color: var(--error);
            font-size: 0.85rem;
            text-align: center;
            display: none;
        }

        .login-error.visible { display: block; }

        .login-footer {
            margin-top: 1.5rem;
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* ===== APP CONTAINER ===== */
        .app-container { 
            display: none;
            grid-template-columns: 260px 380px 1fr; 
            height: 100vh; 
            overflow: hidden;
        }

        .app-container.active { display: grid; }

        /* ===== SAVE INDICATOR ===== */
        .save-indicator {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            padding: 0.6rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 100;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(10px);
        }

        .save-indicator.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .save-indicator.saving { color: var(--warning); border-color: var(--warning); }
        .save-indicator.saved { color: var(--success); border-color: var(--success); }
        .save-indicator.error { color: var(--error); border-color: var(--error); }

        .save-indicator svg { width: 14px; height: 14px; }

        /* ===== SIDEBAR ===== */
        .sidebar {
            background: var(--bg-card);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border-subtle);
        }

        .logo-row {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            margin-bottom: 0.35rem;
        }

        .logo-row svg { height: 24px; width: 24px; color: var(--gold-primary); }

        .logo-text {
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            color: var(--gold-primary);
            letter-spacing: 0.15em;
        }

        .logo-subtitle {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .sidebar-nav { flex: 1; overflow-y: auto; padding: 0.75rem 0; }

        .nav-group { margin-bottom: 1.25rem; }

        .nav-group-title {
            font-family: 'Cinzel', serif;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--text-muted);
            padding: 0.5rem 1.25rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.65rem;
            padding: 0.6rem 1.25rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
            border-left: 2px solid transparent;
            font-size: 0.9rem;
        }

        .nav-item:hover { background: rgba(255,255,255,0.02); color: var(--text-primary); }
        .nav-item.active { 
            background: var(--university-bg); 
            color: var(--gold-primary); 
            border-left-color: var(--gold-primary); 
        }

        .nav-item svg { width: 18px; height: 18px; opacity: 0.7; flex-shrink: 0; }
        .nav-item.active svg { opacity: 1; }

        .nav-badge {
            margin-left: auto;
            background: var(--gold-primary);
            color: var(--bg-deep);
            font-size: 0.65rem;
            font-weight: 600;
            padding: 0.1rem 0.45rem;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
        }

        .nav-badge.media { background: var(--media-accent); }
        .nav-badge.success { background: var(--success); }
        .nav-badge.warning { background: var(--warning); color: var(--bg-deep); }
        .nav-badge.unread { background: var(--error); animation: pulse 2s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .sidebar-footer {
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--border-subtle);
        }

        .logout-btn {
            width: 100%;
            padding: 0.6rem;
            background: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.15s ease;
        }

        .logout-btn:hover { border-color: var(--error); color: var(--error); }
        .logout-btn svg { width: 14px; height: 14px; }

        /* ===== LIST PANEL ===== */
        .list-panel {
            background: var(--bg-deep);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .list-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-card);
        }

        .list-header-title {
            font-family: 'Cinzel', serif;
            font-size: 0.95rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .list-search {
            display: flex;
            align-items: center;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            gap: 0.5rem;
        }

        .list-search svg { width: 16px; height: 16px; color: var(--text-muted); flex-shrink: 0; }

        .list-search input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
            outline: none;
        }

        .list-search input::placeholder { color: var(--text-muted); }

        .list-filters {
            display: flex;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            background: var(--bg-card);
        }

        .filter-chip {
            padding: 0.35rem 0.7rem;
            background: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .filter-chip:hover { border-color: var(--gold-primary); color: var(--text-primary); }
        .filter-chip.active { background: var(--gold-primary); border-color: var(--gold-primary); color: var(--bg-deep); }

        .list-content { flex: 1; overflow-y: auto; }

        .partner-item {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            cursor: pointer;
            transition: background 0.15s ease;
            position: relative;
        }

        .partner-item:hover { background: rgba(255,255,255,0.02); }
        .partner-item.active { background: var(--university-bg); }
        .partner-item.unread::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--gold-primary);
        }

        .partner-item-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 0.35rem;
        }

        .partner-item-name {
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-primary);
            line-height: 1.3;
        }

        .partner-item-time {
            font-size: 0.7rem;
            color: var(--text-muted);
            white-space: nowrap;
            margin-left: 0.5rem;
        }

        .partner-item-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.35rem;
        }

        .type-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .type-dot.university { background: var(--gold-primary); }
        .type-dot.media { background: var(--media-accent); }

        .partner-item-detail {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .partner-item-preview {
            font-size: 0.8rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .status-indicator.pending { background: var(--warning-bg); color: var(--warning); }
        .status-indicator.viewed { background: var(--info-bg); color: var(--info); }
        .status-indicator.responded { background: var(--success-bg); color: var(--success); }
        .status-indicator.accepted { background: var(--success-bg); color: var(--success); }

        /* ===== DETAIL PANEL ===== */
        .detail-panel {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-deep);
        }

        .detail-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .detail-header-info h2 {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 0.2rem;
        }

        .detail-header-info p {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .detail-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            padding: 0.45rem 0.85rem;
            background: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .action-btn:hover { border-color: var(--gold-primary); color: var(--gold-primary); }
        .action-btn svg { width: 14px; height: 14px; }

        .action-btn.primary {
            background: var(--gold-primary);
            border-color: var(--gold-primary);
            color: var(--bg-deep);
        }

        .action-btn.primary:hover { background: var(--gold-light); }

        .action-btn.danger { border-color: var(--error); color: var(--error); }
        .action-btn.danger:hover { background: var(--error-bg); }

        /* Tabs */
        .detail-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-card);
        }

        .detail-tab {
            padding: 0.85rem 1.25rem;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            font-family: 'Cinzel', serif;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .detail-tab:hover { color: var(--text-primary); }
        .detail-tab.active { color: var(--gold-primary); border-bottom-color: var(--gold-primary); }

        /* Conversation Thread */
        .detail-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .message-thread { display: flex; flex-direction: column; gap: 1.25rem; }

        .message-item {
            max-width: 85%;
            position: relative;
        }

        .message-item.outbound { align-self: flex-start; }
        .message-item.inbound { align-self: flex-end; }

        .message-bubble {
            padding: 1rem 1.25rem;
            border-radius: 12px;
            position: relative;
        }

        .message-item.outbound .message-bubble {
            background: linear-gradient(135deg, rgba(212, 168, 83, 0.15) 0%, rgba(212, 168, 83, 0.05) 100%);
            border: 1px solid rgba(212, 168, 83, 0.25);
            border-radius: 12px 12px 12px 2px;
        }

        .message-item.inbound .message-bubble {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 12px 12px 2px 12px;
        }

        .message-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .message-sender {
            font-family: 'Cinzel', serif;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--gold-primary);
        }

        .message-item.inbound .message-sender { color: var(--text-secondary); }

        .message-time {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .message-body {
            font-size: 0.9rem;
            line-height: 1.7;
            color: var(--text-primary);
        }

        .message-body p { margin-bottom: 0.75rem; }
        .message-body p:last-child { margin-bottom: 0; }
        .message-body strong { color: var(--gold-light); }

        .message-actions {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(255,255,255,0.05);
            display: flex;
            gap: 0.75rem;
        }

        .message-action-btn {
            font-size: 0.7rem;
            color: var(--text-muted);
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.15s ease;
        }

        .message-action-btn:hover { color: var(--gold-primary); background: rgba(212, 168, 83, 0.1); }
        .message-action-btn.delete:hover { color: var(--error); background: var(--error-bg); }
        .message-action-btn svg { width: 12px; height: 12px; }

        /* Compose Area */
        .compose-area {
            padding: 1.25rem 1.5rem;
            border-top: 1px solid var(--border-subtle);
            background: var(--bg-card);
        }

        .compose-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .compose-label {
            font-family: 'Cinzel', serif;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
        }

        .compose-tools {
            display: flex;
            gap: 0.5rem;
        }

        .tool-btn {
            width: 28px;
            height: 28px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .tool-btn:hover { border-color: var(--gold-primary); color: var(--gold-primary); }
        .tool-btn svg { width: 14px; height: 14px; }

        .compose-editor {
            width: 100%;
            min-height: 100px;
            max-height: 200px;
            padding: 0.85rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            line-height: 1.6;
            resize: vertical;
            transition: border-color 0.15s ease;
        }

        .compose-editor:focus { outline: none; border-color: var(--gold-primary); }
        .compose-editor::placeholder { color: var(--text-muted); }

        .compose-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 0.85rem;
        }

        .compose-info {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .compose-buttons { display: flex; gap: 0.5rem; }

        /* Empty State */
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            text-align: center;
            padding: 2rem;
        }

        .empty-state svg { width: 48px; height: 48px; margin-bottom: 1rem; opacity: 0.3; }
        .empty-state h3 { font-family: 'Cinzel', serif; font-size: 1rem; margin-bottom: 0.5rem; color: var(--text-secondary); }
        .empty-state p { font-size: 0.85rem; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }

        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal {
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            transform: translateY(20px);
            transition: transform 0.2s ease;
        }

        .modal-overlay.active .modal { transform: translateY(0); }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
        }

        .modal-close:hover { color: var(--text-primary); }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Form Elements */
        .form-group { margin-bottom: 1.25rem; }

        .form-label {
            display: block;
            font-family: 'Cinzel', serif;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            transition: border-color 0.15s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--gold-primary);
        }

        .form-textarea {
            min-height: 250px;
            line-height: 1.7;
            resize: vertical;
        }

        .form-help {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.35rem;
        }

        .variable-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .variable-chip {
            padding: 0.3rem 0.6rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--gold-primary);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .variable-chip:hover { background: var(--university-bg); border-color: var(--gold-primary); }

        /* Partner Details */
        .details-grid {
            display: grid;
            gap: 1.25rem;
        }

        .detail-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 1.25rem;
        }

        .detail-card-title {
            font-family: 'Cinzel', serif;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--gold-primary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-subtle);
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 0.5rem 0;
            font-size: 0.85rem;
        }

        .detail-row-label { color: var(--text-secondary); }
        .detail-row-value { color: var(--text-primary); text-align: right; max-width: 60%; }

        .key-display {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            background: var(--bg-input);
            padding: 0.3rem 0.5rem;
            border-radius: 4px;
            letter-spacing: 0.05em;
        }

        .color-swatch-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .color-swatch {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .contact-card {
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }

        .contact-card:last-child { border-bottom: none; padding-bottom: 0; }

        .contact-name { font-weight: 500; margin-bottom: 0.2rem; }
        .contact-title { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.15rem; }
        .contact-email { font-size: 0.8rem; color: var(--gold-primary); }

        /* Confirm Dialog */
        .confirm-dialog {
            max-width: 400px;
        }

        .confirm-dialog .modal-body {
            text-align: center;
            padding: 2rem;
        }

        .confirm-dialog .confirm-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem;
            color: var(--warning);
        }

        .confirm-dialog h4 {
            font-family: 'Cinzel', serif;
            margin-bottom: 0.5rem;
        }

        .confirm-dialog p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-subtle); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gold-dark); }

        /* File Preview */
        .file-preview-container { display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 0.5rem 0; }
        .file-preview-container:empty { display: none; }
        .file-preview-item { position: relative; background: var(--bg-dark); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .file-preview-item img { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; }
        .file-preview-item .file-icon { width: 40px; height: 40px; background: var(--bg-deep); border-radius: 4px; display: flex; align-items: center; justify-content: center; color: var(--gold); font-size: 0.7rem; font-weight: 600; }
        .file-preview-info { flex: 1; min-width: 0; }
        .file-preview-name { color: var(--text-light); font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px; }
        .file-preview-size { color: var(--text-muted); font-size: 0.7rem; }
        .file-preview-remove { position: absolute; top: -6px; right: -6px; width: 18px; height: 18px; background: #e74c3c; border: none; border-radius: 50%; color: white; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* Message Attachments */
        .message-attachments { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-subtle); }
        .message-attachment { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: var(--bg-deep); border-radius: 6px; cursor: pointer; transition: all 0.2s ease; text-decoration: none; color: inherit; position: relative; }
        .message-attachment:hover { background: rgba(212, 175, 55, 0.15); }
        .message-attachment.pdf { border-left: 3px solid #E74C3C; }
        .message-attachment.doc { border-left: 3px solid #2B579A; }
        .message-attachment.spreadsheet { border-left: 3px solid #217346; }
        .message-attachment.image { border-left: 3px solid #9B59B6; }
        .message-attachment-icon { width: 32px; height: 32px; border-radius: 4px; display: flex; align-items: center; justify-content: center; background: var(--bg-card); color: var(--gold); font-size: 0.65rem; font-weight: 600; }
        .message-attachment-icon img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; }
        .message-attachment-icon svg { width: 18px; height: 18px; }
        .message-attachment-info { font-size: 0.8rem; flex: 1; min-width: 0; }
        .message-attachment-name { color: var(--text-light); max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .message-attachment-size { color: var(--text-muted); font-size: 0.7rem; }
        .attachment-actions { display: flex; gap: 0.25rem; }
        .attachment-download, .attachment-preview { background: transparent; border: none; color: var(--text-muted); cursor: pointer; padding: 0.25rem; border-radius: 4px; transition: all 0.2s ease; }
        .attachment-download:hover, .attachment-preview:hover { color: var(--gold); background: rgba(212, 175, 55, 0.1); }
        .attachment-download svg, .attachment-preview svg { width: 16px; height: 16px; }

        /* File Preview Modal */
        .file-preview-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .file-preview-modal.active { opacity: 1; visibility: visible; }
        .file-preview-modal-content { width: 90vw; height: 90vh; background: var(--bg-card); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; }
        .file-preview-modal-header { display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-subtle); background: var(--bg-deep); }
        .file-preview-modal-title { font-weight: 600; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 60%; }

        /* ===== SPLIT VIEW DOCUMENT PREVIEW ===== */
        .detail-panel { position: relative; transition: all 0.3s ease; }
        .detail-panel.has-preview { }
        
        .detail-main { display: flex; flex-direction: column; height: 100%; transition: all 0.3s ease; }
        .detail-panel.has-preview .detail-main { width: 50%; border-right: 1px solid var(--border-subtle); }
        
        /* Document Preview Panel */
        .doc-preview-panel {
            position: absolute;
            top: 0;
            right: 0;
            width: 50%;
            height: 100%;
            background: var(--bg-card);
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
        }
        .detail-panel.has-preview .doc-preview-panel {
            transform: translateX(0);
            opacity: 1;
        }
        
        /* Preview Header */
        .doc-preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            background: linear-gradient(135deg, var(--bg-deep) 0%, var(--bg-card) 100%);
            border-bottom: 1px solid var(--border-subtle);
        }
        .doc-preview-header-info {
            flex: 1;
            min-width: 0;
        }
        .doc-preview-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0.25rem;
        }
        .doc-preview-meta {
            display: flex;
            gap: 0.75rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .doc-preview-meta span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .doc-preview-actions {
            display: flex;
            gap: 0.5rem;
        }
        .doc-preview-btn {
            width: 36px;
            height: 36px;
            background: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .doc-preview-btn:hover {
            border-color: var(--gold-primary);
            color: var(--gold-primary);
            background: rgba(212, 168, 83, 0.1);
        }
        .doc-preview-btn.close:hover {
            border-color: var(--error);
            color: var(--error);
            background: var(--error-bg);
        }
        .doc-preview-btn svg {
            width: 18px;
            height: 18px;
        }
        
        /* Preview Tabs */
        .doc-preview-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-deep);
        }
        .doc-preview-tab {
            flex: 1;
            padding: 0.75rem;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 0.8rem;
            font-family: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            position: relative;
            transition: all 0.2s ease;
        }
        .doc-preview-tab:hover {
            color: var(--text-primary);
            background: rgba(255,255,255,0.03);
        }
        .doc-preview-tab.active {
            color: var(--gold-primary);
        }
        .doc-preview-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gold-primary);
        }
        .doc-preview-tab svg {
            width: 14px;
            height: 14px;
        }
        .doc-preview-tab-badge {
            background: var(--gold-primary);
            color: var(--bg-deep);
            font-size: 0.65rem;
            padding: 0.1rem 0.35rem;
            border-radius: 8px;
            font-weight: 600;
        }
        
        /* Preview Content Area */
        .doc-preview-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* Preview Viewer */
        .doc-preview-viewer {
            flex: 1;
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #0d0d12;
            position: relative;
        }
        .doc-preview-viewer iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }
        .doc-preview-viewer img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            cursor: zoom-in;
        }
        .doc-preview-viewer img.zoomed {
            max-width: none;
            max-height: none;
            cursor: zoom-out;
        }
        
        /* Unsupported File */
        .doc-preview-unsupported {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }
        .doc-preview-unsupported svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        .doc-preview-unsupported h4 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        .doc-preview-unsupported .download-btn {
            margin-top: 1rem;
            padding: 0.75rem 1.5rem;
            background: var(--gold-primary);
            color: var(--bg-deep);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }
        .doc-preview-unsupported .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 168, 83, 0.3);
        }
        
        /* Annotations Panel */
        .doc-preview-annotations {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        .annotation-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        .annotation-header h4 {
            font-size: 0.9rem;
            color: var(--text-primary);
        }
        .annotation-add-btn {
            padding: 0.4rem 0.75rem;
            background: var(--gold-primary);
            color: var(--bg-deep);
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            transition: all 0.2s ease;
        }
        .annotation-add-btn:hover {
            transform: translateY(-1px);
        }
        .annotation-add-btn svg {
            width: 12px;
            height: 12px;
        }
        .annotation-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .annotation-item {
            background: var(--bg-deep);
            border-radius: 8px;
            padding: 0.75rem;
            border-left: 3px solid var(--gold-primary);
        }
        .annotation-item.partner {
            border-left-color: var(--info);
        }
        .annotation-item-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        .annotation-author {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gold-primary);
        }
        .annotation-item.partner .annotation-author {
            color: var(--info);
        }
        .annotation-time {
            font-size: 0.65rem;
            color: var(--text-muted);
        }
        .annotation-text {
            font-size: 0.85rem;
            color: var(--text-primary);
            line-height: 1.5;
        }
        .annotation-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .annotation-action-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 0.7rem;
            cursor: pointer;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        .annotation-action-btn:hover {
            color: var(--gold-primary);
            background: rgba(212, 168, 83, 0.1);
        }
        .annotation-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }
        .annotation-empty svg {
            width: 48px;
            height: 48px;
            margin-bottom: 0.75rem;
            opacity: 0.3;
        }
        
        /* Add Annotation Form */
        .annotation-form {
            background: var(--bg-deep);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 1rem;
            display: none;
        }
        .annotation-form.active {
            display: block;
        }
        .annotation-form textarea {
            width: 100%;
            min-height: 80px;
            padding: 0.75rem;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
            resize: vertical;
            margin-bottom: 0.5rem;
        }
        .annotation-form textarea:focus {
            outline: none;
            border-color: var(--gold-primary);
        }
        .annotation-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        .annotation-form-btn {
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .annotation-form-btn.cancel {
            background: transparent;
            border: 1px solid var(--border-subtle);
            color: var(--text-muted);
        }
        .annotation-form-btn.save {
            background: var(--gold-primary);
            border: none;
            color: var(--bg-deep);
        }
        
        /* File Info Panel */
        .doc-preview-info {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        .file-info-section {
            margin-bottom: 1.5rem;
        }
        .file-info-section h4 {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-subtle);
        }
        .file-info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 0.85rem;
        }
        .file-info-label {
            color: var(--text-muted);
        }
        .file-info-value {
            color: var(--text-primary);
            font-weight: 500;
        }
        .file-info-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 1rem;
            background: var(--bg-deep);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .file-info-icon svg {
            width: 40px;
            height: 40px;
        }
        .file-info-icon.pdf { color: #E74C3C; }
        .file-info-icon.doc { color: #2B579A; }
        .file-info-icon.xls { color: #217346; }
        .file-info-icon.ppt { color: #D24726; }
        .file-info-icon.image { color: #9B59B6; }
        
        /* Preview Footer */
        .doc-preview-footer {
            padding: 0.75rem 1rem;
            background: var(--bg-deep);
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .doc-preview-nav {
            display: flex;
            gap: 0.5rem;
        }
        .doc-preview-nav-btn {
            padding: 0.4rem 0.75rem;
            background: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-muted);
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            transition: all 0.2s ease;
        }
        .doc-preview-nav-btn:hover:not(:disabled) {
            border-color: var(--gold-primary);
            color: var(--gold-primary);
        }
        .doc-preview-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .doc-preview-nav-btn svg {
            width: 14px;
            height: 14px;
        }
        .doc-preview-download-btn {
            padding: 0.5rem 1rem;
            background: var(--gold-primary);
            color: var(--bg-deep);
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            transition: all 0.2s ease;
        }
        .doc-preview-download-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(212, 168, 83, 0.3);
        }
        .doc-preview-download-btn svg {
            width: 16px;
            height: 16px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .detail-panel.has-preview .detail-main { width: 45%; }
            .doc-preview-panel { width: 55%; }
        }
        @media (max-width: 900px) {
            .detail-panel.has-preview .detail-main { display: none; }
            .doc-preview-panel { width: 100%; }
        }
        .file-preview-modal-actions { display: flex; align-items: center; gap: 0.75rem; }
        .file-preview-modal-download { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--gold); color: var(--bg-dark); border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s ease; }
        .file-preview-modal-download:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3); }
        .file-preview-modal-download svg { width: 16px; height: 16px; }
        .file-preview-modal-close { width: 36px; height: 36px; background: transparent; border: 1px solid var(--border-subtle); border-radius: 6px; color: var(--text-muted); font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .file-preview-modal-close:hover { border-color: #e74c3c; color: #e74c3c; }
        .file-preview-modal-body { flex: 1; overflow: auto; display: flex; align-items: center; justify-content: center; background: #1a1a1a; }
        .file-preview-modal-body iframe { border: none; background: white; }
        .file-preview-modal-body img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .file-preview-unsupported { text-align: center; color: var(--text-muted); padding: 3rem; }
        .file-preview-unsupported svg { margin-bottom: 1rem; opacity: 0.5; }
        .file-preview-unsupported button { margin-top: 1rem; padding: 0.75rem 1.5rem; background: var(--gold); color: var(--bg-dark); border: none; border-radius: 6px; cursor: pointer; font-weight: 500; }

        /* Files Tab */
        .files-container { padding: 1.5rem; overflow-y: auto; height: 100%; }
        .files-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; }
        .files-header h3 { font-size: 1.1rem; color: var(--text-light); font-weight: 600; }
        .files-download-all { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: transparent; border: 1px solid var(--border-subtle); color: var(--text-muted); border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s ease; }
        .files-download-all:hover { border-color: var(--gold); color: var(--gold); }
        .files-download-all svg { width: 16px; height: 16px; }
        .files-section { margin-bottom: 2rem; }
        .files-section-title { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-subtle); }
        .files-section-title svg { width: 18px; height: 18px; }
        .files-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); text-align: center; padding: 3rem; }
        .files-empty svg { opacity: 0.3; margin-bottom: 1rem; }
        .files-empty h3 { color: var(--text-light); margin-bottom: 0.5rem; }

        /* Files Grid (Images) */
        .files-grid.images { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
        .file-card.image-card { background: var(--bg-deep); border-radius: 8px; overflow: hidden; cursor: pointer; transition: all 0.2s ease; border: 1px solid var(--border-subtle); }
        .file-card.image-card:hover { border-color: var(--gold); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
        .file-card-preview { aspect-ratio: 1; overflow: hidden; background: #0a0a0a; }
        .file-card-preview img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease; }
        .file-card.image-card:hover .file-card-preview img { transform: scale(1.05); }
        .file-card-info { padding: 0.75rem; }
        .file-card-name { font-size: 0.8rem; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 0.25rem; }
        .file-card-meta { display: flex; flex-wrap: wrap; gap: 0.5rem; font-size: 0.7rem; color: var(--text-muted); }
        .file-card-sender { padding: 0.15rem 0.4rem; border-radius: 3px; background: var(--bg-card); }
        .file-card-sender.luminary { background: rgba(212, 175, 55, 0.2); color: var(--gold); }
        .file-card-sender.partner { background: rgba(52, 152, 219, 0.2); color: #3498db; }
        .file-card-actions { position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0; transition: opacity 0.2s ease; }
        .file-card:hover .file-card-actions { opacity: 1; }
        .file-card-actions button { width: 32px; height: 32px; background: rgba(0,0,0,0.7); border: none; border-radius: 6px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .file-card-actions button:hover { background: var(--gold); color: var(--bg-dark); }
        .file-card-actions button svg { width: 16px; height: 16px; }
        .file-card.image-card { position: relative; }

        /* Files List (Documents) */
        .files-list { display: flex; flex-direction: column; gap: 0.5rem; }
        .file-card.document-card { display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--bg-deep); border-radius: 8px; border: 1px solid var(--border-subtle); transition: all 0.2s ease; cursor: pointer; }
        .file-card.document-card:hover { border-color: var(--gold-primary); background: rgba(212, 168, 83, 0.08); transform: translateX(4px); }
        .file-card-icon { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: var(--bg-card); border-radius: 8px; flex-shrink: 0; }
        .file-card-icon svg { width: 28px; height: 28px; }
        .file-card-icon.pdf { background: rgba(231, 76, 60, 0.1); }
        .file-card-icon.doc, .file-card-icon.docx { background: rgba(43, 87, 154, 0.1); }
        .file-card-icon.xls, .file-card-icon.xlsx, .file-card-icon.csv { background: rgba(33, 115, 70, 0.1); }
        .file-card-icon.ppt, .file-card-icon.pptx { background: rgba(210, 71, 38, 0.1); }
        .file-card.document-card .file-card-info { flex: 1; min-width: 0; }
        .file-card.document-card .file-card-name { font-size: 0.9rem; margin-bottom: 0.35rem; }
        .file-card.document-card .file-card-meta { align-items: center; }
        .file-card-size { color: var(--text-muted); }
        .file-card-context { font-size: 0.75rem; color: var(--text-muted); font-style: italic; margin-top: 0.35rem; opacity: 0.8; }
        .file-card.document-card .file-card-actions { display: flex; gap: 0.5rem; opacity: 1; position: static; }
        .file-card.document-card .file-card-actions button { width: 36px; height: 36px; background: transparent; border: 1px solid var(--border-subtle); border-radius: 6px; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
        .file-card.document-card .file-card-actions button:hover { border-color: var(--gold); color: var(--gold); background: rgba(212, 175, 55, 0.1); }
        .file-card.document-card .file-card-actions button svg { width: 18px; height: 18px; }

        /* Image Lightbox */
        .image-lightbox { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .image-lightbox.active { opacity: 1; visibility: visible; }
        .image-lightbox img { max-width: 90vw; max-height: 90vh; object-fit: contain; border-radius: 8px; }
        .image-lightbox-close { position: absolute; top: 20px; right: 20px; width: 40px; height: 40px; background: rgba(255,255,255,0.1); border: none; border-radius: 50%; color: white; font-size: 24px; cursor: pointer; }

        /* ===== RESEARCH HUB ===== */
        .research-hub {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-deep);
            z-index: 10000;
            display: flex;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .research-hub.active {
            opacity: 1;
            visibility: visible;
        }
        .research-sidebar {
            width: 300px;
            background: var(--bg-card);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
        }
        .research-sidebar-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border-subtle);
            background: linear-gradient(135deg, var(--bg-deep) 0%, var(--bg-card) 100%);
        }
        .research-sidebar-header h2 {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            color: var(--gold-primary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .research-partner-name {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        .research-progress {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .research-progress-bar {
            flex: 1;
            height: 4px;
            background: var(--bg-deep);
            border-radius: 2px;
            overflow: hidden;
        }
        .research-progress-fill {
            height: 100%;
            background: var(--gold-primary);
            transition: width 0.3s ease;
        }
        .research-categories {
            flex: 1;
            overflow-y: auto;
            padding: 0.75rem;
        }
        .research-cat {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.85rem;
            background: var(--bg-deep);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .research-cat:hover {
            border-color: var(--gold-primary);
            transform: translateX(3px);
        }
        .research-cat.active {
            border-color: var(--gold-primary);
            background: rgba(212, 168, 83, 0.1);
        }
        .research-cat.complete {
            border-left: 3px solid var(--success);
        }
        .research-cat-icon {
            font-size: 1.25rem;
        }
        .research-cat-info {
            flex: 1;
            min-width: 0;
        }
        .research-cat-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.85rem;
            margin-bottom: 0.15rem;
        }
        .research-cat-status {
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        .research-cat.complete .research-cat-status {
            color: var(--success);
        }
        .research-cat-check {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: transparent;
        }
        .research-cat.complete .research-cat-check {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }
        .research-sidebar-footer {
            padding: 1rem;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .research-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-deep);
        }
        .research-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-subtle);
        }
        .research-toolbar-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .research-toolbar-actions {
            display: flex;
            gap: 0.5rem;
        }
        .research-content {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }
        .research-field {
            margin-bottom: 1.25rem;
        }
        .research-field-label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }
        .research-field-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: inherit;
            resize: vertical;
        }
        .research-field-input:focus {
            outline: none;
            border-color: var(--gold-primary);
        }
        .research-results {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            overflow: hidden;
        }
        .research-results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-subtle);
        }
        .research-results-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .research-results-meta {
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        .research-results-content {
            padding: 1rem;
            font-size: 0.9rem;
            line-height: 1.7;
            color: var(--text-secondary);
            min-height: 200px;
            max-height: 350px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .research-results-placeholder {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }
        .research-results-placeholder svg {
            width: 48px;
            height: 48px;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        .research-notes {
            margin-top: 1rem;
        }
        .research-notes-input {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-deep);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
            min-height: 100px;
            resize: vertical;
        }
        .research-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 40px;
            height: 40px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .research-close:hover {
            border-color: var(--error);
            color: var(--error);
        }

        /* ===== DOCUMENT REVIEW WITH SIDENOTES ===== */
        .doc-review {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-deep);
            z-index: 10000;
            display: flex;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .doc-review.active {
            opacity: 1;
            visibility: visible;
        }
        .doc-review-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #e5e5e5;
        }
        .doc-review-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1.5rem;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-subtle);
        }
        .doc-review-title {
            font-family: 'Cinzel', serif;
            color: var(--gold-primary);
            font-size: 1rem;
        }
        .doc-review-subtitle {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        .doc-status {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .doc-status-badge {
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .doc-status-badge.draft { background: var(--warning-bg); color: var(--warning); }
        .doc-status-badge.pending { background: var(--info-bg); color: var(--info); }
        .doc-status-badge.signed { background: var(--success-bg); color: var(--success); }
        .doc-review-content {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            justify-content: center;
        }
        .doc-wrapper {
            width: 100%;
            max-width: 850px;
        }
        .doc-paper {
            background: white;
            color: #1a1a1a;
            padding: 3rem;
            border-radius: 4px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            font-family: 'Georgia', serif;
            line-height: 1.8;
        }
        .doc-paper h1 {
            font-family: 'Cinzel', serif;
            color: #1a1a1a;
            border-bottom: 2px solid #D4A853;
            padding-bottom: 0.75rem;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }
        .doc-paper h2 {
            font-family: 'Cinzel', serif;
            color: #333;
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }
        .doc-paper table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
        }
        .doc-paper th, .doc-paper td {
            border: 1px solid #ddd;
            padding: 0.75rem;
            text-align: left;
        }
        .doc-paper th {
            background: #f5f5f5;
            font-weight: 600;
        }
        .doc-logo {
            text-align: center;
            margin-bottom: 2rem;
        }
        .doc-logo-text {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            color: #D4A853;
            letter-spacing: 0.2em;
        }
        .doc-logo-sub {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.25rem;
        }

        /* Payment Pathway Box */
        .payment-pathway {
            background: linear-gradient(135deg, #f8f6f0 0%, #f5f5f5 100%);
            border: 1px solid #e0d9c8;
            border-left: 4px solid #D4A853;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }
        .payment-pathway h3 {
            font-family: 'Cinzel', serif;
            color: #D4A853;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        .pathway-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #eee;
        }
        .pathway-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .pathway-num {
            width: 24px;
            height: 24px;
            background: #D4A853;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            flex-shrink: 0;
        }
        .pathway-text {
            font-size: 0.9rem;
            color: #333;
            line-height: 1.5;
        }

        /* Sidenotes Panel */
        .sidenotes-panel {
            width: 380px;
            background: var(--bg-card);
            border-left: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
        }
        .sidenotes-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .sidenotes-header h3 {
            font-size: 0.9rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .sidenotes-count {
            background: var(--gold-primary);
            color: var(--bg-deep);
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .sidenotes-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.75rem;
        }
        .sidenote {
            background: var(--bg-deep);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .sidenote.from-partner {
            border-left: 3px solid var(--info);
        }
        .sidenote.from-luminary {
            border-left: 3px solid var(--gold-primary);
        }
        .sidenote-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        .sidenote-author {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .sidenote-time {
            font-size: 0.65rem;
            color: var(--text-muted);
        }
        .sidenote-content {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        .sidenote-section {
            font-size: 0.7rem;
            color: var(--gold-primary);
            margin-top: 0.5rem;
            font-style: italic;
        }
        .sidenotes-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            font-size: 0.85rem;
        }
        .sidenotes-compose {
            padding: 1rem;
            border-top: 1px solid var(--border-subtle);
        }
        .sidenotes-compose textarea {
            width: 100%;
            padding: 0.65rem;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
            resize: none;
            min-height: 70px;
            margin-bottom: 0.5rem;
            font-family: inherit;
        }
        .sidenotes-compose textarea:focus {
            outline: none;
            border-color: var(--gold-primary);
        }
        .sidenotes-compose-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .sidenotes-section-select {
            padding: 0.4rem 0.6rem;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        /* ===== SIGNATURE CAPTURE ===== */
        .sig-section {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 2px solid #D4A853;
        }
        .sig-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3rem;
            margin-top: 1.5rem;
        }
        .sig-party {
            text-align: center;
        }
        .sig-party-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 1.5rem;
            font-size: 1rem;
        }
        .sig-canvas-wrap {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 0.75rem;
            background: #fafafa;
            margin-bottom: 0.5rem;
        }
        .sig-canvas-wrap.signed {
            border-style: solid;
            border-color: #4ade80;
            background: #f0fdf4;
        }
        .sig-canvas {
            width: 100%;
            height: 100px;
            background: white;
            border-radius: 4px;
            cursor: crosshair;
            display: block;
        }
        .sig-canvas.disabled {
            cursor: default;
            opacity: 0.7;
        }
        .sig-actions {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .sig-actions button {
            padding: 0.35rem 0.65rem;
            font-size: 0.7rem;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #ddd;
            background: white;
            color: #333;
            font-family: inherit;
        }
        .sig-actions button:hover {
            border-color: #D4A853;
            color: #D4A853;
        }
        .sig-actions button.sign-btn {
            background: #D4A853;
            border-color: #D4A853;
            color: white;
        }
        .sig-actions button.sign-btn:hover {
            background: #c49843;
        }
        .sig-info input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
            text-align: center;
            font-family: inherit;
        }
        .sig-info input:focus {
            outline: none;
            border-color: #D4A853;
        }
        .sig-date {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.5rem;
        }
        .sig-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .sig-status.pending { color: #fbbf24; }
        .sig-status.signed { color: #4ade80; }

        /* ===== RESEARCH HUB ===== */
        .research-hub {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-deep);
            z-index: 10000;
            display: flex;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .research-hub.active {
            opacity: 1;
            visibility: visible;
        }
        .research-hub-sidebar {
            width: 300px;
            background: var(--bg-card);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
        }
        .research-hub-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border-subtle);
        }
        .research-hub-header h2 {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            color: var(--gold-primary);
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .research-hub-partner {
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        .research-hub-partner-type {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .research-progress {
            margin-top: 1rem;
            padding: 0.75rem;
            background: var(--bg-deep);
            border-radius: 8px;
        }
        .research-progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }
        .research-progress-bar {
            height: 6px;
            background: var(--bg-elevated);
            border-radius: 3px;
            overflow: hidden;
        }
        .research-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold-primary), var(--gold-light));
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        .research-categories {
            flex: 1;
            overflow-y: auto;
            padding: 0.75rem;
        }
        .research-category {
            padding: 0.85rem;
            background: var(--bg-deep);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        .research-category:hover {
            border-color: var(--gold-primary);
        }
        .research-category.active {
            border-color: var(--gold-primary);
            background: rgba(212, 168, 83, 0.1);
        }
        .research-category.has-data {
            border-left: 3px solid var(--success);
        }
        .research-category.has-data::after {
            content: '';
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 18px;
            height: 18px;
            background: var(--success);
            color: white;
            border-radius: 50%;
            font-size: 0.65rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .research-category-icon {
            font-size: 1.25rem;
            margin-bottom: 0.35rem;
        }
        .research-category-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.85rem;
            margin-bottom: 0.2rem;
        }
        .research-category-desc {
            font-size: 0.7rem;
            color: var(--text-muted);
            line-height: 1.4;
        }
        .research-hub-footer {
            padding: 0.75rem;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .research-hub-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-deep);
        }
        .research-hub-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-subtle);
        }
        .research-toolbar-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .research-toolbar-title h3 {
            font-size: 1.1rem;
            color: var(--text-primary);
            margin: 0;
        }
        .research-toolbar-title .category-icon {
            font-size: 1.5rem;
        }
        .research-hub-actions {
            display: flex;
            gap: 0.5rem;
        }
        .research-hub-content {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }
        .research-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            text-align: center;
        }
        .research-empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        .research-empty-state h3 {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        .research-query-section {
            margin-bottom: 1.5rem;
        }
        .research-query-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        .research-query-label label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .research-query-label button {
            font-size: 0.7rem;
            color: var(--gold-primary);
            background: none;
            border: none;
            cursor: pointer;
        }
        .research-query-label button:hover {
            text-decoration: underline;
        }
        .research-query-input {
            width: 100%;
            padding: 0.85rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: inherit;
            resize: vertical;
            min-height: 90px;
            line-height: 1.5;
        }
        .research-query-input:focus {
            outline: none;
            border-color: var(--gold-primary);
        }
        .research-results-section {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }
        .research-results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-subtle);
        }
        .research-results-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .research-results-meta {
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        .research-results-content {
            padding: 1.25rem;
            font-size: 0.9rem;
            line-height: 1.7;
            color: var(--text-secondary);
            max-height: 350px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .research-results-placeholder {
            text-align: center;
            padding: 2.5rem;
            color: var(--text-muted);
        }
        .research-results-placeholder svg {
            width: 40px;
            height: 40px;
            margin-bottom: 0.75rem;
            opacity: 0.4;
        }
        .research-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2.5rem;
        }
        .research-notes-section {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            overflow: hidden;
        }
        .research-notes-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-subtle);
        }
        .research-notes-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .research-notes-content {
            padding: 1rem;
        }
        .research-notes-input {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-deep);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
            font-family: inherit;
            min-height: 100px;
            resize: vertical;
            line-height: 1.5;
        }
        .research-notes-input:focus {
            outline: none;
            border-color: var(--gold-primary);
        }
        .research-hub-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 40px;
            height: 40px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .research-hub-close:hover {
            border-color: var(--error);
            color: var(--error);
        }
        .research-save-indicator {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 0.75rem 1.25rem;
            background: var(--success);
            color: white;
            border-radius: 8px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            z-index: 10001;
        }
        .research-save-indicator.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* ===== PROPOSAL WIZARD ===== */
        .proposal-wizard {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .proposal-wizard.active {
            opacity: 1;
            visibility: visible;
        }
        .proposal-wizard-content {
            width: 95vw;
            max-width: 1100px;
            height: 90vh;
            background: var(--bg-card);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-subtle);
        }
        
        /* Research Summary Grid */
        .research-summary-header {
            margin-bottom: 1.5rem;
        }
        .research-summary-header h3 {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        .research-summary-header p {
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        .research-summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        .research-summary-card {
            background: var(--bg-deep);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 1rem;
            transition: all 0.2s ease;
        }
        .research-summary-card.has-data {
            border-left: 3px solid var(--success);
        }
        .research-summary-card.no-data {
            border-left: 3px solid var(--warning);
            opacity: 0.7;
        }
        .research-summary-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        .research-summary-card-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        .research-summary-card-title .icon {
            font-size: 1.1rem;
        }
        .research-summary-card-status {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
        }
        .research-summary-card-status.complete {
            background: var(--success-bg);
            color: var(--success);
        }
        .research-summary-card-status.missing {
            background: var(--warning-bg);
            color: var(--warning);
        }
        .research-summary-card-preview {
            font-size: 0.8rem;
            color: var(--text-muted);
            line-height: 1.5;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .research-summary-actions {
            margin-top: 1.5rem;
            padding: 1rem;
            background: var(--warning-bg);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .research-summary-actions p {
            color: var(--warning);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Rationale Section */
        .rationale-section {
            background: var(--bg-deep);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }
        .rationale-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }
        .rationale-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--gold-primary);
            font-size: 1rem;
        }
        .rationale-description {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-bottom: 1rem;
            line-height: 1.5;
        }
        .rationale-input {
            width: 100%;
            min-height: 200px;
            padding: 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: inherit;
            line-height: 1.6;
            resize: vertical;
        }
        .rationale-input:focus {
            outline: none;
            border-color: var(--gold-primary);
        }
        .rationale-input::placeholder {
            color: var(--text-muted);
            opacity: 0.7;
        }
        
        /* Proposal Preview */
        .proposal-preview-wrapper {
            display: flex;
            gap: 1.5rem;
            height: 100%;
        }
        .proposal-preview-document {
            flex: 1;
            background: white;
            border-radius: 8px;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .proposal-preview-actions {
            width: 280px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .proposal-action-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 1.25rem;
        }
        .proposal-action-card h4 {
            font-size: 0.85rem;
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .proposal-action-btn {
            width: 100%;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            background: var(--bg-deep);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }
        .proposal-action-btn:hover {
            border-color: var(--gold-primary);
            color: var(--gold-primary);
        }
        .proposal-action-btn.primary {
            background: var(--gold-primary);
            border-color: var(--gold-primary);
            color: var(--bg-deep);
        }
        .proposal-action-btn.primary:hover {
            background: var(--gold-light);
        }
        .proposal-action-btn:last-child {
            margin-bottom: 0;
        }
        .proposal-action-btn svg {
            width: 16px;
            height: 16px;
        }
        
        /* ===== DOCUMENT REVIEW WITH SIDENOTES ===== */
        .doc-review {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-deep);
            z-index: 10000;
            display: flex;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .doc-review.active {
            opacity: 1;
            visibility: visible;
        }
        .doc-review-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #e5e5e5;
        }
        .doc-review-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1.5rem;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-subtle);
        }
        .doc-review-toolbar-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .doc-review-title {
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            color: var(--gold-primary);
        }
        .doc-review-partner {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .doc-review-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .doc-status-badge {
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }
        .doc-status-badge.draft {
            background: var(--warning-bg);
            color: var(--warning);
        }
        .doc-status-badge.review {
            background: var(--info-bg);
            color: var(--info);
        }
        .doc-status-badge.pending-signature {
            background: rgba(168, 85, 247, 0.15);
            color: #a855f7;
        }
        .doc-status-badge.executed {
            background: var(--success-bg);
            color: var(--success);
        }
        .doc-review-toolbar-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .doc-review-content {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            justify-content: center;
        }
        .doc-review-wrapper {
            width: 100%;
            max-width: 850px;
        }
        .doc-review-document {
            background: white;
            color: #1a1a1a;
            padding: 3rem;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            font-family: 'Georgia', serif;
            line-height: 1.8;
            font-size: 1rem;
        }
        .doc-review-document h1 {
            font-family: 'Cinzel', serif;
            color: #1a1a1a;
            border-bottom: 2px solid #D4A853;
            padding-bottom: 0.75rem;
            margin-bottom: 1.5rem;
            font-size: 1.75rem;
        }
        .doc-review-document h2 {
            font-family: 'Cinzel', serif;
            color: #333;
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-size: 1.25rem;
            position: relative;
            cursor: pointer;
        }
        .doc-review-document h2:hover {
            color: #D4A853;
        }
        .doc-review-document h2::after {
            content: '+';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            background: #f5f5f5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: #999;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .doc-review-document h2:hover::after {
            opacity: 1;
        }
        .doc-review-document h3 {
            color: #444;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
        }
        .doc-review-document p {
            margin-bottom: 1rem;
        }
        .doc-review-document ul, .doc-review-document ol {
            margin-bottom: 1rem;
            padding-left: 1.5rem;
        }
        .doc-review-document li {
            margin-bottom: 0.5rem;
        }
        .doc-review-document table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
        }
        .doc-review-document th, .doc-review-document td {
            border: 1px solid #ddd;
            padding: 0.75rem;
            text-align: left;
        }
        .doc-review-document th {
            background: #f8f8f8;
            font-weight: 600;
        }
        .doc-section-highlight {
            background: rgba(212, 168, 83, 0.1);
            margin: -0.5rem;
            padding: 0.5rem;
            border-radius: 4px;
            border-left: 3px solid #D4A853;
        }
        
        /* Sidenotes Panel */
        .sidenotes-panel {
            width: 380px;
            background: var(--bg-card);
            border-left: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
        }
        .sidenotes-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .sidenotes-header h3 {
            font-size: 0.95rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .sidenotes-count {
            background: var(--gold-primary);
            color: var(--bg-deep);
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .sidenotes-filter {
            display: flex;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-subtle);
        }
        .sidenotes-filter-btn {
            padding: 0.35rem 0.65rem;
            background: var(--bg-deep);
            border: 1px solid var(--border-subtle);
            border-radius: 15px;
            color: var(--text-muted);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .sidenotes-filter-btn:hover {
            border-color: var(--gold-primary);
            color: var(--gold-primary);
        }
        .sidenotes-filter-btn.active {
            background: var(--gold-primary);
            border-color: var(--gold-primary);
            color: var(--bg-deep);
        }
        .sidenotes-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.75rem;
        }
        .sidenote-item {
            background: var(--bg-deep);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 0.85rem;
            margin-bottom: 0.75rem;
            transition: all 0.2s ease;
        }
        .sidenote-item:hover {
            border-color: var(--border-strong);
        }
        .sidenote-item.from-partner {
            border-left: 3px solid var(--info);
        }
        .sidenote-item.from-luminary {
            border-left: 3px solid var(--gold-primary);
        }
        .sidenote-item.resolved {
            opacity: 0.6;
        }
        .sidenote-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        .sidenote-author {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .sidenote-author-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--gold-primary);
            color: var(--bg-deep);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 600;
        }
        .sidenote-author-avatar.partner {
            background: var(--info);
        }
        .sidenote-author-name {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .sidenote-time {
            font-size: 0.65rem;
            color: var(--text-muted);
        }
        .sidenote-section {
            font-size: 0.7rem;
            color: var(--gold-primary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }
        .sidenote-content {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        .sidenote-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-subtle);
        }
        .sidenote-action-btn {
            padding: 0.3rem 0.5rem;
            background: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            color: var(--text-muted);
            font-size: 0.7rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            transition: all 0.2s ease;
        }
        .sidenote-action-btn:hover {
            border-color: var(--gold-primary);
            color: var(--gold-primary);
        }
        .sidenote-action-btn.resolve:hover {
            border-color: var(--success);
            color: var(--success);
        }
        .sidenotes-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }
        .sidenotes-empty svg {
            width: 40px;
            height: 40px;
            margin-bottom: 0.75rem;
            opacity: 0.4;
        }
        .sidenotes-compose {
            padding: 1rem;
            border-top: 1px solid var(--border-subtle);
            background: var(--bg-elevated);
        }
        .sidenotes-compose-section {
            margin-bottom: 0.75rem;
        }
        .sidenotes-compose-section label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: block;
            margin-bottom: 0.35rem;
        }
        .sidenotes-compose-section select {
            width: 100%;
            padding: 0.5rem;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.8rem;
        }
        .sidenotes-compose textarea {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.85rem;
            resize: none;
            min-height: 80px;
            font-family: inherit;
            line-height: 1.5;
        }
        .sidenotes-compose textarea:focus {
            outline: none;
            border-color: var(--gold-primary);
        }
        .sidenotes-compose-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 0.75rem;
        }
        
        /* ===== ELECTRONIC SIGNATURES ===== */
        .signature-section {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 2px solid #D4A853;
        }
        .signature-section-title {
            font-family: 'Cinzel', serif;
            font-size: 1.25rem;
            color: #333;
            margin-bottom: 0.5rem;
        }
        .signature-section-desc {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 1.5rem;
        }
        .signature-blocks {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2.5rem;
        }
        .signature-block {
            text-align: center;
        }
        .signature-block-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 1rem;
            font-size: 1rem;
        }
        .signature-canvas-container {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 0.75rem;
            background: #fafafa;
            margin-bottom: 0.75rem;
            transition: all 0.2s ease;
        }
        .signature-canvas-container:hover {
            border-color: #D4A853;
        }
        .signature-canvas-container.signed {
            border-style: solid;
            border-color: #4ade80;
            background: rgba(74, 222, 128, 0.05);
        }
        .signature-canvas-container.signing {
            border-color: #D4A853;
            background: white;
        }
        .signature-canvas {
            width: 100%;
            height: 100px;
            background: white;
            border-radius: 4px;
            cursor: crosshair;
            touch-action: none;
        }
        .signature-canvas.disabled {
            cursor: default;
            opacity: 0.7;
        }
        .signature-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100px;
            color: #999;
            font-size: 0.85rem;
        }
        .signature-placeholder svg {
            width: 32px;
            height: 32px;
            margin-bottom: 0.5rem;
            opacity: 0.4;
        }
        .signature-actions {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .signature-action-btn {
            padding: 0.4rem 0.75rem;
            font-size: 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #ddd;
            background: white;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.35rem;
            transition: all 0.2s ease;
        }
        .signature-action-btn:hover {
            border-color: #D4A853;
            color: #D4A853;
        }
        .signature-action-btn.sign {
            background: #D4A853;
            border-color: #D4A853;
            color: white;
        }
        .signature-action-btn.sign:hover {
            background: #c49643;
        }
        .signature-action-btn svg {
            width: 12px;
            height: 12px;
        }
        .signature-info {
            margin-top: 0.75rem;
        }
        .signature-info-row {
            margin-bottom: 0.5rem;
        }
        .signature-info-row label {
            display: block;
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 0.2rem;
            text-align: left;
        }
        .signature-info-row input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
            text-align: center;
        }
        .signature-info-row input:focus {
            outline: none;
            border-color: #D4A853;
        }
        .signature-info-row input:disabled {
            background: #f5f5f5;
            color: #666;
        }
        .signature-date {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.75rem;
        }
        .signature-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .signature-status.pending {
            background: rgba(251, 191, 36, 0.1);
            color: #d97706;
        }
        .signature-status.signed {
            background: rgba(74, 222, 128, 0.1);
            color: #16a34a;
        }
        .signature-status svg {
            width: 14px;
            height: 14px;
        }
        
        /* Signature Modal for full-screen signing */
        .signature-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .signature-modal.active {
            opacity: 1;
            visibility: visible;
        }
        .signature-modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            width: 90vw;
            max-width: 600px;
            text-align: center;
        }
        .signature-modal-title {
            font-family: 'Cinzel', serif;
            font-size: 1.25rem;
            color: #333;
            margin-bottom: 0.5rem;
        }
        .signature-modal-desc {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }
        .signature-modal-canvas-container {
            border: 2px solid #D4A853;
            border-radius: 8px;
            padding: 0.5rem;
            background: #fafafa;
            margin-bottom: 1rem;
        }
        .signature-modal-canvas {
            width: 100%;
            height: 150px;
            background: white;
            border-radius: 4px;
            cursor: crosshair;
            touch-action: none;
        }
        .signature-modal-hint {
            font-size: 0.75rem;
            color: #999;
            margin-bottom: 1.5rem;
        }
        .signature-modal-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        .signature-modal-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }
        .signature-modal-btn.cancel {
            background: white;
            border: 1px solid #ddd;
            color: #666;
        }
        .signature-modal-btn.cancel:hover {
            border-color: #999;
        }
        .signature-modal-btn.clear {
            background: white;
            border: 1px solid #ddd;
            color: #666;
        }
        .signature-modal-btn.apply {
            background: #D4A853;
            border: 1px solid #D4A853;
            color: white;
        }
        .signature-modal-btn.apply:hover {
            background: #c49643;
        }
        .signature-modal-btn svg {
            width: 16px;
            height: 16px;
        }
        
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .proposal-wizard-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, var(--bg-deep) 0%, var(--bg-card) 100%);
            border-bottom: 1px solid var(--border-subtle);
        }
        .proposal-wizard-header h2 {
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
            color: var(--gold-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .proposal-wizard-steps {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .wizard-step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.75rem;
            background: var(--bg-deep);
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--text-muted);
            transition: all 0.2s ease;
        }
        .wizard-step.active {
            background: var(--gold-primary);
            color: var(--bg-deep);
        }
        .wizard-step.completed {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }
        .wizard-step-num {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.7rem;
        }
        .wizard-step.active .wizard-step-num {
            background: rgba(0,0,0,0.2);
        }
        .proposal-wizard-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }
        .proposal-wizard-footer {
            display: flex;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            background: var(--bg-deep);
            border-top: 1px solid var(--border-subtle);
        }
        
        /* Research Prompts Section */
        .research-prompts {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .research-prompt-item {
            background: var(--bg-deep);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 1rem;
            transition: all 0.2s ease;
        }
        .research-prompt-item.completed {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.05);
        }
        .research-prompt-item.loading {
            border-color: var(--gold-primary);
            background: rgba(212, 168, 83, 0.05);
        }
        .research-prompt-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }
        .research-prompt-title {
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .research-prompt-title svg {
            width: 16px;
            height: 16px;
            color: var(--gold-primary);
        }
        .research-prompt-actions {
            display: flex;
            gap: 0.5rem;
        }
        .research-prompt-actions button {
            padding: 0.35rem 0.6rem;
            background: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            color: var(--text-muted);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .research-prompt-actions button:hover {
            border-color: var(--gold-primary);
            color: var(--gold-primary);
        }
        .research-prompt-input {
            width: 100%;
            padding: 0.6rem 0.75rem;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
            font-family: inherit;
            margin-bottom: 0.5rem;
        }
        .research-prompt-input:focus {
            outline: none;
            border-color: var(--gold-primary);
        }
        .research-result {
            background: var(--bg-card);
            border-radius: 6px;
            padding: 0.75rem;
            font-size: 0.85rem;
            line-height: 1.6;
            color: var(--text-secondary);
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .research-result-placeholder {
            color: var(--text-muted);
            font-style: italic;
            text-align: center;
            padding: 1rem;
        }
        .add-prompt-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: transparent;
            border: 2px dashed var(--border-subtle);
            border-radius: 10px;
            color: var(--text-muted);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .add-prompt-btn:hover {
            border-color: var(--gold-primary);
            color: var(--gold-primary);
        }
        
        /* Proposal Config Section */
        .proposal-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        .config-section {
            background: var(--bg-deep);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 1.25rem;
        }
        .config-section-title {
            font-weight: 600;
            color: var(--gold-primary);
            margin-bottom: 1rem;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .config-field {
            margin-bottom: 1rem;
        }
        .config-field:last-child {
            margin-bottom: 0;
        }
        .config-field label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.4rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .config-field input,
        .config-field select,
        .config-field textarea {
            width: 100%;
            padding: 0.6rem 0.75rem;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: inherit;
        }
        .config-field textarea {
            min-height: 100px;
            resize: vertical;
        }
        .config-field input:focus,
        .config-field select:focus,
        .config-field textarea:focus {
            outline: none;
            border-color: var(--gold-primary);
        }
        .tier-options {
            display: flex;
            gap: 0.75rem;
        }
        .tier-option {
            flex: 1;
            padding: 0.75rem;
            background: var(--bg-card);
            border: 2px solid var(--border-subtle);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .tier-option:hover {
            border-color: var(--gold-primary);
        }
        .tier-option.selected {
            border-color: var(--gold-primary);
            background: rgba(212, 168, 83, 0.1);
        }
        .tier-option-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        .tier-option-price {
            font-size: 0.8rem;
            color: var(--gold-primary);
        }
        
        /* Proposal Preview */
        .proposal-preview {
            background: white;
            color: #1a1a1a;
            padding: 2rem;
            border-radius: 8px;
            max-height: 100%;
            overflow-y: auto;
            font-family: 'Georgia', serif;
            line-height: 1.7;
        }
        .proposal-preview h1 {
            font-family: 'Cinzel', serif;
            color: #1a1a1a;
            border-bottom: 2px solid #D4A853;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .proposal-preview h2 {
            font-family: 'Cinzel', serif;
            color: #333;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }
        .proposal-preview .proposal-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .proposal-preview .proposal-logo {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: #D4A853;
            letter-spacing: 0.2em;
        }
        .proposal-preview table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        .proposal-preview th,
        .proposal-preview td {
            border: 1px solid #ddd;
            padding: 0.75rem;
            text-align: left;
        }
        .proposal-preview th {
            background: #f5f5f5;
        }
        .proposal-preview .signature-block {
            margin-top: 3rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        .proposal-preview .signature-line {
            border-top: 1px solid #333;
            padding-top: 0.5rem;
            margin-top: 3rem;
        }
        .proposal-generating {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem;
            color: var(--text-muted);
        }
        .proposal-generating .press-sending-spinner {
            margin-bottom: 1rem;
        }
        
        /* ===== PRESS RELEASE MODAL ===== */
        
        /* Email Management in Details */
        .email-edit-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .email-input {
            flex: 1;
            padding: 0.5rem 0.75rem;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
            font-family: inherit;
        }
        .email-input:focus {
            outline: none;
            border-color: var(--gold-primary);
        }
        .email-save-btn {
            width: 36px;
            height: 36px;
            background: var(--gold-primary);
            border: none;
            border-radius: 6px;
            color: var(--bg-deep);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .email-save-btn:hover {
            transform: scale(1.05);
        }
        .email-save-btn svg {
            width: 18px;
            height: 18px;
        }
        .email-link {
            color: var(--gold-primary);
            font-size: 0.8rem;
            text-decoration: none;
        }
        .email-link:hover {
            text-decoration: underline;
        }
        .no-email-warning {
            color: var(--warning);
            font-size: 0.75rem;
            font-style: italic;
        }
        
        /* AI Drafting Card */
        .ai-drafting-card {
            background: linear-gradient(135deg, rgba(212, 168, 83, 0.05) 0%, var(--bg-card) 100%);
            border: 1px solid rgba(212, 168, 83, 0.2);
        }
        .ai-drafting-card .detail-card-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--gold-primary);
        }
        .ai-description {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }
        .ai-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }
        .ai-btn {
            padding: 0.6rem 0.75rem;
            background: var(--bg-deep);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-family: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            transition: all 0.2s ease;
        }
        .ai-btn:hover {
            border-color: var(--gold-primary);
            color: var(--gold-primary);
            background: rgba(212, 168, 83, 0.1);
        }
        .ai-btn.research {
            grid-column: span 2;
            background: rgba(96, 165, 250, 0.1);
            border-color: rgba(96, 165, 250, 0.3);
            color: var(--info);
        }
        .ai-btn.research:hover {
            border-color: var(--info);
            background: rgba(96, 165, 250, 0.2);
        }
        .ai-btn svg {
            width: 14px;
            height: 14px;
        }
        .ai-btn.loading {
            pointer-events: none;
            opacity: 0.7;
        }
        .ai-btn.loading::after {
            content: '';
            width: 14px;
            height: 14px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        /* AI Output */
        .ai-output {
            margin-top: 1rem;
            background: var(--bg-deep);
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            overflow: hidden;
        }
        .ai-output-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0.75rem;
            background: rgba(212, 168, 83, 0.1);
            border-bottom: 1px solid var(--border-subtle);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gold-primary);
        }
        .ai-output-actions {
            display: flex;
            gap: 0.25rem;
        }
        .ai-output-actions button {
            width: 28px;
            height: 28px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        .ai-output-actions button:hover {
            color: var(--gold-primary);
            background: rgba(212, 168, 83, 0.1);
        }
        .ai-output-actions button svg {
            width: 14px;
            height: 14px;
        }
        .ai-output-content {
            padding: 0.75rem;
            font-size: 0.85rem;
            line-height: 1.6;
            color: var(--text-primary);
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .ai-output-content h4 {
            color: var(--gold-primary);
            margin: 0.75rem 0 0.5rem;
            font-size: 0.9rem;
        }
        .ai-output-content h4:first-child {
            margin-top: 0;
        }
        .ai-output-content ul {
            margin: 0.5rem 0;
            padding-left: 1.25rem;
        }
        .ai-output-content li {
            margin-bottom: 0.25rem;
        }
        
        .press-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .press-modal.active {
            opacity: 1;
            visibility: visible;
        }
        .press-modal-content {
            width: 95vw;
            max-width: 1200px;
            height: 90vh;
            background: var(--bg-card);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-subtle);
        }
        .press-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem 1.5rem;
            background: linear-gradient(135deg, var(--bg-deep) 0%, var(--bg-card) 100%);
            border-bottom: 1px solid var(--border-subtle);
        }
        .press-modal-header h2 {
            font-family: 'Cinzel', serif;
            font-size: 1.3rem;
            color: var(--gold-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .press-modal-header h2 svg {
            width: 24px;
            height: 24px;
        }
        .press-modal-close {
            width: 40px;
            height: 40px;
            background: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .press-modal-close:hover {
            border-color: var(--error);
            color: var(--error);
            background: var(--error-bg);
        }
        .press-modal-close svg {
            width: 20px;
            height: 20px;
        }
        .press-modal-body {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 320px;
            overflow: hidden;
        }
        
        /* Compose Area */
        .press-compose {
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }
        .press-field {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .press-field label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .press-field input,
        .press-field textarea,
        .press-field select {
            padding: 0.875rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }
        .press-field input:focus,
        .press-field textarea:focus,
        .press-field select:focus {
            outline: none;
            border-color: var(--gold-primary);
            box-shadow: 0 0 0 3px rgba(212, 168, 83, 0.1);
        }
        .press-field textarea {
            min-height: 300px;
            resize: vertical;
            line-height: 1.6;
        }
        .press-field-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .press-tokens {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .press-token {
            padding: 0.35rem 0.65rem;
            background: var(--bg-deep);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--gold-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .press-token:hover {
            border-color: var(--gold-primary);
            background: rgba(212, 168, 83, 0.1);
        }
        
        /* Recipients Panel */
        .press-recipients {
            background: var(--bg-deep);
            border-left: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
        }
        .press-recipients-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border-subtle);
        }
        .press-recipients-header h3 {
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }
        .press-recipients-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
        }
        .press-recipients-stats span {
            color: var(--text-muted);
        }
        .press-recipients-stats strong {
            color: var(--gold-primary);
        }
        .press-recipients-filters {
            padding: 0.75rem 1.25rem;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .press-recipients-filters select {
            padding: 0.5rem 0.75rem;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
        }
        .press-recipients-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.75rem;
        }
        .press-recipient-item {
            padding: 0.65rem 0.75rem;
            background: var(--bg-card);
            border-radius: 6px;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .press-recipient-item:hover {
            background: var(--bg-elevated);
        }
        .press-recipient-item.selected {
            border: 1px solid var(--gold-primary);
            background: rgba(212, 168, 83, 0.1);
        }
        .press-recipient-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--gold-primary);
        }
        .press-recipient-info {
            flex: 1;
            min-width: 0;
        }
        .press-recipient-name {
            font-size: 0.85rem;
            color: var(--text-primary);
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .press-recipient-meta {
            font-size: 0.7rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .press-recipient-email {
            font-size: 0.7rem;
            color: var(--gold-primary);
        }
        .press-no-email {
            font-size: 0.7rem;
            color: var(--error);
            font-style: italic;
        }
        
        /* Footer */
        .press-modal-footer {
            padding: 1rem 1.5rem;
            background: var(--bg-deep);
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .press-footer-info {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        .press-footer-info strong {
            color: var(--gold-primary);
        }
        .press-footer-actions {
            display: flex;
            gap: 0.75rem;
        }
        .press-btn {
            padding: 0.65rem 1.25rem;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }
        .press-btn svg {
            width: 16px;
            height: 16px;
        }
        .press-btn.secondary {
            background: transparent;
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
        }
        .press-btn.secondary:hover {
            border-color: var(--gold-primary);
            color: var(--gold-primary);
        }
        .press-btn.primary {
            background: var(--gold-primary);
            border: none;
            color: var(--bg-deep);
        }
        .press-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 168, 83, 0.3);
        }
        .press-btn.primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Sending Progress */
        .press-sending-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 15, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .press-sending-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-subtle);
            border-top-color: var(--gold-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        .press-sending-text {
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }
        .press-sending-progress {
            color: var(--gold-primary);
            font-size: 0.9rem;
        }
        
        /* History View */
        .press-history-list {
            padding: 1rem;
        }
        .press-history-item {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .press-history-item:hover {
            border-color: var(--gold-primary);
        }
        .press-history-subject {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        .press-history-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        .press-history-stat {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .press-history-stat.success { color: var(--success); }
        .press-history-stat.failed { color: var(--error); }

        /* Responsive */
        @media (max-width: 1200px) {
            .app-container { grid-template-columns: 220px 320px 1fr; }
        }

        @media (max-width: 900px) {
            .app-container { grid-template-columns: 1fr; }
            .sidebar, .list-panel { display: none; }
        }
    </style>
</head>
<body>
    <!-- ===== LOGIN GATE ===== -->
    <div class="login-gate" id="loginGate">
        <div class="login-container">
            <div class="login-logo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                <h1>LUMINARY</h1>
                <p>Communications Command Center</p>
            </div>

            <div class="login-box">
                <div class="login-title">Secure Access Required</div>
                
                <div class="login-field">
                    <label class="login-label">Access Code</label>
                    <input type="password" class="login-input" id="accessCode" placeholder="" autocomplete="off">
                </div>

                <button class="login-btn" id="loginBtn" onclick="attemptLogin()">
                    Authenticate
                </button>

                <div class="login-error" id="loginError">
                    Invalid access code. Please try again.
                </div>
            </div>

            <div class="login-footer">
                Authorized personnel only. All access is logged.
            </div>
        </div>
    </div>

    <!-- ===== MAIN APP ===== -->
    <div class="app-container" id="appContainer">
        <!-- Left Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo-row">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                    <span class="logo-text">LUMINARY</span>
                </div>
                <div class="logo-subtitle">Command Center</div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-group">
                    <div class="nav-group-title">Inbox</div>
                    <div class="nav-item active" data-view="all">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/></svg>
                        All Partners
                        <span class="nav-badge" id="navAllCount">0</span>
                    </div>
                    <div class="nav-item" data-view="unread">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                        Needs Response
                        <span class="nav-badge unread" id="navUnreadCount">0</span>
                    </div>
                </div>

                <div class="nav-group">
                    <div class="nav-group-title">Partners</div>
                    <div class="nav-item" data-view="universities">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                        Universities
                        <span class="nav-badge" id="navUniCount">0</span>
                    </div>
                    <div class="nav-item" data-view="media">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/></svg>
                        Media Outlets
                        <span class="nav-badge media" id="navMediaCount">0</span>
                    </div>
                </div>

                <div class="nav-group">
                    <div class="nav-group-title">Status</div>
                    <div class="nav-item" data-view="responded">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        Responded
                        <span class="nav-badge success" id="navRespondedCount">0</span>
                    </div>
                    <div class="nav-item" data-view="pending">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        Pending
                        <span class="nav-badge warning" id="navPendingCount">0</span>
                    </div>
                </div>

                <div class="nav-group">
                    <div class="nav-group-title">Outreach</div>
                    <div class="nav-item" data-action="pressRelease">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/></svg>
                        Press Release
                    </div>
                    <div class="nav-item" data-action="pressHistory">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        Send History
                    </div>
                </div>

                <div class="nav-group">
                    <div class="nav-group-title">Data</div>
                    <div class="nav-item" data-action="templates">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        Templates
                    </div>
                    <div class="nav-item" data-action="export">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        Export
                    </div>
                    <div class="nav-item" data-action="import">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                        Import
                    </div>
                    <div class="nav-item" data-action="refresh">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                        Refresh Data
                    </div>
                </div>
            </nav>

            <div class="sidebar-footer">
                <button class="logout-btn" onclick="logout()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                    Logout
                </button>
            </div>
        </aside>

        <!-- Middle Panel - Partner List -->
        <section class="list-panel">
            <div class="list-header">
                <div class="list-header-title">
                    <span id="listTitle">All Partners</span>
                    <span style="font-size: 0.8rem; color: var(--text-muted);" id="listCount">(0)</span>
                </div>
                <div class="list-search">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    <input type="text" id="searchInput" placeholder="Search partners...">
                </div>
            </div>

            <div class="list-filters">
                <button class="filter-chip active" data-filter="all">All</button>
                <button class="filter-chip" data-filter="unread">Unread</button>
                <button class="filter-chip" data-filter="responded">Responded</button>
            </div>

            <div class="list-content" id="partnerList"></div>
        </section>

        <!-- Right Panel - Detail View -->
        <section class="detail-panel" id="detailPanel">
            <div class="detail-main">
                <div class="empty-state" id="emptyState">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                    <h3>Select a Partner</h3>
                    <p>Choose a partner from the list to view conversation</p>
                </div>

                <div id="conversationView" style="display: none; flex-direction: column; height: 100%;">
                    <div class="detail-header">
                        <div class="detail-header-info">
                            <h2 id="detailName">Partner Name</h2>
                            <p id="detailMeta">Details</p>
                        </div>
                        <div class="detail-actions">
                            <button class="action-btn" id="btnCopyKey" title="Copy key">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                Copy Key
                            </button>
                            <button class="action-btn" id="btnMarkStatus">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                Mark Viewed
                            </button>
                        </div>
                    </div>

                    <div class="detail-tabs">
                        <button class="detail-tab active" data-tab="conversation">Conversation</button>
                        <button class="detail-tab" data-tab="files">Files</button>
                        <button class="detail-tab" data-tab="details">Details</button>
                    </div>

                    <div class="detail-content" id="detailContent"></div>

                    <div class="compose-area" id="composeArea">
                    <div class="compose-header">
                        <span class="compose-label">Your Response</span>
                        <div class="compose-tools">
                            <button class="tool-btn" id="btnAttachFile" title="Attach file">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>
                            </button>
                            <button class="tool-btn" id="btnInsertTemplate" title="Quick reply">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                            </button>
                        </div>
                    </div>
                    <textarea class="compose-editor" id="composeEditor" placeholder="Write your response..."></textarea>
                    <input type="file" id="adminFileInput" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt" style="display: none;">
                    <div class="file-preview-container" id="adminFilePreview"></div>
                    <div class="compose-footer">
                        <span class="compose-info">Ctrl+Enter to send  Auto-saved</span>
                        <div class="compose-buttons">
                            <button class="action-btn primary" id="btnSendMessage">Send Message</button>
                        </div>
                    </div>
                </div>
            </div>
            </div><!-- End detail-main -->

            <!-- Document Preview Panel (Split View) -->
            <div class="doc-preview-panel" id="docPreviewPanel">
                <div class="doc-preview-header">
                    <div class="doc-preview-header-info">
                        <div class="doc-preview-title" id="previewFileName">Document Name</div>
                        <div class="doc-preview-meta">
                            <span id="previewFileSize">0 KB</span>
                            <span></span>
                            <span id="previewFileType">PDF</span>
                            <span></span>
                            <span id="previewFileSender">From Partner</span>
                        </div>
                    </div>
                    <div class="doc-preview-actions">
                        <button class="doc-preview-btn" id="btnPreviewFullscreen" title="Fullscreen">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg>
                        </button>
                        <button class="doc-preview-btn" id="btnPreviewNewTab" title="Open in new tab">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                        </button>
                        <button class="doc-preview-btn close" id="btnClosePreview" title="Close preview">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>
                </div>

                <div class="doc-preview-tabs">
                    <button class="doc-preview-tab active" data-preview-tab="preview">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                        Preview
                    </button>
                    <button class="doc-preview-tab" data-preview-tab="comments">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/></svg>
                        Comments
                        <span class="doc-preview-tab-badge" id="commentCount" style="display: none;">0</span>
                    </button>
                    <button class="doc-preview-tab" data-preview-tab="info">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        Info
                    </button>
                </div>

                <div class="doc-preview-content">
                    <!-- Preview Tab -->
                    <div class="doc-preview-viewer" id="previewViewer">
                        <!-- Content injected by JS -->
                    </div>

                    <!-- Comments Tab -->
                    <div class="doc-preview-annotations" id="previewComments" style="display: none;">
                        <div class="annotation-form" id="annotationForm">
                            <textarea id="annotationInput" placeholder="Add a comment about this document..."></textarea>
                            <div class="annotation-form-actions">
                                <button class="annotation-form-btn cancel" onclick="toggleAnnotationForm(false)">Cancel</button>
                                <button class="annotation-form-btn save" onclick="saveAnnotation()">Add Comment</button>
                            </div>
                        </div>
                        <div class="annotation-header">
                            <h4>Document Comments</h4>
                            <button class="annotation-add-btn" onclick="toggleAnnotationForm(true)">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                Add Comment
                            </button>
                        </div>
                        <div class="annotation-list" id="annotationList">
                            <!-- Comments injected by JS -->
                        </div>
                    </div>

                    <!-- Info Tab -->
                    <div class="doc-preview-info" id="previewInfo" style="display: none;">
                        <div class="file-info-icon" id="fileInfoIcon">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        </div>
                        <div class="file-info-section">
                            <h4>File Details</h4>
                            <div class="file-info-row">
                                <span class="file-info-label">Name</span>
                                <span class="file-info-value" id="infoFileName">-</span>
                            </div>
                            <div class="file-info-row">
                                <span class="file-info-label">Type</span>
                                <span class="file-info-value" id="infoFileType">-</span>
                            </div>
                            <div class="file-info-row">
                                <span class="file-info-label">Size</span>
                                <span class="file-info-value" id="infoFileSize">-</span>
                            </div>
                        </div>
                        <div class="file-info-section">
                            <h4>Message Context</h4>
                            <div class="file-info-row">
                                <span class="file-info-label">Sent by</span>
                                <span class="file-info-value" id="infoSender">-</span>
                            </div>
                            <div class="file-info-row">
                                <span class="file-info-label">Date</span>
                                <span class="file-info-value" id="infoDate">-</span>
                            </div>
                            <div class="file-info-row">
                                <span class="file-info-label">Message</span>
                                <span class="file-info-value" id="infoMessage">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="doc-preview-footer">
                    <div class="doc-preview-nav">
                        <button class="doc-preview-nav-btn" id="btnPrevFile" onclick="navigatePreviewFile(-1)">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                            Previous
                        </button>
                        <span id="fileNavCounter" style="font-size: 0.75rem; color: var(--text-muted); padding: 0 0.5rem;">1 of 3</span>
                        <button class="doc-preview-nav-btn" id="btnNextFile" onclick="navigatePreviewFile(1)">
                            Next
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </button>
                    </div>
                    <button class="doc-preview-download-btn" id="btnDownloadPreview" onclick="downloadPreviewFile()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                        Download
                    </button>
                </div>
            </div>
        </section>
    </div>

    <!-- Research Hub Modal -->
    <div class="research-hub" id="researchHub">
        <div class="research-sidebar">
            <div class="research-sidebar-header">
                <h2>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>
                    Research Hub
                </h2>
                <div class="research-partner-name" id="researchPartnerName">Loading...</div>
                <div class="research-progress">
                    <span id="researchProgressText">0/8 complete</span>
                    <div class="research-progress-bar">
                        <div class="research-progress-fill" id="researchProgressFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div class="research-categories" id="researchCategories">
                <!-- Categories loaded dynamically -->
            </div>
            <div class="research-sidebar-footer">
                <button class="press-btn secondary" onclick="runAllPartnerResearch()" style="width: 100%;">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    Run All Research
                </button>
                <button class="press-btn primary" onclick="openProposalFromResearch()" id="generateProposalBtn" style="width: 100%;" disabled>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    Generate Proposal
                </button>
            </div>
        </div>
        
        <div class="research-main">
            <div class="research-toolbar">
                <div class="research-toolbar-title" id="researchCatTitle">Select a Research Category</div>
                <div class="research-toolbar-actions">
                    <button class="press-btn secondary" onclick="runCurrentCatResearch()" id="runResearchBtn" disabled>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                        Run Research
                    </button>
                    <button class="press-btn secondary" onclick="saveCurrentCatResearch()" id="saveResearchBtn" disabled>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
                        Save
                    </button>
                </div>
            </div>
            
            <div class="research-content" id="researchMainContent">
                <div class="research-results-placeholder">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                    <p>Select a research category from the sidebar to begin gathering intelligence.</p>
                </div>
            </div>
        </div>
        
        <button class="research-close" onclick="closeResearchHub()">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
    </div>

    <!-- Document Review Modal with Sidenotes -->
    <div class="doc-review" id="docReview">
        <div class="doc-review-main">
            <div class="doc-review-toolbar">
                <div>
                    <div class="doc-review-title">Partnership Proposal</div>
                    <div class="doc-review-subtitle" id="docReviewPartner"></div>
                </div>
                <div class="doc-status">
                    <span class="doc-status-badge pending" id="docStatusBadge">Draft</span>
                    <button class="press-btn secondary" onclick="downloadProposalDocx()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                        Download
                    </button>
                    <button class="press-btn secondary" onclick="sendProposalToPartner()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                        Send
                    </button>
                    <button class="press-btn primary" onclick="closeDocReview()">Close</button>
                </div>
            </div>
            
            <div class="doc-review-content">
                <div class="doc-wrapper">
                    <div class="doc-paper" id="docPaperContent">
                        <!-- Document content loaded dynamically -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="sidenotes-panel">
            <div class="sidenotes-header">
                <h3>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/></svg>
                    Discussion
                </h3>
                <span class="sidenotes-count" id="sidenotesCount">0</span>
            </div>
            <div class="sidenotes-list" id="sidenotesList">
                <div class="sidenotes-empty">No notes yet.<br>Add a note to start the discussion.</div>
            </div>
            <div class="sidenotes-compose">
                <textarea id="sidenoteInput" placeholder="Add a note, question, or suggested change..."></textarea>
                <div class="sidenotes-compose-row">
                    <select class="sidenotes-section-select" id="sidenoteSectionSelect">
                        <option value="">General Note</option>
                        <option value="terms">Re: Terms</option>
                        <option value="investment">Re: Investment</option>
                        <option value="deliverables">Re: Deliverables</option>
                        <option value="payment">Re: Payment</option>
                    </select>
                    <button class="press-btn primary" onclick="addSidenote()">Add Note</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Research Hub Modal -->
    <div class="research-hub" id="researchHub">
        <div class="research-hub-sidebar">
            <div class="research-hub-header">
                <h2>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>
                    Research Hub
                </h2>
                <div class="research-hub-partner" id="researchPartnerName">Loading...</div>
                <div class="research-hub-partner-type" id="researchPartnerType"></div>
                
                <div class="research-progress">
                    <div class="research-progress-label">
                        <span>Research Progress</span>
                        <span id="researchProgressText">0 / 8</span>
                    </div>
                    <div class="research-progress-bar">
                        <div class="research-progress-fill" id="researchProgressFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <div class="research-categories" id="researchCategories">
                <!-- Categories loaded dynamically -->
            </div>
            
            <div class="research-hub-footer">
                <button class="press-btn secondary" style="width: 100%;" onclick="runAllResearchSequential()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                    Run All Research
                </button>
                <button class="press-btn primary" style="width: 100%;" onclick="proceedToProposal()" id="proceedToProposalBtn" disabled>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    Proceed to Proposal 
                </button>
            </div>
        </div>
        
        <div class="research-hub-main">
            <div class="research-hub-toolbar" id="researchToolbar" style="display: none;">
                <div class="research-toolbar-title">
                    <span class="category-icon" id="researchCategoryIcon"></span>
                    <h3 id="researchCategoryTitle">Select a Category</h3>
                </div>
                <div class="research-hub-actions">
                    <button class="press-btn secondary" onclick="runCurrentResearch()" id="runResearchBtn">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                        Run Research
                    </button>
                    <button class="press-btn primary" onclick="saveCurrentResearch()" id="saveResearchBtn">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                        Save
                    </button>
                </div>
            </div>
            
            <div class="research-hub-content" id="researchContent">
                <div class="research-empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                    <h3>Select a Research Category</h3>
                    <p>Choose a category from the left to begin gathering intelligence about this partner.</p>
                </div>
            </div>
        </div>
        
        <button class="research-hub-close" onclick="closeResearchHub()">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
    </div>
    
    <div class="research-save-indicator" id="researchSaveIndicator">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
        Research saved
    </div>

    <!-- Document Review Modal -->
    <div class="doc-review" id="docReview">
        <div class="doc-review-main">
            <div class="doc-review-toolbar">
                <div class="doc-review-toolbar-left">
                    <div>
                        <div class="doc-review-title">Partnership Proposal</div>
                        <div class="doc-review-partner" id="docReviewPartner">Partner Name</div>
                    </div>
                    <div class="doc-review-status">
                        <div class="doc-status-badge draft" id="docStatusBadge">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="12" height="12"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                            Draft
                        </div>
                    </div>
                </div>
                <div class="doc-review-toolbar-right">
                    <select id="docStatusSelect" onchange="updateDocStatus(this.value)" style="padding: 0.4rem 0.6rem; background: var(--bg-deep); border: 1px solid var(--border-subtle); border-radius: 6px; color: var(--text-primary); font-size: 0.8rem;">
                        <option value="draft">Draft</option>
                        <option value="review">Under Review</option>
                        <option value="pending-signature">Pending Signatures</option>
                        <option value="executed">Executed</option>
                    </select>
                    <button class="press-btn secondary" onclick="downloadReviewDoc()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        Download
                    </button>
                    <button class="press-btn primary" onclick="closeDocReview()">
                        Close
                    </button>
                </div>
            </div>
            
            <div class="doc-review-content">
                <div class="doc-review-wrapper">
                    <div class="doc-review-document" id="docReviewContent">
                        <!-- Document content loaded dynamically -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="sidenotes-panel">
            <div class="sidenotes-header">
                <h3>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/></svg>
                    Discussion Notes
                </h3>
                <span class="sidenotes-count" id="sidenotesCount">0</span>
            </div>
            
            <div class="sidenotes-filter">
                <button class="sidenotes-filter-btn active" onclick="filterSidenotes('all')" data-filter="all">All</button>
                <button class="sidenotes-filter-btn" onclick="filterSidenotes('luminary')" data-filter="luminary">Luminary</button>
                <button class="sidenotes-filter-btn" onclick="filterSidenotes('partner')" data-filter="partner">Partner</button>
                <button class="sidenotes-filter-btn" onclick="filterSidenotes('unresolved')" data-filter="unresolved">Open</button>
            </div>
            
            <div class="sidenotes-list" id="sidenotesList">
                <!-- Sidenotes loaded dynamically -->
            </div>
            
            <div class="sidenotes-compose">
                <div class="sidenotes-compose-section">
                    <label>Section Reference</label>
                    <select id="sidenoteSection">
                        <option value="">General Comment</option>
                        <option value="executive-summary">Executive Summary</option>
                        <option value="about-luminary">About Luminary</option>
                        <option value="partnership-overview">Partnership Overview</option>
                        <option value="deliverables">Deliverables & Access</option>
                        <option value="investment-terms">Investment & Terms</option>
                        <option value="investment-rationale">Investment Rationale</option>
                        <option value="payment-pathway">Payment Pathway</option>
                        <option value="next-steps">Next Steps</option>
                        <option value="signatures">Signatures</option>
                    </select>
                </div>
                <textarea id="sidenoteInput" placeholder="Add a note, question, or suggestion..."></textarea>
                <div class="sidenotes-compose-actions">
                    <button class="press-btn primary" onclick="addSidenote()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        Add Note
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Signature Modal -->
    <div class="signature-modal" id="signatureModal">
        <div class="signature-modal-content">
            <div class="signature-modal-title" id="signatureModalTitle">Sign Document</div>
            <div class="signature-modal-desc" id="signatureModalDesc">Draw your signature below</div>
            
            <div class="signature-modal-canvas-container">
                <canvas class="signature-modal-canvas" id="signatureModalCanvas"></canvas>
            </div>
            
            <div class="signature-modal-hint">Use your mouse or finger to draw your signature</div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; text-align: left;">
                <div>
                    <label style="font-size: 0.75rem; color: #666; display: block; margin-bottom: 0.25rem;">Printed Name</label>
                    <input type="text" id="signatureModalName" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" placeholder="Enter your name">
                </div>
                <div>
                    <label style="font-size: 0.75rem; color: #666; display: block; margin-bottom: 0.25rem;">Title</label>
                    <input type="text" id="signatureModalTitle2" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" placeholder="Enter your title">
                </div>
            </div>
            
            <div class="signature-modal-actions">
                <button class="signature-modal-btn cancel" onclick="closeSignatureModal()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    Cancel
                </button>
                <button class="signature-modal-btn clear" onclick="clearSignatureModal()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    Clear
                </button>
                <button class="signature-modal-btn apply" onclick="applySignature()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                    Apply Signature
                </button>
            </div>
        </div>
    </div>

    <!-- Proposal Wizard Modal -->
    <div class="proposal-wizard" id="proposalWizard">
        <div class="proposal-wizard-content">
            <div class="proposal-wizard-header">
                <h2>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="22" height="22"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    <span id="wizardPartnerName">Partnership Proposal</span>
                </h2>
                <div class="proposal-wizard-steps">
                    <div class="wizard-step active" data-step="1">
                        <span class="wizard-step-num">1</span>
                        Research Summary
                    </div>
                    <div class="wizard-step" data-step="2">
                        <span class="wizard-step-num">2</span>
                        Terms & Deliverables
                    </div>
                    <div class="wizard-step" data-step="3">
                        <span class="wizard-step-num">3</span>
                        Rationale & Pathway
                    </div>
                    <div class="wizard-step" data-step="4">
                        <span class="wizard-step-num">4</span>
                        Generate & Review
                    </div>
                </div>
                <button class="press-modal-close" onclick="closeProposalWizard()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            
            <div class="proposal-wizard-body" id="wizardBody">
                <!-- Step 1: Research Summary -->
                <div class="wizard-step-content" id="wizardStep1">
                    <div class="research-summary-header">
                        <h3>Research Data Available</h3>
                        <p>This proposal will be built using the research you've gathered. Review the data below.</p>
                    </div>
                    <div class="research-summary-grid" id="researchSummaryGrid">
                        <!-- Loaded dynamically -->
                    </div>
                    <div class="research-summary-actions" id="researchSummaryActions">
                        <!-- Shows if research is incomplete -->
                    </div>
                </div>
                
                <!-- Step 2: Terms & Deliverables -->
                <div class="wizard-step-content" id="wizardStep2" style="display: none;">
                    <div class="proposal-config">
                        <div class="config-section">
                            <div class="config-section-title">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                Investment Terms
                            </div>
                            <div class="config-field">
                                <label>Partnership Tier</label>
                                <div class="tier-options">
                                    <div class="tier-option" data-tier="explorer" onclick="selectTier('explorer')">
                                        <div class="tier-option-name">Explorer</div>
                                        <div class="tier-option-price">$5,000/yr</div>
                                    </div>
                                    <div class="tier-option selected" data-tier="partner" onclick="selectTier('partner')">
                                        <div class="tier-option-name">Partner</div>
                                        <div class="tier-option-price">$15,000/yr</div>
                                    </div>
                                    <div class="tier-option" data-tier="enterprise" onclick="selectTier('enterprise')">
                                        <div class="tier-option-name">Enterprise</div>
                                        <div class="tier-option-price">$50,000/yr</div>
                                    </div>
                                </div>
                            </div>
                            <div class="config-field">
                                <label>Custom Annual Investment ($)</label>
                                <input type="number" id="proposalAmount" value="15000" min="0" step="1000">
                            </div>
                            <div class="config-field">
                                <label>Term Length</label>
                                <select id="proposalTerm">
                                    <option value="12">12 Months</option>
                                    <option value="24" selected>24 Months</option>
                                    <option value="36">36 Months</option>
                                </select>
                            </div>
                            <div class="config-field">
                                <label>Payment Schedule</label>
                                <select id="proposalPaymentSchedule">
                                    <option value="annual">Annual (one payment)</option>
                                    <option value="semi-annual">Semi-Annual (2 payments)</option>
                                    <option value="quarterly" selected>Quarterly (4 payments)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="config-section">
                            <div class="config-section-title">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>
                                Platform & Access
                            </div>
                            <div class="config-field">
                                <label>Primary Platform Access</label>
                                <select id="proposalPlatform">
                                    <option value="vestiq">Vestiq (Financial Markets Intelligence)</option>
                                    <option value="bluehaven">Blue Haven (E-Commerce & Marketplace)</option>
                                    <option value="legalinsights">Legal Insights (Policy & Regulatory)</option>
                                    <option value="all">Full Platform Suite</option>
                                </select>
                            </div>
                            <div class="config-field">
                                <label>User Seats</label>
                                <input type="number" id="proposalSeats" value="10" min="1">
                            </div>
                            <div class="config-field">
                                <label>Deliverables (one per line)</label>
                                <textarea id="proposalDeliverables" placeholder="Full platform access&#10;Dedicated onboarding & training&#10;Priority technical support&#10;Quarterly business reviews"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Step 3: Rationale & Payment Pathway -->
                <div class="wizard-step-content" id="wizardStep3" style="display: none;">
                    <div class="rationale-section">
                        <div class="rationale-header">
                            <div class="rationale-title">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                                Investment Rationale
                            </div>
                            <button class="press-btn secondary" onclick="generateInvestmentRationale()">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                Generate with AI
                            </button>
                        </div>
                        <p class="rationale-description">Explain the logical reasoning behind the proposed investment amount. This will be shared transparently with the partner.</p>
                        <textarea id="proposalRationale" class="rationale-input" placeholder="The proposed annual investment of $X is structured based on:

1. SCOPE OF ACCESS
   - Platform capabilities being provided
   - Number of users and seats
   - Level of support included

2. VALUE DELIVERED
   - Specific outcomes they can expect
   - Efficiency gains or capabilities enabled
   - Comparative value vs. alternatives

3. INVESTMENT LOGIC
   - How we arrived at this figure
   - What's included at this tier
   - Any flexibility in terms"></textarea>
                    </div>
                    
                    <div class="rationale-section">
                        <div class="rationale-header">
                            <div class="rationale-title">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/></svg>
                                Payment Pathway
                            </div>
                            <button class="press-btn secondary" onclick="generatePaymentPathway()">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                Generate from Research
                            </button>
                        </div>
                        <p class="rationale-description">Based on your research, describe how this organization can fund this partnership. Include budget sources, approval process, and timeline.</p>
                        <textarea id="proposalPaymentPathway" class="rationale-input" placeholder="Based on our research, we believe the following pathway is available:

1. FUNDING SOURCE
   - Identified budget or fund
   - Grant opportunities if applicable
   - Department or cost center

2. APPROVAL PROCESS
   - Key decision makers involved
   - Typical approval timeline
   - Required documentation

3. TIMING CONSIDERATIONS
   - Fiscal year calendar
   - Budget cycle deadlines
   - Optimal timing for proposal

4. TAX & INCENTIVE BENEFITS
   - Available tax credits
   - Educational deductions
   - R&D incentives"></textarea>
                    </div>
                </div>
                
                <!-- Step 4: Generate & Review -->
                <div class="wizard-step-content" id="wizardStep4" style="display: none;">
                    <div id="proposalPreviewContainer">
                        <div class="proposal-generating">
                            <div class="press-sending-spinner"></div>
                            <div>Generating your proposal...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="proposal-wizard-footer">
                <button class="press-btn secondary" id="wizardBackBtn" onclick="wizardBack()" style="visibility: hidden;">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                    Back
                </button>
                <div style="display: flex; gap: 0.75rem;">
                    <button class="press-btn primary" id="wizardNextBtn" onclick="wizardNext()">
                        Next
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Press Release Modal -->
    <div class="press-modal" id="pressReleaseModal">
        <div class="press-modal-content">
            <div class="press-modal-header">
                <h2>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/></svg>
                    Compose Press Release
                </h2>
                <button class="press-modal-close" onclick="closePressModal()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            
            <div class="press-modal-body">
                <div class="press-compose">
                    <div class="press-field">
                        <label>Subject Line</label>
                        <input type="text" id="pressSubject" placeholder="[Press Release] Your headline here">
                        <div class="press-field-hint">Use personalization: <span class="press-tokens" id="subjectTokens"></span></div>
                    </div>
                    
                    <div class="press-field">
                        <label>Email Body (HTML supported)</label>
                        <textarea id="pressBody" placeholder="Write your press release content here...

Dear {{name}},

[Your press release content]

Best regards,
Luminary AI Technologies
media@luminary-tech.ai"></textarea>
                        <div class="press-field-hint">
                            Available tokens: 
                            <div class="press-tokens">
                                <span class="press-token" onclick="insertToken('{{name}}')">{{name}}</span>
                                <span class="press-token" onclick="insertToken('{{first_name}}')">{{first_name}}</span>
                                <span class="press-token" onclick="insertToken('{{outlet}}')">{{outlet}}</span>
                                <span class="press-token" onclick="insertToken('{{category}}')">{{category}}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="press-recipients">
                    <div class="press-recipients-header">
                        <h3>Recipients</h3>
                        <div class="press-recipients-stats">
                            <span>Total: <strong id="pressTotalCount">0</strong></span>
                            <span>With Email: <strong id="pressEmailCount">0</strong></span>
                        </div>
                    </div>
                    
                    <div class="press-recipients-filters">
                        <select id="pressCategoryFilter" onchange="filterPressRecipients()">
                            <option value="all">All Categories</option>
                        </select>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="pressSelectAll" onchange="toggleAllRecipients()" checked>
                            <span style="font-size: 0.85rem; color: var(--text-secondary);">Select All with Email</span>
                        </label>
                    </div>
                    
                    <div class="press-recipients-list" id="pressRecipientsList">
                        <!-- Recipients loaded dynamically -->
                    </div>
                </div>
            </div>
            
            <div class="press-modal-footer">
                <div class="press-footer-info">
                    <strong id="pressSelectedCount">0</strong> recipients selected
                </div>
                <div class="press-footer-actions">
                    <button class="press-btn secondary" onclick="savePressReleaseDraft()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
                        Save Draft
                    </button>
                    <button class="press-btn secondary" onclick="sendTestEmail()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        Send Test
                    </button>
                    <button class="press-btn primary" id="pressSendBtn" onclick="sendPressRelease()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                        Send Press Release
                    </button>
                </div>
            </div>
            
            <!-- Sending Overlay -->
            <div class="press-sending-overlay" id="pressSendingOverlay" style="display: none;">
                <div class="press-sending-spinner"></div>
                <div class="press-sending-text">Sending Press Release...</div>
                <div class="press-sending-progress" id="pressSendingProgress">0 / 0 sent</div>
            </div>
        </div>
    </div>

    <!-- Press History Modal -->
    <div class="press-modal" id="pressHistoryModal">
        <div class="press-modal-content" style="max-width: 800px;">
            <div class="press-modal-header">
                <h2>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    Press Release History
                </h2>
                <button class="press-modal-close" onclick="closePressHistoryModal()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            
            <div class="press-history-list" id="pressHistoryList">
                <!-- History items loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Save Indicator -->
    <div class="save-indicator" id="saveIndicator">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
        <span id="saveText">Saved</span>
    </div>

    <!-- Template Modal -->
    <div class="modal-overlay" id="templateModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Edit Message Templates</h3>
                <button class="modal-close" onclick="closeModal('templateModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Template Type</label>
                    <select class="form-select" id="templateType" onchange="loadTemplateContent()">
                        <option value="proposal">University Partnership Proposal</option>
                        <option value="pitch">Media Press Kit</option>
                        <option value="followup">Follow-up Message</option>
                        <option value="reminder">Reminder</option>
                        <option value="thankyou">Thank You</option>
                        <option value="schedule">Schedule Call</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Content</label>
                    <textarea class="form-textarea" id="templateEditor"></textarea>
                    <p class="form-help">Variables: {{partnerName}}, {{schoolName}}, {{universityName}}, {{outletName}}, {{focus}}, {{state}}</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn" onclick="closeModal('templateModal')">Cancel</button>
                <button class="action-btn primary" onclick="saveTemplateChanges()">Save Template</button>
            </div>
        </div>
    </div>

    <!-- Quick Reply Modal -->
    <div class="modal-overlay" id="quickReplyModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3>Quick Reply</h3>
                <button class="modal-close" onclick="closeModal('quickReplyModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <button class="action-btn" style="justify-content: flex-start; padding: 0.85rem 1rem;" onclick="insertQuickReply('followup')">
                        Follow-up  Check on interest
                    </button>
                    <button class="action-btn" style="justify-content: flex-start; padding: 0.85rem 1rem;" onclick="insertQuickReply('schedule')">
                        Schedule  Propose a meeting
                    </button>
                    <button class="action-btn" style="justify-content: flex-start; padding: 0.85rem 1rem;" onclick="insertQuickReply('thankyou')">
                        Thank You  Express appreciation
                    </button>
                    <button class="action-btn" style="justify-content: flex-start; padding: 0.85rem 1rem;" onclick="insertQuickReply('info')">
                        More Info  Share details
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal confirm-dialog">
            <div class="modal-body">
                <svg class="confirm-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                <h4 id="confirmTitle">Delete Message?</h4>
                <p id="confirmText">This action cannot be undone.</p>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button class="action-btn" onclick="closeModal('confirmModal')">Cancel</button>
                <button class="action-btn danger" id="confirmAction">Delete</button>
            </div>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="importFile" accept=".json" style="display: none;">

    <script>
        // ===== AUTHENTICATION =====
        const API_BASE = 'https://exciting-vitality-production-431a.up.railway.app';
        let authToken = localStorage.getItem('luminary_auth_token') || null;
        // Password: "Luminary2025!Command" 
        // SHA-256 hash of the password
        const VALID_HASH = '8a9bcf4e2d1c7b3a5f6e8d0c9b2a4f7e1d3c6b8a0e2f4d6c8b0a2e4f6d8c0b2a';
        
        // Simple hash function (for demo - in production use proper crypto)
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password + 'luminary-salt-2025');
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Check if already authenticated
        function checkAuth() {
            if (authToken) {
                showApp();
                return true;
            }
            return false;
        }

        // Attempt login via API
        async function attemptLogin() {
            const input = document.getElementById('accessCode');
            const error = document.getElementById('loginError');
            const btn = document.getElementById('loginBtn');
            const password = input.value;

            if (!password) {
                input.classList.add('error');
                setTimeout(() => input.classList.remove('error'), 400);
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Authenticating...';

            try {
                const response = await fetch(`${API_BASE}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                
                const data = await response.json();
                
                if (response.ok && data.token) {
                    authToken = data.token;
                    localStorage.setItem('luminary_auth_token', authToken);
                    showApp();
                } else {
                    throw new Error(data.error || 'Invalid credentials');
                }
            } catch (err) {
                input.classList.add('error');
                error.classList.add('visible');
                setTimeout(() => {
                    input.classList.remove('error');
                    error.classList.remove('visible');
                }, 3000);
            }

            btn.disabled = false;
            btn.textContent = 'Authenticate';
        }

        function showApp() {
            document.getElementById('loginGate').classList.add('hidden');
            document.getElementById('appContainer').classList.add('active');
            loadPartnerData();
        }

        // ===== RESEARCH HUB SYSTEM =====
        
        const RESEARCH_CATEGORIES = [
            { id: 'background', icon: '', title: 'Organization Background', 
              query: 'Research {org}: What are they known for? Mission statement, founding, size, revenue/budget, market position, and recent accomplishments or recognition.' },
            { id: 'leadership', icon: '', title: 'Key Decision Makers', 
              query: 'Who are the key decision makers at {org} for technology or innovation partnerships? Find names, titles, backgrounds, contact information, LinkedIn profiles of relevant leadership.' },
            { id: 'tech_contracts', icon: '', title: 'Active Technology Contracts', 
              query: 'What technology vendors, software platforms, data services, or SaaS products does {org} currently use? Look for press releases, job postings mentioning tools, public procurement records, case studies.' },
            { id: 'vendor_rules', icon: '', title: 'Vendor/Partnership Requirements', 
              query: 'What are {org}\'s requirements, policies, or processes for vendor agreements and partnerships? Look for procurement policies, RFP requirements, vendor registration, compliance requirements, insurance minimums.' },
            { id: 'budget_cycles', icon: '', title: 'Budget & Funding Cycles', 
              query: 'What is {org}\'s budget capacity and fiscal calendar? When do they make purchasing decisions? Look for annual reports, budget cycles, fiscal year timing, technology spending allocations.' },
            { id: 'payment_pathway', icon: '', title: 'Payment Pathway Analysis', 
              query: 'How does {org} fund new technology initiatives? What is their approval process for new vendors? Who approves purchases at different dollar thresholds? Are there specific grants, funds, or budget lines for innovation?' },
            { id: 'tax_benefits', icon: '', title: 'Tax Benefits & Incentives', 
              query: 'What tax benefits, credits, incentives, or deductions might {org} receive for technology investments, educational partnerships, or R&D? Research relevant state and federal programs, education credits, nonprofit advantages.' },
            { id: 'competitive', icon: '', title: 'Competitive Landscape', 
              query: 'Who are {org}\'s peer institutions and how do they compare in technology adoption? What similar organizations have adopted AI/data analytics tools? What competitive pressures might motivate investment?' }
        ];
        
        let researchHubPartner = null;
        let currentResearchCat = null;
        let partnerResearchData = {};
        
        function openResearchHub() {
            if (!currentPartner) {
                alert('Please select a partner first');
                return;
            }
            
            researchHubPartner = currentPartner;
            const orgName = researchHubPartner.organizationName || researchHubPartner.universityName || researchHubPartner.recipientName;
            
            document.getElementById('researchPartnerName').textContent = orgName;
            
            // Load existing research
            loadStoredResearch();
            
            // Render UI
            renderResearchCategoriesSidebar();
            updateResearchProgress();
            
            // Reset main content
            document.getElementById('researchMainContent').innerHTML = `
                <div class="research-results-placeholder">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                    <p>Select a research category from the sidebar to begin.</p>
                    <p style="font-size: 0.85rem; margin-top: 0.5rem;">Complete at least 3 categories to generate a proposal.</p>
                </div>
            `;
            
            currentResearchCat = null;
            document.getElementById('researchCatTitle').textContent = 'Select a Research Category';
            document.getElementById('runResearchBtn').disabled = true;
            document.getElementById('saveResearchBtn').disabled = true;
            
            document.getElementById('researchHub').classList.add('active');
        }
        
        function closeResearchHub() {
            document.getElementById('researchHub').classList.remove('active');
        }
        
        function loadStoredResearch() {
            const partnerId = researchHubPartner._id || researchHubPartner.id;
            
            // Try localStorage first (for now)
            const cached = localStorage.getItem('luminary_research_' + partnerId);
            if (cached) {
                partnerResearchData = JSON.parse(cached);
            } else {
                partnerResearchData = {};
            }
            
            // Also fetch from server
            fetchResearchFromServer(partnerId);
        }
        
        async function fetchResearchFromServer(partnerId) {
            try {
                const response = await fetch(`${API_BASE}/api/admin/partners/${partnerId}/research`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.research) {
                        partnerResearchData = { ...partnerResearchData, ...data.research };
                        saveResearchToLocal();
                        renderResearchCategoriesSidebar();
                        updateResearchProgress();
                    }
                }
            } catch (e) {
                console.log('Could not fetch research from server:', e);
            }
        }
        
        function saveResearchToLocal() {
            const partnerId = researchHubPartner._id || researchHubPartner.id;
            localStorage.setItem('luminary_research_' + partnerId, JSON.stringify(partnerResearchData));
        }
        
        async function saveResearchToServer() {
            const partnerId = researchHubPartner._id || researchHubPartner.id;
            try {
                await fetch(`${API_BASE}/api/admin/partners/${partnerId}/research`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ research: partnerResearchData })
                });
            } catch (e) {
                console.error('Save research error:', e);
            }
        }
        
        function renderResearchCategoriesSidebar() {
            const container = document.getElementById('researchCategories');
            container.innerHTML = RESEARCH_CATEGORIES.map(cat => {
                const data = partnerResearchData[cat.id];
                const isComplete = data && data.content && data.content.length > 50;
                const isActive = currentResearchCat === cat.id;
                
                return `
                    <div class="research-cat ${isComplete ? 'complete' : ''} ${isActive ? 'active' : ''}" 
                         onclick="selectResearchCategory('${cat.id}')">
                        <span class="research-cat-icon">${cat.icon}</span>
                        <div class="research-cat-info">
                            <div class="research-cat-title">${cat.title}</div>
                            <div class="research-cat-status">${isComplete ? 'Data collected ' + formatTimeAgo(data.timestamp) : 'Not researched'}</div>
                        </div>
                        <div class="research-cat-check">${isComplete ? '' : ''}</div>
                    </div>
                `;
            }).join('');
        }
        
        function updateResearchProgress() {
            const completed = RESEARCH_CATEGORIES.filter(cat => {
                const data = partnerResearchData[cat.id];
                return data && data.content && data.content.length > 50;
            }).length;
            
            const total = RESEARCH_CATEGORIES.length;
            const percent = Math.round((completed / total) * 100);
            
            document.getElementById('researchProgressText').textContent = `${completed}/${total} complete`;
            document.getElementById('researchProgressFill').style.width = `${percent}%`;
            
            // Enable proposal button if at least 3 complete
            document.getElementById('generateProposalBtn').disabled = completed < 3;
        }
        
        function selectResearchCategory(catId) {
            currentResearchCat = catId;
            const cat = RESEARCH_CATEGORIES.find(c => c.id === catId);
            if (!cat) return;
            
            const orgName = researchHubPartner.organizationName || researchHubPartner.universityName || researchHubPartner.recipientName;
            const defaultQuery = cat.query.replace(/{org}/g, orgName);
            
            const data = partnerResearchData[catId] || {};
            
            document.getElementById('researchCatTitle').textContent = cat.icon + ' ' + cat.title;
            document.getElementById('runResearchBtn').disabled = false;
            document.getElementById('saveResearchBtn').disabled = false;
            
            document.getElementById('researchMainContent').innerHTML = `
                <div class="research-field">
                    <label class="research-field-label">Research Query</label>
                    <textarea class="research-field-input" id="researchQueryInput" rows="3">${data.query || defaultQuery}</textarea>
                </div>
                
                <div class="research-results">
                    <div class="research-results-header">
                        <span class="research-results-title">Research Results</span>
                        <span class="research-results-meta">${data.timestamp ? 'Last updated: ' + new Date(data.timestamp).toLocaleString() : ''}</span>
                    </div>
                    <div class="research-results-content" id="researchResultsBox">
                        ${data.content || '<div class="research-results-placeholder">Click "Run Research" to gather intelligence for this category.</div>'}
                    </div>
                </div>
                
                <div class="research-notes">
                    <label class="research-field-label">Your Notes & Analysis</label>
                    <textarea class="research-notes-input" id="researchNotesInput" placeholder="Add your own notes, key takeaways, follow-up items...">${data.notes || ''}</textarea>
                </div>
            `;
            
            renderResearchCategoriesSidebar();
        }
        
        async function runCurrentCatResearch() {
            if (!currentResearchCat) return;
            
            const query = document.getElementById('researchQueryInput')?.value;
            if (!query) return;
            
            const resultsBox = document.getElementById('researchResultsBox');
            resultsBox.innerHTML = '<div style="text-align:center;padding:2rem;"><div class="press-sending-spinner" style="margin:0 auto 1rem;"></div>Researching...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/ai/research`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query,
                        partner: {
                            name: researchHubPartner.recipientName,
                            organization: researchHubPartner.organizationName || researchHubPartner.universityName,
                            type: researchHubPartner.recipientType
                        }
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.content) {
                    resultsBox.textContent = result.content;
                    
                    // Auto-save
                    partnerResearchData[currentResearchCat] = {
                        query,
                        content: result.content,
                        notes: document.getElementById('researchNotesInput')?.value || '',
                        timestamp: new Date().toISOString()
                    };
                    
                    saveResearchToLocal();
                    saveResearchToServer();
                    renderResearchCategoriesSidebar();
                    updateResearchProgress();
                } else {
                    resultsBox.innerHTML = '<div style="color:var(--error);text-align:center;padding:2rem;">Research failed. Please try again.</div>';
                }
            } catch (error) {
                console.error('Research error:', error);
                resultsBox.innerHTML = '<div style="color:var(--error);text-align:center;padding:2rem;">Error connecting to server.</div>';
            }
        }
        
        function saveCurrentCatResearch() {
            if (!currentResearchCat) return;
            
            const resultsBox = document.getElementById('researchResultsBox');
            const content = resultsBox?.textContent || '';
            
            partnerResearchData[currentResearchCat] = {
                query: document.getElementById('researchQueryInput')?.value || '',
                content: content.includes('Click "Run Research"') ? '' : content,
                notes: document.getElementById('researchNotesInput')?.value || '',
                timestamp: new Date().toISOString()
            };
            
            saveResearchToLocal();
            saveResearchToServer();
            renderResearchCategoriesSidebar();
            updateResearchProgress();
            
            // Visual feedback
            const saveBtn = document.getElementById('saveResearchBtn');
            const origText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color:var(--success);"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Saved!';
            setTimeout(() => { saveBtn.innerHTML = origText; }, 1500);
        }
        
        async function runAllPartnerResearch() {
            for (const cat of RESEARCH_CATEGORIES) {
                if (!partnerResearchData[cat.id]?.content) {
                    selectResearchCategory(cat.id);
                    await new Promise(r => setTimeout(r, 300)); // Let UI update
                    await runCurrentCatResearch();
                    await new Promise(r => setTimeout(r, 1000)); // Rate limiting
                }
            }
        }
        
        // ===== PROPOSAL GENERATION FROM RESEARCH =====
        
        let currentProposalData = null;
        let proposalSidenotes = [];
        let signatureData = { luminary: null, partner: null };
        
        function openProposalFromResearch() {
            const completed = RESEARCH_CATEGORIES.filter(cat => {
                const data = partnerResearchData[cat.id];
                return data && data.content && data.content.length > 50;
            });
            
            if (completed.length < 3) {
                alert('Please complete at least 3 research categories before generating a proposal.');
                return;
            }
            
            closeResearchHub();
            openProposalWizard();
        }
        
        // ===== DOCUMENT REVIEW WITH SIDENOTES =====
        
        function openDocReview(proposalContent) {
            const orgName = currentPartner?.organizationName || currentPartner?.universityName || 'Partner';
            document.getElementById('docReviewPartner').textContent = orgName;
            
            // Generate document HTML
            renderProposalDocument(proposalContent || currentProposalData);
            
            // Load sidenotes
            loadProposalSidenotes();
            
            document.getElementById('docReview').classList.add('active');
            
            // Initialize signatures after DOM is ready
            setTimeout(() => initSignatureCapture(), 100);
        }
        
        function closeDocReview() {
            document.getElementById('docReview').classList.remove('active');
        }
        
        function renderProposalDocument(data) {
            const orgName = currentPartner?.organizationName || currentPartner?.universityName || 'Partner Organization';
            const config = data?.config || proposalConfig;
            
            // Get payment pathway from research
            const paymentPathway = partnerResearchData.payment_pathway?.content || '';
            const taxBenefits = partnerResearchData.tax_benefits?.content || '';
            
            document.getElementById('docPaperContent').innerHTML = `
                <div class="doc-logo">
                    <div class="doc-logo-text">LUMINARY</div>
                    <div class="doc-logo-sub">Partnership Proposal</div>
                </div>
                
                <h1>Partnership Agreement</h1>
                
                <p><strong>Between:</strong> Luminary AI Technologies Inc. ("Luminary")<br>
                <strong>And:</strong> ${escapeHtml(orgName)} ("Partner")<br>
                <strong>Date:</strong> ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                
                <h2>1. Overview</h2>
                <p>This agreement establishes a partnership between Luminary AI Technologies and ${escapeHtml(orgName)} for access to Luminary's AI-powered intelligence platforms.</p>
                
                <h2>2. Investment & Terms</h2>
                <table>
                    <tr><th style="width:40%;">Annual Investment</th><td>$${(config.amount || 15000).toLocaleString()}</td></tr>
                    <tr><th>Term Length</th><td>${config.term || 24} months</td></tr>
                    <tr><th>Platform Access</th><td>${getPlatformDisplayName(config.platform)}</td></tr>
                    <tr><th>User Seats</th><td>${config.seats || 10}</td></tr>
                    <tr><th>Start Date</th><td>Upon execution</td></tr>
                </table>
                
                <div class="payment-pathway">
                    <h3> Investment Rationale & Payment Pathway</h3>
                    ${config.rationale ? `<p style="margin-bottom:1rem;">${escapeHtml(config.rationale)}</p>` : ''}
                    <div class="pathway-item">
                        <div class="pathway-num">1</div>
                        <div class="pathway-text"><strong>Suggested Budget Source:</strong> ${extractBudgetSource(paymentPathway) || 'Technology/Innovation Budget, Departmental Allocation, or Grant Funding'}</div>
                    </div>
                    <div class="pathway-item">
                        <div class="pathway-num">2</div>
                        <div class="pathway-text"><strong>Approval Process:</strong> ${extractApprovalProcess(paymentPathway) || 'Department Head  Procurement  Finance/Administration'}</div>
                    </div>
                    <div class="pathway-item">
                        <div class="pathway-num">3</div>
                        <div class="pathway-text"><strong>Payment Options:</strong> Annual billing, or quarterly installments available upon request</div>
                    </div>
                    ${taxBenefits ? `<div class="pathway-item">
                        <div class="pathway-num">4</div>
                        <div class="pathway-text"><strong>Tax Considerations:</strong> ${extractTaxBenefit(taxBenefits)}</div>
                    </div>` : ''}
                </div>
                
                <h2>3. Deliverables</h2>
                <ul style="margin-left: 1.5rem;">
                    <li>Full access to ${getPlatformDisplayName(config.platform)}</li>
                    <li>${config.seats || 10} user seats with administrative controls</li>
                    <li>Dedicated onboarding and training sessions</li>
                    <li>Priority technical support (response within 24 hours)</li>
                    <li>Quarterly business reviews and optimization sessions</li>
                    ${config.deliverables ? config.deliverables.split('\n').filter(d => d.trim()).map(d => `<li>${escapeHtml(d.trim())}</li>`).join('') : ''}
                </ul>
                
                <h2>4. Terms & Conditions</h2>
                <p>This agreement shall commence upon execution by both parties and continue for the specified term. Either party may terminate with 30 days written notice. Luminary guarantees platform availability of 99.5% uptime. All data remains property of Partner and is handled in accordance with applicable privacy regulations.</p>
                
                <h2>5. About Luminary</h2>
                <p>Luminary AI Technologies builds intelligent infrastructure for complex operations. Our mission is "for the people, not power"  making sophisticated tools accessible to organizations of all sizes. We are independently funded with no institutional investors, ensuring our decisions serve our partners, not shareholders.</p>
                
                <div class="sig-section">
                    <h2>6. Signatures</h2>
                    <p>By signing below, both parties agree to the terms outlined in this agreement.</p>
                    
                    <div class="sig-grid">
                        <div class="sig-party">
                            <div class="sig-party-title">For Luminary AI Technologies</div>
                            <div class="sig-canvas-wrap" id="luminarySigWrap">
                                <canvas class="sig-canvas" id="luminarySigCanvas"></canvas>
                            </div>
                            <div class="sig-actions">
                                <button onclick="clearSig('luminary')">Clear</button>
                                <button class="sign-btn" onclick="confirmSig('luminary')">Sign</button>
                            </div>
                            <div class="sig-info">
                                <input type="text" id="luminarySignerName" placeholder="Printed Name" value="Ben Hizer">
                                <input type="text" id="luminarySignerTitle" placeholder="Title" value="Founder & CEO">
                            </div>
                            <div class="sig-date">Date: <span id="luminarySigDate">_____________</span></div>
                            <div class="sig-status pending" id="luminarySigStatus"> Awaiting Signature</div>
                        </div>
                        
                        <div class="sig-party">
                            <div class="sig-party-title">For ${escapeHtml(orgName)}</div>
                            <div class="sig-canvas-wrap" id="partnerSigWrap">
                                <canvas class="sig-canvas" id="partnerSigCanvas"></canvas>
                            </div>
                            <div class="sig-actions">
                                <button onclick="clearSig('partner')">Clear</button>
                                <button class="sign-btn" onclick="confirmSig('partner')">Sign</button>
                            </div>
                            <div class="sig-info">
                                <input type="text" id="partnerSignerName" placeholder="Printed Name">
                                <input type="text" id="partnerSignerTitle" placeholder="Title">
                            </div>
                            <div class="sig-date">Date: <span id="partnerSigDate">_____________</span></div>
                            <div class="sig-status pending" id="partnerSigStatus"> Awaiting Signature</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function getPlatformDisplayName(platform) {
            const names = {
                vestiq: 'Vestiq (Financial Markets Intelligence)',
                bluehaven: 'Blue Haven (E-Commerce & Marketplace Intelligence)',
                legalinsights: 'Legal Insights (Policy & Regulatory Intelligence)',
                all: 'Full Platform Suite (Vestiq, Blue Haven, Legal Insights)'
            };
            return names[platform] || 'Vestiq (Financial Markets Intelligence)';
        }
        
        function extractBudgetSource(text) {
            if (!text) return null;
            // Simple extraction - in production would be smarter
            const lower = text.toLowerCase();
            if (lower.includes('technology fund')) return 'Technology Innovation Fund';
            if (lower.includes('grant')) return 'Grant Funding or Departmental Budget';
            if (lower.includes('endowment')) return 'Endowment or Institutional Funds';
            return null;
        }
        
        function extractApprovalProcess(text) {
            if (!text) return null;
            return null; // Would extract from research
        }
        
        function extractTaxBenefit(text) {
            if (!text || text.length < 20) return null;
            // Return first 200 chars as summary
            return text.substring(0, 200) + (text.length > 200 ? '...' : '');
        }
        
        // ===== SIGNATURE CAPTURE =====
        
        let sigContexts = {};
        let isDrawingSig = false;
        let currentSigParty = null;
        
        function initSignatureCapture() {
            ['luminary', 'partner'].forEach(party => {
                const canvas = document.getElementById(party + 'SigCanvas');
                if (!canvas) return;
                
                // Set canvas size
                const rect = canvas.parentElement.getBoundingClientRect();
                canvas.width = rect.width - 24; // Padding
                canvas.height = 100;
                
                const ctx = canvas.getContext('2d');
                ctx.strokeStyle = '#1a1a1a';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                sigContexts[party] = ctx;
                
                // Events
                canvas.addEventListener('mousedown', (e) => startSig(e, party));
                canvas.addEventListener('mousemove', (e) => drawSig(e, party));
                canvas.addEventListener('mouseup', () => endSig());
                canvas.addEventListener('mouseout', () => endSig());
                
                // Touch
                canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startSig(e.touches[0], party); });
                canvas.addEventListener('touchmove', (e) => { e.preventDefault(); drawSig(e.touches[0], party); });
                canvas.addEventListener('touchend', () => endSig());
            });
        }
        
        function startSig(e, party) {
            isDrawingSig = true;
            currentSigParty = party;
            const canvas = document.getElementById(party + 'SigCanvas');
            const rect = canvas.getBoundingClientRect();
            const ctx = sigContexts[party];
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }
        
        function drawSig(e, party) {
            if (!isDrawingSig || currentSigParty !== party) return;
            const canvas = document.getElementById(party + 'SigCanvas');
            const rect = canvas.getBoundingClientRect();
            const ctx = sigContexts[party];
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.stroke();
        }
        
        function endSig() {
            isDrawingSig = false;
            currentSigParty = null;
        }
        
        function clearSig(party) {
            const canvas = document.getElementById(party + 'SigCanvas');
            const ctx = sigContexts[party];
            if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            signatureData[party] = null;
            document.getElementById(party + 'SigWrap').classList.remove('signed');
            document.getElementById(party + 'SigDate').textContent = '_____________';
            document.getElementById(party + 'SigStatus').innerHTML = ' Awaiting Signature';
            document.getElementById(party + 'SigStatus').className = 'sig-status pending';
            
            updateDocStatus();
        }
        
        function confirmSig(party) {
            const canvas = document.getElementById(party + 'SigCanvas');
            const name = document.getElementById(party + 'SignerName').value;
            
            if (!name) {
                alert('Please enter the signer\'s name');
                return;
            }
            
            // Check if canvas has content
            const ctx = sigContexts[party];
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const hasContent = imageData.data.some((val, i) => i % 4 === 3 && val > 0);
            
            if (!hasContent) {
                alert('Please draw your signature on the canvas');
                return;
            }
            
            signatureData[party] = {
                image: canvas.toDataURL(),
                name: name,
                title: document.getElementById(party + 'SignerTitle').value,
                date: new Date().toISOString()
            };
            
            const dateStr = new Date().toLocaleDateString();
            document.getElementById(party + 'SigWrap').classList.add('signed');
            document.getElementById(party + 'SigDate').textContent = dateStr;
            document.getElementById(party + 'SigStatus').innerHTML = ' Signed';
            document.getElementById(party + 'SigStatus').className = 'sig-status signed';
            
            // Disable canvas
            canvas.classList.add('disabled');
            
            updateDocStatus();
            saveProposalSignature(party);
        }
        
        function updateDocStatus() {
            const badge = document.getElementById('docStatusBadge');
            if (signatureData.luminary && signatureData.partner) {
                badge.textContent = 'Fully Executed';
                badge.className = 'doc-status-badge signed';
            } else if (signatureData.luminary || signatureData.partner) {
                badge.textContent = 'Partially Signed';
                badge.className = 'doc-status-badge pending';
            } else {
                badge.textContent = 'Draft';
                badge.className = 'doc-status-badge draft';
            }
        }
        
        async function saveProposalSignature(party) {
            const partnerId = currentPartner?._id || currentPartner?.id;
            if (!partnerId) return;
            
            try {
                await fetch(`${API_BASE}/api/admin/proposals/${partnerId}/signature`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        party,
                        signature: signatureData[party]
                    })
                });
            } catch (e) {
                console.error('Save signature error:', e);
            }
        }
        
        // ===== SIDENOTES =====
        
        function loadProposalSidenotes() {
            // In production, fetch from server
            proposalSidenotes = [];
            renderSidenotes();
        }
        
        function renderSidenotes() {
            const container = document.getElementById('sidenotesList');
            const count = document.getElementById('sidenotesCount');
            
            count.textContent = proposalSidenotes.length;
            
            if (proposalSidenotes.length === 0) {
                container.innerHTML = '<div class="sidenotes-empty">No notes yet.<br>Add a note to start the discussion.</div>';
                return;
            }
            
            container.innerHTML = proposalSidenotes.map(note => `
                <div class="sidenote from-${note.from}">
                    <div class="sidenote-header">
                        <span class="sidenote-author">${note.from === 'luminary' ? 'Luminary' : 'Partner'}</span>
                        <span class="sidenote-time">${formatTimeAgo(note.timestamp)}</span>
                    </div>
                    <div class="sidenote-content">${escapeHtml(note.content)}</div>
                    ${note.section ? `<div class="sidenote-section">${note.section}</div>` : ''}
                </div>
            `).join('');
            
            container.scrollTop = container.scrollHeight;
        }
        
        function addSidenote() {
            const input = document.getElementById('sidenoteInput');
            const section = document.getElementById('sidenoteSectionSelect').value;
            const content = input.value.trim();
            
            if (!content) return;
            
            proposalSidenotes.push({
                id: Date.now(),
                from: 'luminary',
                content,
                section: section ? section.charAt(0).toUpperCase() + section.slice(1) : '',
                timestamp: new Date().toISOString()
            });
            
            input.value = '';
            renderSidenotes();
            
            // Save to server
            saveSidenotesToServer();
        }
        
        async function saveSidenotesToServer() {
            const partnerId = currentPartner?._id || currentPartner?.id;
            if (!partnerId) return;
            
            try {
                await fetch(`${API_BASE}/api/admin/proposals/${partnerId}/sidenotes`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ sidenotes: proposalSidenotes })
                });
            } catch (e) {
                console.error('Save sidenotes error:', e);
            }
        }
        
        function formatTimeAgo(timestamp) {
            const seconds = Math.floor((new Date() - new Date(timestamp)) / 1000);
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            return new Date(timestamp).toLocaleDateString();
        }
        
        // ===== DOWNLOAD & SEND =====
        
        async function downloadProposalDocx() {
            alert('Downloading proposal... (DOCX generation in progress)');
            // In production, call server endpoint to generate DOCX
        }
        
        async function sendProposalToPartner() {
            const partnerId = currentPartner?._id || currentPartner?.id;
            if (!partnerId) return;
            
            const docContent = document.getElementById('docPaperContent').innerText;
            
            try {
                await fetch(`${API_BASE}/api/admin/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        partnerId,
                        content: ' **Partnership Proposal Attached**\n\nPlease review the attached proposal. You can add comments using the sidenotes feature, and sign electronically when ready.\n\n[View Proposal]',
                        fromLuminary: true
                    })
                });
                
                alert('Proposal sent to partner channel!');
            } catch (e) {
                console.error('Send error:', e);
                alert('Error sending proposal.');
            }
        }

        // ===== RESEARCH HUB =====
        
        const RESEARCH_CATEGORIES = [
            {
                id: 'background',
                title: 'Organization Background',
                icon: '',
                description: 'Mission, size, market position, recent accomplishments',
                defaultQuery: 'Research {organization}: What are they known for? What is their mission statement, organizational size, market position, and notable recent accomplishments or news?'
            },
            {
                id: 'leadership',
                title: 'Key Decision Makers',
                icon: '',
                description: 'Leadership contacts for technology/innovation partnerships',
                defaultQuery: 'Who are the key decision makers at {organization} who would be involved in technology or innovation partnerships? Find names, titles, backgrounds, and any public contact information for relevant leadership.'
            },
            {
                id: 'tech_contracts',
                title: 'Active Technology Contracts',
                icon: '',
                description: 'Current vendors, platforms, and technology partnerships',
                defaultQuery: 'What technology vendors, software platforms, data services, or technology partnerships does {organization} currently have? Look for press releases about partnerships, job postings mentioning specific tools, and any public procurement records.'
            },
            {
                id: 'partnership_rules',
                title: 'Partnership Requirements',
                icon: '',
                description: 'Procurement policies, vendor requirements, RFP processes',
                defaultQuery: 'What are {organization}\'s requirements, rules, or formal processes for vendor or partnership agreements? Search for their procurement policies, RFP requirements, vendor registration processes, and any compliance requirements for new partners.'
            },
            {
                id: 'budget_funding',
                title: 'Budget & Funding Sources',
                icon: '',
                description: 'Financial capacity, grants, endowments, funding cycles',
                defaultQuery: 'What is {organization}\'s budget capacity for technology investments? Look for annual budget information, technology spending data, available grants, endowment size, and typical budget cycles for new initiatives.'
            },
            {
                id: 'payment_pathway',
                title: 'Payment Pathway',
                icon: '',
                description: 'How they fund initiatives, approval chains, fiscal calendars',
                defaultQuery: 'How does {organization} typically fund and approve new technology initiatives? What is their fiscal year calendar? Who approves purchases at various thresholds? Are there specific innovation funds or grants available internally?'
            },
            {
                id: 'tax_benefits',
                title: 'Tax Benefits & Incentives',
                icon: '',
                description: 'Tax credits, educational deductions, R&D incentives',
                defaultQuery: 'What tax benefits, incentives, or deductions might {organization} (located in {location}) receive for technology investments or educational/research partnerships? Research relevant state and federal programs, R&D tax credits, and educational technology incentives.'
            },
            {
                id: 'competitive',
                title: 'Competitive Intelligence',
                icon: '',
                description: 'Peer institutions, competitive pressures, industry position',
                defaultQuery: 'Who are {organization}\'s peer institutions or competitors? How do they compare in technology adoption? What competitive pressures or industry trends might motivate their investment in AI and data intelligence tools?'
            }
        ];
        
        let researchPartner = null;
        let currentResearchCategory = null;
        let partnerResearch = {};
        
        function openResearchHub() {
            if (!currentPartner) {
                alert('Please select a partner first');
                return;
            }
            
            researchPartner = currentPartner;
            const orgName = researchPartner.organizationName || researchPartner.universityName || researchPartner.recipientName;
            const partnerType = researchPartner.recipientType === 'media' ? 'Media Outlet' : 'University / Institution';
            
            document.getElementById('researchPartnerName').textContent = orgName;
            document.getElementById('researchPartnerType').textContent = partnerType;
            
            // Reset state
            currentResearchCategory = null;
            partnerResearch = {};
            
            // Load existing research for this partner
            loadPartnerResearch();
            
            // Render categories
            renderResearchCategories();
            
            // Reset main content
            document.getElementById('researchToolbar').style.display = 'none';
            document.getElementById('researchContent').innerHTML = `
                <div class="research-empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                    <h3>Select a Research Category</h3>
                    <p>Choose a category from the left to begin gathering intelligence about this partner.</p>
                </div>
            `;
            
            document.getElementById('researchHub').classList.add('active');
        }
        
        function closeResearchHub() {
            document.getElementById('researchHub').classList.remove('active');
        }
        
        async function loadPartnerResearch() {
            const partnerId = researchPartner._id || researchPartner.id;
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/partners/${partnerId}/research`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    partnerResearch = data.research || {};
                }
            } catch (error) {
                console.log('Could not load existing research:', error);
                // Try local storage fallback
                const cached = localStorage.getItem('research_' + partnerId);
                if (cached) {
                    partnerResearch = JSON.parse(cached);
                }
            }
            
            updateResearchProgress();
            renderResearchCategories();
        }
        
        function updateResearchProgress() {
            const completed = Object.keys(partnerResearch).filter(k => partnerResearch[k]?.content).length;
            const total = RESEARCH_CATEGORIES.length;
            const percent = Math.round((completed / total) * 100);
            
            document.getElementById('researchProgressText').textContent = `${completed} / ${total}`;
            document.getElementById('researchProgressFill').style.width = `${percent}%`;
            
            // Enable/disable proceed button
            const proceedBtn = document.getElementById('proceedToProposalBtn');
            if (completed >= 2) {
                proceedBtn.disabled = false;
                proceedBtn.title = '';
            } else {
                proceedBtn.disabled = true;
                proceedBtn.title = 'Complete at least 2 research categories';
            }
        }
        
        function renderResearchCategories() {
            const container = document.getElementById('researchCategories');
            
            container.innerHTML = RESEARCH_CATEGORIES.map(cat => {
                const hasData = partnerResearch[cat.id]?.content;
                const isActive = currentResearchCategory === cat.id;
                
                return `
                    <div class="research-category ${hasData ? 'has-data' : ''} ${isActive ? 'active' : ''}" 
                         onclick="selectResearchCategory('${cat.id}')">
                        <div class="research-category-icon">${cat.icon}</div>
                        <div class="research-category-title">${escapeHtml(cat.title)}</div>
                        <div class="research-category-desc">${escapeHtml(cat.description)}</div>
                    </div>
                `;
            }).join('');
        }
        
        function selectResearchCategory(categoryId) {
            currentResearchCategory = categoryId;
            const category = RESEARCH_CATEGORIES.find(c => c.id === categoryId);
            
            if (!category) return;
            
            const orgName = researchPartner.organizationName || researchPartner.universityName || researchPartner.recipientName;
            const location = researchPartner.location || researchPartner.state || 'United States';
            const defaultQuery = category.defaultQuery
                .replace(/{organization}/g, orgName)
                .replace(/{location}/g, location);
            
            const existingData = partnerResearch[categoryId] || {};
            
            // Show toolbar
            document.getElementById('researchToolbar').style.display = 'flex';
            document.getElementById('researchCategoryIcon').textContent = category.icon;
            document.getElementById('researchCategoryTitle').textContent = category.title;
            
            // Render content area
            document.getElementById('researchContent').innerHTML = `
                <div class="research-query-section">
                    <div class="research-query-label">
                        <label>Research Query</label>
                        <button onclick="resetQueryToDefault('${categoryId}')">Reset to default</button>
                    </div>
                    <textarea class="research-query-input" id="researchQueryInput" placeholder="Enter your research query...">${escapeHtml(existingData.query || defaultQuery)}</textarea>
                </div>
                
                <div class="research-results-section">
                    <div class="research-results-header">
                        <span class="research-results-title">Research Results</span>
                        <span class="research-results-meta" id="researchResultsMeta">
                            ${existingData.timestamp ? 'Last updated: ' + new Date(existingData.timestamp).toLocaleDateString() : 'Not yet researched'}
                        </span>
                    </div>
                    <div class="research-results-content" id="researchResultsContent">
                        ${existingData.content || `
                            <div class="research-results-placeholder">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                                <p>Click "Run Research" to gather intelligence</p>
                            </div>
                        `}
                    </div>
                </div>
                
                <div class="research-notes-section">
                    <div class="research-notes-header">
                        <span class="research-notes-title">Your Notes & Insights</span>
                    </div>
                    <div class="research-notes-content">
                        <textarea class="research-notes-input" id="researchNotesInput" placeholder="Add your own notes, interpretations, follow-up items, or key takeaways...">${escapeHtml(existingData.notes || '')}</textarea>
                    </div>
                </div>
            `;
            
            renderResearchCategories();
        }
        
        function resetQueryToDefault(categoryId) {
            const category = RESEARCH_CATEGORIES.find(c => c.id === categoryId);
            if (!category) return;
            
            const orgName = researchPartner.organizationName || researchPartner.universityName || researchPartner.recipientName;
            const location = researchPartner.location || researchPartner.state || 'United States';
            const defaultQuery = category.defaultQuery
                .replace(/{organization}/g, orgName)
                .replace(/{location}/g, location);
            
            document.getElementById('researchQueryInput').value = defaultQuery;
        }
        
        async function runCurrentResearch() {
            if (!currentResearchCategory) {
                alert('Please select a research category first');
                return;
            }
            
            const query = document.getElementById('researchQueryInput')?.value;
            if (!query) {
                alert('Please enter a research query');
                return;
            }
            
            const resultsEl = document.getElementById('researchResultsContent');
            const runBtn = document.getElementById('runResearchBtn');
            
            // Show loading state
            runBtn.disabled = true;
            runBtn.innerHTML = '<div class="press-sending-spinner" style="width:16px;height:16px;"></div> Researching...';
            resultsEl.innerHTML = `
                <div class="research-loading">
                    <div class="press-sending-spinner"></div>
                    <p style="margin-top: 1rem; color: var(--text-muted);">Gathering intelligence...</p>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/ai/research`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query,
                        partner: {
                            name: researchPartner.recipientName,
                            organization: researchPartner.organizationName || researchPartner.universityName,
                            type: researchPartner.recipientType
                        }
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.content) {
                    resultsEl.textContent = result.content;
                    document.getElementById('researchResultsMeta').textContent = 'Last updated: ' + new Date().toLocaleDateString();
                    
                    // Auto-save
                    partnerResearch[currentResearchCategory] = {
                        query,
                        content: result.content,
                        notes: document.getElementById('researchNotesInput')?.value || '',
                        timestamp: new Date().toISOString()
                    };
                    
                    updateResearchProgress();
                    renderResearchCategories();
                } else {
                    resultsEl.innerHTML = `
                        <div class="research-results-placeholder" style="color: var(--error);">
                            <p>Research failed. Please try again.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Research error:', error);
                resultsEl.innerHTML = `
                    <div class="research-results-placeholder" style="color: var(--error);">
                        <p>Error connecting to server. Please try again.</p>
                    </div>
                `;
            }
            
            // Reset button
            runBtn.disabled = false;
            runBtn.innerHTML = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg> Run Research';
        }
        
        async function saveCurrentResearch() {
            if (!currentResearchCategory) return;
            
            const query = document.getElementById('researchQueryInput')?.value || '';
            const content = document.getElementById('researchResultsContent')?.textContent || '';
            const notes = document.getElementById('researchNotesInput')?.value || '';
            
            // Skip if no content
            if (!content || content.includes('Click "Run Research"')) {
                alert('No research results to save. Run research first.');
                return;
            }
            
            partnerResearch[currentResearchCategory] = {
                query,
                content,
                notes,
                timestamp: new Date().toISOString()
            };
            
            // Save to server
            await saveResearchToServer();
            
            // Save to local storage as backup
            const partnerId = researchPartner._id || researchPartner.id;
            localStorage.setItem('research_' + partnerId, JSON.stringify(partnerResearch));
            
            updateResearchProgress();
            renderResearchCategories();
            showResearchSaveIndicator();
        }
        
        async function saveResearchToServer() {
            const partnerId = researchPartner._id || researchPartner.id;
            
            try {
                await fetch(`${API_BASE}/api/admin/partners/${partnerId}/research`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ research: partnerResearch })
                });
            } catch (error) {
                console.error('Save research error:', error);
            }
        }
        
        function showResearchSaveIndicator() {
            const indicator = document.getElementById('researchSaveIndicator');
            indicator.classList.add('visible');
            setTimeout(() => {
                indicator.classList.remove('visible');
            }, 2000);
        }
        
        async function runAllResearchSequential() {
            const orgName = researchPartner.organizationName || researchPartner.universityName || researchPartner.recipientName;
            
            if (!confirm(`This will run all 8 research queries for "${orgName}". This may take a few minutes. Continue?`)) {
                return;
            }
            
            for (const category of RESEARCH_CATEGORIES) {
                // Skip if already has data
                if (partnerResearch[category.id]?.content) {
                    continue;
                }
                
                // Select category
                selectResearchCategory(category.id);
                
                // Small delay for UI update
                await new Promise(r => setTimeout(r, 300));
                
                // Run research
                await runCurrentResearch();
                
                // Save
                await saveCurrentResearch();
                
                // Delay between requests
                await new Promise(r => setTimeout(r, 1000));
            }
            
            alert('All research complete!');
        }
        
        function proceedToProposal() {
            const completed = Object.keys(partnerResearch).filter(k => partnerResearch[k]?.content).length;
            
            if (completed < 2) {
                alert('Please complete at least 2 research categories before proceeding.');
                return;
            }
            
            closeResearchHub();
            // Will open proposal builder in Phase 2
            openProposalWizard();
        }

        // ===== PROPOSAL WIZARD =====
        
        let wizardStep = 1;
        let wizardPartner = null;
        let wizardResearch = {};
        let generatedProposal = '';
        let proposalConfig = {
            tier: 'partner',
            amount: 15000,
            term: 24,
            paymentSchedule: 'quarterly',
            platform: 'vestiq',
            seats: 10,
            deliverables: '',
            rationale: '',
            paymentPathway: ''
        };
        
        async function openProposalWizard() {
            if (!currentPartner) {
                alert('Please select a partner first');
                return;
            }
            
            wizardPartner = currentPartner;
            wizardStep = 1;
            generatedProposal = '';
            
            const orgName = wizardPartner.organizationName || wizardPartner.universityName || wizardPartner.recipientName;
            document.getElementById('wizardPartnerName').textContent = `Proposal: ${orgName}`;
            
            // Load stored research for this partner
            await loadWizardResearch();
            
            // Reset UI
            updateWizardSteps();
            showWizardStep(1);
            
            document.getElementById('proposalWizard').classList.add('active');
        }
        
        function closeProposalWizard() {
            document.getElementById('proposalWizard').classList.remove('active');
        }
        
        async function loadWizardResearch() {
            const partnerId = wizardPartner._id || wizardPartner.id;
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/partners/${partnerId}/research`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    wizardResearch = data.research || {};
                }
            } catch (error) {
                console.log('Could not load research:', error);
                const cached = localStorage.getItem('research_' + partnerId);
                if (cached) {
                    wizardResearch = JSON.parse(cached);
                }
            }
            
            renderResearchSummary();
        }
        
        function renderResearchSummary() {
            const grid = document.getElementById('researchSummaryGrid');
            const actionsEl = document.getElementById('researchSummaryActions');
            
            const categories = [
                { id: 'background', title: 'Organization Background', icon: '' },
                { id: 'leadership', title: 'Key Decision Makers', icon: '' },
                { id: 'tech_contracts', title: 'Active Tech Contracts', icon: '' },
                { id: 'partnership_rules', title: 'Partnership Requirements', icon: '' },
                { id: 'budget_funding', title: 'Budget & Funding', icon: '' },
                { id: 'payment_pathway', title: 'Payment Pathway', icon: '' },
                { id: 'tax_benefits', title: 'Tax Benefits', icon: '' },
                { id: 'competitive', title: 'Competitive Intel', icon: '' }
            ];
            
            let completedCount = 0;
            
            grid.innerHTML = categories.map(cat => {
                const data = wizardResearch[cat.id];
                const hasData = data && data.content;
                if (hasData) completedCount++;
                
                return `
                    <div class="research-summary-card ${hasData ? 'has-data' : 'no-data'}">
                        <div class="research-summary-card-header">
                            <div class="research-summary-card-title">
                                <span class="icon">${cat.icon}</span>
                                ${escapeHtml(cat.title)}
                            </div>
                            <span class="research-summary-card-status ${hasData ? 'complete' : 'missing'}">
                                ${hasData ? ' Complete' : 'Missing'}
                            </span>
                        </div>
                        <div class="research-summary-card-preview">
                            ${hasData ? escapeHtml(data.content.substring(0, 150)) + '...' : 'No research data collected yet.'}
                        </div>
                    </div>
                `;
            }).join('');
            
            if (completedCount < 3) {
                actionsEl.innerHTML = `
                    <p>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                        Only ${completedCount} of 8 categories complete. More research recommended.
                    </p>
                    <button class="press-btn secondary" onclick="closeProposalWizard(); openResearchHub();">
                        Open Research Hub
                    </button>
                `;
                actionsEl.style.display = 'flex';
            } else {
                actionsEl.style.display = 'none';
            }
        }
        
        function updateWizardSteps() {
            document.querySelectorAll('.wizard-step').forEach(step => {
                const stepNum = parseInt(step.dataset.step);
                step.classList.remove('active', 'completed');
                if (stepNum === wizardStep) {
                    step.classList.add('active');
                } else if (stepNum < wizardStep) {
                    step.classList.add('completed');
                }
            });
        }
        
        function showWizardStep(step) {
            wizardStep = step;
            updateWizardSteps();
            
            for (let i = 1; i <= 4; i++) {
                const el = document.getElementById(`wizardStep${i}`);
                if (el) el.style.display = 'none';
            }
            
            const currentEl = document.getElementById(`wizardStep${step}`);
            if (currentEl) currentEl.style.display = 'block';
            
            document.getElementById('wizardBackBtn').style.visibility = step > 1 ? 'visible' : 'hidden';
            
            const nextBtn = document.getElementById('wizardNextBtn');
            if (step === 4) {
                nextBtn.innerHTML = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Done';
            } else if (step === 3) {
                nextBtn.innerHTML = 'Generate Proposal <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>';
            } else {
                nextBtn.innerHTML = 'Next <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>';
            }
            
            if (step === 4) {
                generateFinalProposal();
            }
        }
        
        function wizardNext() {
            if (wizardStep === 2) {
                proposalConfig.amount = parseInt(document.getElementById('proposalAmount').value) || 15000;
                proposalConfig.term = parseInt(document.getElementById('proposalTerm').value) || 24;
                proposalConfig.paymentSchedule = document.getElementById('proposalPaymentSchedule').value;
                proposalConfig.platform = document.getElementById('proposalPlatform').value;
                proposalConfig.seats = parseInt(document.getElementById('proposalSeats').value) || 10;
                proposalConfig.deliverables = document.getElementById('proposalDeliverables').value;
            } else if (wizardStep === 3) {
                proposalConfig.rationale = document.getElementById('proposalRationale').value;
                proposalConfig.paymentPathway = document.getElementById('proposalPaymentPathway').value;
            } else if (wizardStep === 4) {
                closeProposalWizard();
                return;
            }
            
            if (wizardStep < 4) {
                showWizardStep(wizardStep + 1);
            }
        }
        
        function wizardBack() {
            if (wizardStep > 1) {
                showWizardStep(wizardStep - 1);
            }
        }
        
        function selectTier(tier) {
            proposalConfig.tier = tier;
            const amounts = { explorer: 5000, partner: 15000, enterprise: 50000 };
            proposalConfig.amount = amounts[tier];
            document.getElementById('proposalAmount').value = amounts[tier];
            
            document.querySelectorAll('.tier-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.tier === tier);
            });
        }
        
        async function generateInvestmentRationale() {
            const btn = event.target.closest('button');
            btn.disabled = true;
            btn.innerHTML = '<div class="press-sending-spinner" style="width:14px;height:14px;"></div> Generating...';
            
            const amount = document.getElementById('proposalAmount').value || proposalConfig.amount;
            const platform = document.getElementById('proposalPlatform').value || proposalConfig.platform;
            const seats = document.getElementById('proposalSeats').value || proposalConfig.seats;
            const term = document.getElementById('proposalTerm').value || proposalConfig.term;
            
            const platformNames = {
                vestiq: 'Vestiq (Financial Markets Intelligence)',
                bluehaven: 'Blue Haven (E-Commerce & Marketplace)',
                legalinsights: 'Legal Insights (Policy & Regulatory)',
                all: 'Full Platform Suite'
            };
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/ai/generate-rationale`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        partner: {
                            name: wizardPartner.recipientName,
                            organization: wizardPartner.organizationName || wizardPartner.universityName,
                            type: wizardPartner.recipientType
                        },
                        terms: {
                            amount: parseInt(amount),
                            platform: platformNames[platform],
                            seats: parseInt(seats),
                            term: parseInt(term),
                            tier: proposalConfig.tier
                        },
                        research: wizardResearch
                    })
                });
                
                const result = await response.json();
                if (response.ok && result.rationale) {
                    document.getElementById('proposalRationale').value = result.rationale;
                }
            } catch (error) {
                console.error('Generate rationale error:', error);
            }
            
            btn.disabled = false;
            btn.innerHTML = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> Generate with AI';
        }
        
        async function generatePaymentPathway() {
            const btn = event.target.closest('button');
            btn.disabled = true;
            btn.innerHTML = '<div class="press-sending-spinner" style="width:14px;height:14px;"></div> Generating...';
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/ai/generate-pathway`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        partner: {
                            name: wizardPartner.recipientName,
                            organization: wizardPartner.organizationName || wizardPartner.universityName,
                            type: wizardPartner.recipientType,
                            location: wizardPartner.location || wizardPartner.state
                        },
                        research: wizardResearch,
                        amount: proposalConfig.amount
                    })
                });
                
                const result = await response.json();
                if (response.ok && result.pathway) {
                    document.getElementById('proposalPaymentPathway').value = result.pathway;
                }
            } catch (error) {
                console.error('Generate pathway error:', error);
            }
            
            btn.disabled = false;
            btn.innerHTML = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> Generate from Research';
        }
        
        async function generateFinalProposal() {
            const container = document.getElementById('proposalPreviewContainer');
            container.innerHTML = `
                <div class="proposal-generating">
                    <div class="press-sending-spinner"></div>
                    <div>Generating your partnership proposal...</div>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/ai/proposal`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        partner: {
                            name: wizardPartner.recipientName,
                            organization: wizardPartner.organizationName || wizardPartner.universityName,
                            type: wizardPartner.recipientType,
                            location: wizardPartner.location || wizardPartner.state
                        },
                        research: wizardResearch,
                        config: proposalConfig
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.proposal) {
                    generatedProposal = result.proposal;
                    renderProposalPreview(result.proposal, result.proposalHtml);
                } else {
                    container.innerHTML = `
                        <div class="proposal-generating" style="color: var(--error);">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="48" height="48"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            <div style="margin-top: 1rem;">Failed to generate proposal.</div>
                            <button class="press-btn secondary" style="margin-top: 1rem;" onclick="generateFinalProposal()">Retry</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Proposal generation error:', error);
                container.innerHTML = `
                    <div class="proposal-generating" style="color: var(--error);">
                        <div>Error connecting to server.</div>
                        <button class="press-btn secondary" style="margin-top: 1rem;" onclick="generateFinalProposal()">Retry</button>
                    </div>
                `;
            }
        }
        
        function renderProposalPreview(proposal, proposalHtml) {
            const container = document.getElementById('proposalPreviewContainer');
            
            container.innerHTML = `
                <div class="proposal-preview-wrapper">
                    <div class="proposal-preview-document">
                        <div class="proposal-preview" style="padding: 2.5rem;">
                            ${proposalHtml || formatProposalToHtml(proposal)}
                        </div>
                    </div>
                    <div class="proposal-preview-actions">
                        <div class="proposal-action-card">
                            <h4>
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                Export
                            </h4>
                            <button class="proposal-action-btn primary" onclick="downloadProposalDoc()">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                Download DOCX
                            </button>
                            <button class="proposal-action-btn" onclick="copyProposalText()">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                Copy Text
                            </button>
                        </div>
                        
                        <div class="proposal-action-card">
                            <h4>
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                                Send to Partner
                            </h4>
                            <button class="proposal-action-btn" onclick="sendProposalToChannel()">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                                Send to Channel
                            </button>
                            <button class="proposal-action-btn" onclick="openDocReview(generatedProposal)">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                                Open Review Mode
                            </button>
                        </div>
                        
                        <div class="proposal-action-card">
                            <h4>
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                                Regenerate
                            </h4>
                            <button class="proposal-action-btn" onclick="wizardBack()">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12"/></svg>
                                Edit & Regenerate
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function formatProposalToHtml(text) {
            let html = escapeHtml(text);
            html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\n\n/g, '</p><p>');
            return '<p>' + html + '</p>';
        }
        
        async function downloadProposalDoc() {
            const orgName = wizardPartner?.organizationName || wizardPartner?.universityName || wizardPartner?.recipientName || 'Partner';
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/ai/proposal/download`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        proposal: generatedProposal,
                        partner: {
                            name: wizardPartner?.recipientName,
                            organization: orgName
                        },
                        config: proposalConfig
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Luminary_Partnership_Proposal_${orgName.replace(/\s+/g, '_')}.docx`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('Failed to generate document.');
                }
            } catch (error) {
                console.error('Download error:', error);
                alert('Error downloading document.');
            }
        }
        
        async function sendProposalToChannel() {
            if (!generatedProposal) {
                alert('No proposal generated yet.');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        partnerId: wizardPartner._id || wizardPartner.id,
                        content: ` **Partnership Proposal**\n\n${generatedProposal}\n\n---\n_This proposal is open for discussion. Please reply with any questions or feedback._`,
                        fromLuminary: true
                    })
                });
                
                if (response.ok) {
                    alert('Proposal sent to partner channel!');
                    closeProposalWizard();
                    loadPartnerDetails(wizardPartner._id || wizardPartner.id);
                } else {
                    alert('Failed to send proposal to channel.');
                }
            } catch (error) {
                console.error('Send to channel error:', error);
                alert('Error sending to channel.');
            }
        }
        
        function copyProposalText() {
            navigator.clipboard.writeText(generatedProposal).then(() => {
                alert('Proposal copied to clipboard!');
            });
        }
        
        // ===== DOCUMENT REVIEW & SIDENOTES =====
        
        let currentReviewPartner = null;
        let currentReviewProposal = '';
        let currentReviewProposalId = null;
        let documentSidenotes = [];
        let currentSidenoteFilter = 'all';
        let documentStatus = 'draft';
        
        function openDocReview(proposalContent) {
            if (!currentPartner && !wizardPartner) {
                alert('No partner selected');
                return;
            }
            
            currentReviewPartner = wizardPartner || currentPartner;
            currentReviewProposal = proposalContent || generatedProposal || '';
            
            const orgName = currentReviewPartner.organizationName || currentReviewPartner.universityName || currentReviewPartner.recipientName;
            document.getElementById('docReviewPartner').textContent = orgName;
            
            // Load proposal and sidenotes
            loadDocumentReview();
            
            document.getElementById('docReview').classList.add('active');
        }
        
        function closeDocReview() {
            document.getElementById('docReview').classList.remove('active');
        }
        
        async function loadDocumentReview() {
            const partnerId = currentReviewPartner._id || currentReviewPartner.id;
            
            // Reset signatures
            documentSignatures = { luminary: null, partner: null };
            
            // Try to load existing proposal from server
            try {
                const response = await fetch(`${API_BASE}/api/admin/partners/${partnerId}/proposal`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.proposal) {
                        currentReviewProposal = data.proposal.content || currentReviewProposal;
                        currentReviewProposalId = data.proposal._id || data.proposal.id;
                        documentStatus = data.proposal.status || 'draft';
                        documentSidenotes = data.proposal.sidenotes || [];
                        documentSignatures = data.proposal.signatures || { luminary: null, partner: null };
                    }
                }
            } catch (error) {
                console.log('Could not load existing proposal:', error);
            }
            
            // Render document
            renderReviewDocument();
            
            // Update status UI
            updateStatusBadge(documentStatus);
            document.getElementById('docStatusSelect').value = documentStatus;
            
            // Render sidenotes
            renderSidenotes();
        }
        
        function renderReviewDocument() {
            const container = document.getElementById('docReviewContent');
            const orgName = currentReviewPartner.organizationName || currentReviewPartner.universityName || currentReviewPartner.recipientName;
            
            if (currentReviewProposal) {
                // Convert markdown to HTML if needed
                let html = currentReviewProposal;
                if (!html.includes('<h1>') && !html.includes('<h2>')) {
                    html = formatProposalToHtml(html);
                }
                
                // Add Luminary header + document content + signature section
                container.innerHTML = `
                    <div style="text-align: center; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid #eee;">
                        <div style="font-family: 'Cinzel', serif; font-size: 1.5rem; color: #D4A853; letter-spacing: 0.2em;">LUMINARY</div>
                        <div style="font-size: 0.9rem; color: #666; margin-top: 0.35rem;">AI Technologies Inc.</div>
                    </div>
                    ${html}
                    ${renderSignatureSection()}
                `;
            } else {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #666;">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="48" height="48" style="margin-bottom: 1rem; opacity: 0.3;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        <p>No proposal generated yet.</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">Generate a proposal first using the Proposal Builder.</p>
                    </div>
                `;
            }
            
            // Add click handlers to sections for adding section-specific notes
            container.querySelectorAll('h2').forEach(h2 => {
                h2.addEventListener('click', () => {
                    const sectionText = h2.textContent.trim();
                    const sectionId = sectionText.toLowerCase().replace(/[^a-z0-9]+/g, '-');
                    document.getElementById('sidenoteSection').value = sectionId;
                    document.getElementById('sidenoteInput').focus();
                    
                    // Highlight section
                    container.querySelectorAll('.doc-section-highlight').forEach(el => el.classList.remove('doc-section-highlight'));
                    h2.classList.add('doc-section-highlight');
                });
            });
        }
        
        function updateStatusBadge(status) {
            const badge = document.getElementById('docStatusBadge');
            const statusConfig = {
                'draft': { label: 'Draft', icon: 'M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z' },
                'review': { label: 'Under Review', icon: 'M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z' },
                'pending-signature': { label: 'Pending Signatures', icon: 'M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z' },
                'executed': { label: 'Executed', icon: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' }
            };
            
            const config = statusConfig[status] || statusConfig['draft'];
            badge.className = `doc-status-badge ${status}`;
            badge.innerHTML = `
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="12" height="12"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${config.icon}"/></svg>
                ${config.label}
            `;
        }
        
        async function updateDocStatus(status) {
            documentStatus = status;
            updateStatusBadge(status);
            
            // Save to server
            await saveProposalToServer();
        }
        
        async function saveProposalToServer() {
            const partnerId = currentReviewPartner._id || currentReviewPartner.id;
            
            try {
                await fetch(`${API_BASE}/api/admin/partners/${partnerId}/proposal`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: currentReviewProposal,
                        status: documentStatus,
                        sidenotes: documentSidenotes,
                        signatures: documentSignatures,
                        config: proposalConfig
                    })
                });
            } catch (error) {
                console.error('Save proposal error:', error);
            }
        }
        
        // Sidenotes Management
        function renderSidenotes() {
            const container = document.getElementById('sidenotesList');
            const countEl = document.getElementById('sidenotesCount');
            
            // Filter sidenotes
            let filtered = documentSidenotes;
            if (currentSidenoteFilter === 'luminary') {
                filtered = documentSidenotes.filter(n => n.authorType === 'luminary');
            } else if (currentSidenoteFilter === 'partner') {
                filtered = documentSidenotes.filter(n => n.authorType === 'partner');
            } else if (currentSidenoteFilter === 'unresolved') {
                filtered = documentSidenotes.filter(n => !n.resolved);
            }
            
            countEl.textContent = documentSidenotes.length;
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="sidenotes-empty">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/></svg>
                        <p>${currentSidenoteFilter === 'all' ? 'No notes yet' : 'No matching notes'}</p>
                        <p style="font-size: 0.8rem; margin-top: 0.25rem;">Add a note to start the discussion.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filtered.map(note => {
                const sectionLabels = {
                    'executive-summary': 'Executive Summary',
                    'about-luminary': 'About Luminary',
                    'partnership-overview': 'Partnership Overview',
                    'deliverables': 'Deliverables & Access',
                    'investment-terms': 'Investment & Terms',
                    'investment-rationale': 'Investment Rationale',
                    'payment-pathway': 'Payment Pathway',
                    'next-steps': 'Next Steps',
                    'signatures': 'Signatures'
                };
                
                return `
                    <div class="sidenote-item from-${note.authorType} ${note.resolved ? 'resolved' : ''}" data-id="${note.id}">
                        <div class="sidenote-header">
                            <div class="sidenote-author">
                                <div class="sidenote-author-avatar ${note.authorType === 'partner' ? 'partner' : ''}">
                                    ${note.authorType === 'luminary' ? 'L' : 'P'}
                                </div>
                                <span class="sidenote-author-name">${escapeHtml(note.author)}</span>
                            </div>
                            <span class="sidenote-time">${formatTimeAgo(note.timestamp)}</span>
                        </div>
                        ${note.section ? `
                            <div class="sidenote-section">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="10" height="10"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>
                                ${sectionLabels[note.section] || note.section}
                            </div>
                        ` : ''}
                        <div class="sidenote-content">${escapeHtml(note.content)}</div>
                        <div class="sidenote-actions">
                            <button class="sidenote-action-btn" onclick="replyToSidenote('${note.id}')">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="10" height="10"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/></svg>
                                Reply
                            </button>
                            ${!note.resolved ? `
                                <button class="sidenote-action-btn resolve" onclick="resolveSidenote('${note.id}')">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="10" height="10"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                    Resolve
                                </button>
                            ` : `
                                <span style="font-size: 0.7rem; color: var(--success);"> Resolved</span>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function filterSidenotes(filter) {
            currentSidenoteFilter = filter;
            
            // Update filter buttons
            document.querySelectorAll('.sidenotes-filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            
            renderSidenotes();
        }
        
        async function addSidenote() {
            const input = document.getElementById('sidenoteInput');
            const sectionSelect = document.getElementById('sidenoteSection');
            
            const content = input.value.trim();
            if (!content) {
                alert('Please enter a note');
                return;
            }
            
            const newNote = {
                id: 'note_' + Date.now(),
                author: 'Luminary',
                authorType: 'luminary',
                content: content,
                section: sectionSelect.value || null,
                timestamp: new Date().toISOString(),
                resolved: false
            };
            
            documentSidenotes.push(newNote);
            
            // Clear input
            input.value = '';
            sectionSelect.value = '';
            
            // Re-render
            renderSidenotes();
            
            // Save to server
            await saveProposalToServer();
        }
        
        function replyToSidenote(noteId) {
            const note = documentSidenotes.find(n => n.id === noteId);
            if (!note) return;
            
            const input = document.getElementById('sidenoteInput');
            input.value = `@${note.author}: `;
            input.focus();
            
            if (note.section) {
                document.getElementById('sidenoteSection').value = note.section;
            }
        }
        
        async function resolveSidenote(noteId) {
            const note = documentSidenotes.find(n => n.id === noteId);
            if (!note) return;
            
            note.resolved = true;
            note.resolvedAt = new Date().toISOString();
            note.resolvedBy = 'Luminary';
            
            renderSidenotes();
            await saveProposalToServer();
        }
        
        function formatTimeAgo(timestamp) {
            const seconds = Math.floor((new Date() - new Date(timestamp)) / 1000);
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
            return new Date(timestamp).toLocaleDateString();
        }
        
        async function downloadReviewDoc() {
            const orgName = currentReviewPartner?.organizationName || currentReviewPartner?.universityName || currentReviewPartner?.recipientName || 'Partner';
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/ai/proposal/download`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        proposal: currentReviewProposal,
                        partner: {
                            name: currentReviewPartner?.recipientName,
                            organization: orgName
                        },
                        config: proposalConfig,
                        signatures: documentSignatures
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Luminary_Partnership_Proposal_${orgName.replace(/\s+/g, '_')}.docx`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }
            } catch (error) {
                console.error('Download error:', error);
            }
        }
        
        // ===== ELECTRONIC SIGNATURES =====
        
        let documentSignatures = {
            luminary: null,
            partner: null
        };
        let currentSigningParty = null;
        let signatureModalCtx = null;
        let isDrawingSignature = false;
        let hasDrawnSignature = false;
        
        function renderSignatureSection() {
            const orgName = currentReviewPartner?.organizationName || currentReviewPartner?.universityName || currentReviewPartner?.recipientName || 'Partner';
            
            return `
                <div class="signature-section">
                    <div class="signature-section-title">Signatures</div>
                    <div class="signature-section-desc">By signing below, both parties agree to the terms outlined in this partnership agreement.</div>
                    
                    <div class="signature-blocks">
                        <!-- Luminary Signature -->
                        <div class="signature-block" id="luminarySignatureBlock">
                            <div class="signature-block-title">For Luminary AI Technologies Inc.</div>
                            <div class="signature-canvas-container ${documentSignatures.luminary?.signed ? 'signed' : ''}" id="luminarySignatureContainer">
                                ${documentSignatures.luminary?.signed ? `
                                    <img src="${documentSignatures.luminary.image}" alt="Signature" style="width: 100%; height: 100px; object-fit: contain;">
                                ` : `
                                    <div class="signature-placeholder" onclick="openSignatureModal('luminary')">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                                        Click to sign
                                    </div>
                                `}
                            </div>
                            <div class="signature-actions">
                                ${documentSignatures.luminary?.signed ? `
                                    <button class="signature-action-btn" onclick="clearSignature('luminary')">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                        Clear
                                    </button>
                                ` : `
                                    <button class="signature-action-btn sign" onclick="openSignatureModal('luminary')">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                                        Sign
                                    </button>
                                `}
                            </div>
                            <div class="signature-info">
                                <div class="signature-info-row">
                                    <label>Printed Name</label>
                                    <input type="text" id="luminarySignerName" value="${documentSignatures.luminary?.name || 'Ben Hizer'}" ${documentSignatures.luminary?.signed ? 'disabled' : ''}>
                                </div>
                                <div class="signature-info-row">
                                    <label>Title</label>
                                    <input type="text" id="luminarySignerTitle" value="${documentSignatures.luminary?.title || 'Founder & CEO'}" ${documentSignatures.luminary?.signed ? 'disabled' : ''}>
                                </div>
                            </div>
                            <div class="signature-date">
                                Date: ${documentSignatures.luminary?.date || '_________________'}
                            </div>
                            <div class="signature-status ${documentSignatures.luminary?.signed ? 'signed' : 'pending'}">
                                ${documentSignatures.luminary?.signed ? `
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                    Signed
                                ` : `
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                    Awaiting Signature
                                `}
                            </div>
                        </div>
                        
                        <!-- Partner Signature -->
                        <div class="signature-block" id="partnerSignatureBlock">
                            <div class="signature-block-title">For ${escapeHtml(orgName)}</div>
                            <div class="signature-canvas-container ${documentSignatures.partner?.signed ? 'signed' : ''}" id="partnerSignatureContainer">
                                ${documentSignatures.partner?.signed ? `
                                    <img src="${documentSignatures.partner.image}" alt="Signature" style="width: 100%; height: 100px; object-fit: contain;">
                                ` : `
                                    <div class="signature-placeholder" onclick="openSignatureModal('partner')">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                                        Click to sign
                                    </div>
                                `}
                            </div>
                            <div class="signature-actions">
                                ${documentSignatures.partner?.signed ? `
                                    <button class="signature-action-btn" onclick="clearSignature('partner')">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                        Clear
                                    </button>
                                ` : `
                                    <button class="signature-action-btn sign" onclick="openSignatureModal('partner')">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                                        Sign
                                    </button>
                                `}
                            </div>
                            <div class="signature-info">
                                <div class="signature-info-row">
                                    <label>Printed Name</label>
                                    <input type="text" id="partnerSignerName" value="${documentSignatures.partner?.name || ''}" ${documentSignatures.partner?.signed ? 'disabled' : ''} placeholder="Enter name">
                                </div>
                                <div class="signature-info-row">
                                    <label>Title</label>
                                    <input type="text" id="partnerSignerTitle" value="${documentSignatures.partner?.title || ''}" ${documentSignatures.partner?.signed ? 'disabled' : ''} placeholder="Enter title">
                                </div>
                            </div>
                            <div class="signature-date">
                                Date: ${documentSignatures.partner?.date || '_________________'}
                            </div>
                            <div class="signature-status ${documentSignatures.partner?.signed ? 'signed' : 'pending'}">
                                ${documentSignatures.partner?.signed ? `
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                    Signed
                                ` : `
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                    Awaiting Signature
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function openSignatureModal(party) {
            currentSigningParty = party;
            hasDrawnSignature = false;
            
            const orgName = currentReviewPartner?.organizationName || currentReviewPartner?.universityName || currentReviewPartner?.recipientName || 'Partner';
            const partyName = party === 'luminary' ? 'Luminary AI Technologies' : orgName;
            
            document.getElementById('signatureModalTitle').textContent = `Sign for ${partyName}`;
            document.getElementById('signatureModalDesc').textContent = 'Draw your signature below using your mouse or finger';
            
            // Pre-fill name and title
            const nameInput = document.getElementById('signatureModalName');
            const titleInput = document.getElementById('signatureModalTitle2');
            
            if (party === 'luminary') {
                nameInput.value = document.getElementById('luminarySignerName')?.value || 'Ben Hizer';
                titleInput.value = document.getElementById('luminarySignerTitle')?.value || 'Founder & CEO';
            } else {
                nameInput.value = document.getElementById('partnerSignerName')?.value || '';
                titleInput.value = document.getElementById('partnerSignerTitle')?.value || '';
            }
            
            document.getElementById('signatureModal').classList.add('active');
            
            // Initialize canvas
            setTimeout(() => {
                initSignatureModalCanvas();
            }, 100);
        }
        
        function closeSignatureModal() {
            document.getElementById('signatureModal').classList.remove('active');
            currentSigningParty = null;
        }
        
        function initSignatureModalCanvas() {
            const canvas = document.getElementById('signatureModalCanvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            const container = canvas.parentElement;
            canvas.width = container.offsetWidth - 16;
            canvas.height = 150;
            
            // Clear canvas
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Set drawing style
            ctx.strokeStyle = '#1a1a1a';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            signatureModalCtx = ctx;
            
            // Remove old listeners
            canvas.onmousedown = null;
            canvas.onmousemove = null;
            canvas.onmouseup = null;
            canvas.onmouseleave = null;
            canvas.ontouchstart = null;
            canvas.ontouchmove = null;
            canvas.ontouchend = null;
            
            // Mouse events
            canvas.addEventListener('mousedown', startDrawingSignature);
            canvas.addEventListener('mousemove', drawSignature);
            canvas.addEventListener('mouseup', stopDrawingSignature);
            canvas.addEventListener('mouseleave', stopDrawingSignature);
            
            // Touch events
            canvas.addEventListener('touchstart', startDrawingSignature);
            canvas.addEventListener('touchmove', drawSignature);
            canvas.addEventListener('touchend', stopDrawingSignature);
        }
        
        function startDrawingSignature(e) {
            isDrawingSignature = true;
            hasDrawnSignature = true;
            
            const canvas = document.getElementById('signatureModalCanvas');
            const rect = canvas.getBoundingClientRect();
            
            const x = (e.clientX || e.touches?.[0]?.clientX) - rect.left;
            const y = (e.clientY || e.touches?.[0]?.clientY) - rect.top;
            
            signatureModalCtx.beginPath();
            signatureModalCtx.moveTo(x, y);
            
            e.preventDefault();
        }
        
        function drawSignature(e) {
            if (!isDrawingSignature) return;
            
            const canvas = document.getElementById('signatureModalCanvas');
            const rect = canvas.getBoundingClientRect();
            
            const x = (e.clientX || e.touches?.[0]?.clientX) - rect.left;
            const y = (e.clientY || e.touches?.[0]?.clientY) - rect.top;
            
            signatureModalCtx.lineTo(x, y);
            signatureModalCtx.stroke();
            
            e.preventDefault();
        }
        
        function stopDrawingSignature() {
            isDrawingSignature = false;
        }
        
        function clearSignatureModal() {
            const canvas = document.getElementById('signatureModalCanvas');
            signatureModalCtx.fillStyle = 'white';
            signatureModalCtx.fillRect(0, 0, canvas.width, canvas.height);
            hasDrawnSignature = false;
        }
        
        async function applySignature() {
            if (!hasDrawnSignature) {
                alert('Please draw your signature first');
                return;
            }
            
            const name = document.getElementById('signatureModalName').value.trim();
            const title = document.getElementById('signatureModalTitle2').value.trim();
            
            if (!name) {
                alert('Please enter your name');
                return;
            }
            
            const canvas = document.getElementById('signatureModalCanvas');
            const signatureImage = canvas.toDataURL('image/png');
            const signatureDate = new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            documentSignatures[currentSigningParty] = {
                signed: true,
                image: signatureImage,
                name: name,
                title: title,
                date: signatureDate,
                timestamp: new Date().toISOString()
            };
            
            // Close modal
            closeSignatureModal();
            
            // Re-render document with updated signatures
            renderReviewDocument();
            
            // Check if both signed
            checkFullyExecuted();
            
            // Save to server
            await saveProposalToServer();
        }
        
        async function clearSignature(party) {
            if (!confirm('Are you sure you want to clear this signature?')) {
                return;
            }
            
            documentSignatures[party] = null;
            
            // Re-render
            renderReviewDocument();
            
            // Update status if needed
            if (documentStatus === 'executed') {
                documentStatus = 'pending-signature';
                updateStatusBadge(documentStatus);
                document.getElementById('docStatusSelect').value = documentStatus;
            }
            
            // Save to server
            await saveProposalToServer();
        }
        
        function checkFullyExecuted() {
            if (documentSignatures.luminary?.signed && documentSignatures.partner?.signed) {
                documentStatus = 'executed';
                updateStatusBadge(documentStatus);
                document.getElementById('docStatusSelect').value = documentStatus;
                
                // Show celebration
                showExecutedCelebration();
            }
        }
        
        function showExecutedCelebration() {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 2rem;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #4ade80, #22c55e);
                color: white;
                padding: 1rem 2rem;
                border-radius: 10px;
                font-size: 1rem;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 0.75rem;
                box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4);
                z-index: 10002;
                animation: slideUp 0.3s ease;
            `;
            toast.innerHTML = `
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                Partnership Agreement Fully Executed!
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ===== EMAIL MANAGEMENT =====
        // ===== EMAIL MANAGEMENT =====
        
        async function savePartnerEmail() {
            const emailInput = document.getElementById('partnerEmailInput');
            const email = emailInput.value.trim();
            
            if (!email) {
                alert('Please enter an email address');
                return;
            }
            
            if (!email.includes('@') || !email.includes('.')) {
                alert('Please enter a valid email address');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/partners/${currentPartner._id}/email`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email })
                });
                
                if (response.ok) {
                    currentPartner.email = email;
                    showSaveIndicator('saved');
                    // Refresh the details view
                    currentTab = 'details';
                    renderCurrentTab();
                } else {
                    const result = await response.json();
                    alert('Failed to save email: ' + result.error);
                }
            } catch (error) {
                console.error('Save email error:', error);
                alert('Error saving email');
            }
        }
        
        // ===== AI DRAFTING WITH PERPLEXITY =====
        
        let currentAIOutput = '';
        
        async function generateAIDraft(type) {
            if (!currentPartner) return;
            
            const btn = event.target.closest('.ai-btn');
            btn.classList.add('loading');
            
            const outputContainer = document.getElementById('aiOutputContainer');
            const outputContent = document.getElementById('aiOutputContent');
            
            outputContainer.style.display = 'block';
            outputContent.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);"><div class="press-sending-spinner" style="margin: 0 auto 1rem;"></div>Generating with AI...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/ai/draft`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type,
                        partner: {
                            id: currentPartner._id || currentPartner.id,
                            name: currentPartner.recipientName,
                            organization: currentPartner.organizationName || currentPartner.universityName,
                            type: currentPartner.recipientType,
                            category: currentPartner.category || currentPartner.focus,
                            location: currentPartner.location || currentPartner.state,
                            status: currentPartner.status,
                            messageHistory: (currentPartner.messages || []).slice(-3).map(m => ({
                                from: m.fromLuminary ? 'Luminary' : 'Partner',
                                content: m.content?.substring(0, 200)
                            }))
                        }
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.content) {
                    currentAIOutput = result.content;
                    outputContent.innerHTML = formatAIOutput(result.content);
                } else {
                    outputContent.innerHTML = `<div style="color: var(--error);">Error: ${result.error || 'Failed to generate content'}</div>`;
                }
            } catch (error) {
                console.error('AI draft error:', error);
                outputContent.innerHTML = `<div style="color: var(--error);">Error connecting to AI service</div>`;
            } finally {
                btn.classList.remove('loading');
            }
        }
        
        function formatAIOutput(content) {
            // Convert markdown-style formatting to HTML
            let html = escapeHtml(content);
            
            // Headers
            html = html.replace(/^### (.+)$/gm, '<h4>$1</h4>');
            html = html.replace(/^## (.+)$/gm, '<h4>$1</h4>');
            
            // Bold
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            
            // Line breaks
            html = html.replace(/\n\n/g, '</p><p>');
            html = '<p>' + html + '</p>';
            
            return html;
        }
        
        function copyAIOutput() {
            navigator.clipboard.writeText(currentAIOutput).then(() => {
                showSaveIndicator('saved');
            });
        }
        
        function useAIOutput() {
            const composeEditor = document.getElementById('composeEditor');
            if (composeEditor) {
                composeEditor.value = currentAIOutput;
                composeEditor.focus();
                // Switch to conversation tab
                document.querySelector('.detail-tab[data-tab="conversation"]')?.click();
            }
        }
        
        function closeAIOutput() {
            document.getElementById('aiOutputContainer').style.display = 'none';
            currentAIOutput = '';
        }
        
        // ===== PRESS RELEASE FUNCTIONALITY =====
        
        let pressRecipients = [];
        let selectedRecipients = new Set();
        let pressCategories = [];
        
        // Open Press Release Modal
        async function openPressReleaseModal() {
            document.getElementById('pressReleaseModal').classList.add('active');
            await loadPressRecipients();
        }
        
        function closePressModal() {
            document.getElementById('pressReleaseModal').classList.remove('active');
        }
        
        // Load media recipients
        async function loadPressRecipients() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/press/recipients`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    pressRecipients = data.recipients || [];
                    pressCategories = data.categories || [];
                    
                    document.getElementById('pressTotalCount').textContent = data.totalMedia || 0;
                    document.getElementById('pressEmailCount').textContent = data.withEmail || 0;
                    
                    // Populate category filter
                    const categorySelect = document.getElementById('pressCategoryFilter');
                    categorySelect.innerHTML = '<option value="all">All Categories</option>' +
                        pressCategories.map(c => `<option value="${c}">${c}</option>`).join('');
                    
                    renderPressRecipients();
                    updateSelectedCount();
                }
            } catch (error) {
                console.error('Load press recipients error:', error);
            }
        }
        
        // Render recipients list
        function renderPressRecipients() {
            const filter = document.getElementById('pressCategoryFilter').value;
            const list = document.getElementById('pressRecipientsList');
            
            let filtered = pressRecipients;
            if (filter !== 'all') {
                filtered = pressRecipients.filter(r => r.category === filter);
            }
            
            if (filtered.length === 0) {
                list.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                        <p>No media contacts found</p>
                        <small>Import media contacts with email addresses to send press releases</small>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = filtered.map(r => `
                <div class="press-recipient-item ${selectedRecipients.has(r.id) ? 'selected' : ''}" 
                     onclick="toggleRecipient('${r.id}')">
                    <input type="checkbox" ${selectedRecipients.has(r.id) ? 'checked' : ''} 
                           ${!r.email ? 'disabled' : ''}
                           onclick="event.stopPropagation(); toggleRecipient('${r.id}')">
                    <div class="press-recipient-info">
                        <div class="press-recipient-name">${escapeHtml(r.organization || r.name)}</div>
                        <div class="press-recipient-meta">${escapeHtml(r.category || '')} ${r.location ? ' ' + escapeHtml(r.location) : ''}</div>
                        ${r.email ? 
                            `<div class="press-recipient-email">${escapeHtml(r.email)}</div>` : 
                            `<div class="press-no-email">No email address</div>`
                        }
                    </div>
                </div>
            `).join('');
        }
        
        // Toggle recipient selection
        function toggleRecipient(id) {
            const recipient = pressRecipients.find(r => r.id === id);
            if (!recipient || !recipient.email) return;
            
            if (selectedRecipients.has(id)) {
                selectedRecipients.delete(id);
            } else {
                selectedRecipients.add(id);
            }
            
            renderPressRecipients();
            updateSelectedCount();
        }
        
        // Toggle all recipients
        function toggleAllRecipients() {
            const selectAll = document.getElementById('pressSelectAll').checked;
            const filter = document.getElementById('pressCategoryFilter').value;
            
            let filtered = pressRecipients;
            if (filter !== 'all') {
                filtered = pressRecipients.filter(r => r.category === filter);
            }
            
            if (selectAll) {
                filtered.filter(r => r.email).forEach(r => selectedRecipients.add(r.id));
            } else {
                filtered.forEach(r => selectedRecipients.delete(r.id));
            }
            
            renderPressRecipients();
            updateSelectedCount();
        }
        
        // Filter recipients by category
        function filterPressRecipients() {
            // Reset selection for new filter
            selectedRecipients.clear();
            document.getElementById('pressSelectAll').checked = true;
            
            const filter = document.getElementById('pressCategoryFilter').value;
            let filtered = pressRecipients;
            if (filter !== 'all') {
                filtered = pressRecipients.filter(r => r.category === filter);
            }
            
            // Select all with email in this category
            filtered.filter(r => r.email).forEach(r => selectedRecipients.add(r.id));
            
            renderPressRecipients();
            updateSelectedCount();
        }
        
        // Update selected count
        function updateSelectedCount() {
            document.getElementById('pressSelectedCount').textContent = selectedRecipients.size;
            document.getElementById('pressSendBtn').disabled = selectedRecipients.size === 0;
        }
        
        // Insert personalization token
        function insertToken(token) {
            const textarea = document.getElementById('pressBody');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            textarea.value = text.substring(0, start) + token + text.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + token.length;
            textarea.focus();
        }
        
        // Send test email
        async function sendTestEmail() {
            const subject = document.getElementById('pressSubject').value;
            const body = document.getElementById('pressBody').value;
            
            if (!subject || !body) {
                alert('Please enter a subject and body');
                return;
            }
            
            const testEmail = prompt('Enter test email address:', 'ben@luminary-tech.ai');
            if (!testEmail) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/press/send`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        subject,
                        htmlBody: body.replace(/\n/g, '<br>'),
                        textBody: body,
                        testEmail
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`Test email sent to ${testEmail}`);
                } else {
                    alert('Failed to send test: ' + result.error);
                }
            } catch (error) {
                console.error('Send test error:', error);
                alert('Error sending test email');
            }
        }
        
        // Send press release to all selected recipients
        async function sendPressRelease() {
            const subject = document.getElementById('pressSubject').value;
            const body = document.getElementById('pressBody').value;
            
            if (!subject || !body) {
                alert('Please enter a subject and body');
                return;
            }
            
            if (selectedRecipients.size === 0) {
                alert('Please select at least one recipient');
                return;
            }
            
            const confirmMsg = `Send press release to ${selectedRecipients.size} recipients?\n\nSubject: ${subject}`;
            if (!confirm(confirmMsg)) return;
            
            // Show sending overlay
            const overlay = document.getElementById('pressSendingOverlay');
            overlay.style.display = 'flex';
            document.getElementById('pressSendingProgress').textContent = `0 / ${selectedRecipients.size} sent`;
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/press/send`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        subject,
                        htmlBody: body.replace(/\n/g, '<br>'),
                        textBody: body,
                        recipientIds: Array.from(selectedRecipients)
                    })
                });
                
                const result = await response.json();
                
                overlay.style.display = 'none';
                
                if (response.ok) {
                    alert(`Press release sent!\n\nSent: ${result.sent}\nFailed: ${result.failed}`);
                    closePressModal();
                    
                    // Clear form
                    document.getElementById('pressSubject').value = '';
                    document.getElementById('pressBody').value = '';
                } else {
                    alert('Failed to send: ' + result.error);
                }
            } catch (error) {
                console.error('Send press release error:', error);
                overlay.style.display = 'none';
                alert('Error sending press release');
            }
        }
        
        // Save draft
        async function savePressReleaseDraft() {
            const subject = document.getElementById('pressSubject').value;
            const body = document.getElementById('pressBody').value;
            const category = document.getElementById('pressCategoryFilter').value;
            
            if (!subject && !body) {
                alert('Nothing to save');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/press/draft`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        subject,
                        htmlBody: body.replace(/\n/g, '<br>'),
                        textBody: body,
                        category
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showSaveIndicator('saved');
                } else {
                    alert('Failed to save draft');
                }
            } catch (error) {
                console.error('Save draft error:', error);
            }
        }
        
        // Press History
        async function openPressHistoryModal() {
            document.getElementById('pressHistoryModal').classList.add('active');
            await loadPressHistory();
        }
        
        function closePressHistoryModal() {
            document.getElementById('pressHistoryModal').classList.remove('active');
        }
        
        async function loadPressHistory() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/press/history`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const history = await response.json();
                
                if (response.ok) {
                    renderPressHistory(history);
                }
            } catch (error) {
                console.error('Load press history error:', error);
            }
        }
        
        function renderPressHistory(history) {
            const list = document.getElementById('pressHistoryList');
            
            if (!history || history.length === 0) {
                list.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="48" height="48" style="margin-bottom: 1rem; opacity: 0.3;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/>
                        </svg>
                        <p>No press releases sent yet</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = history.filter(h => !h.isDraft).map(h => `
                <div class="press-history-item">
                    <div class="press-history-subject">${escapeHtml(h.subject || 'Untitled')}</div>
                    <div class="press-history-meta">
                        <span>${formatDate(h.sentAt)}</span>
                        <span class="press-history-stat success"> ${h.sentCount || 0} sent</span>
                        ${h.failedCount > 0 ? `<span class="press-history-stat failed"> ${h.failedCount} failed</span>` : ''}
                        <span>${h.recipientCount || 0} recipients</span>
                    </div>
                </div>
            `).join('');
        }
        
        function logout() {
            authToken = null;
            localStorage.removeItem('luminary_auth_token');
            location.reload();
        }

        // Login on Enter key
        document.getElementById('accessCode').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') attemptLogin();
        });

        // ===== DATA MANAGEMENT =====
        const STORAGE_KEY = 'luminary_partners_data';
        const TEMPLATES_KEY = 'luminary_templates';
        
        let allPartners = {};
        let currentView = 'all';
        let currentFilter = 'all';
        let currentPartner = null;
        let currentTab = 'conversation';

        // Default templates
        let templates = {
            proposal: `Dear {{schoolName}},

We are reaching out to introduce Luminary AI Technologies and explore a strategic partnership with {{universityName}}.

Luminary is building intelligent infrastructure for complex operationstechnology designed to make fragmented, legacy systems coherent and accessible.

What We're Proposing:
 Vestiq Access for Students & Faculty
 Legal Insights Integration  
 Luminary Studios for Student Projects
 Research Collaboration
 Talent Pipeline

Why We're Different:
We have taken zero institutional funding. No Silicon Valley money. No hedge fund backing. We've spent years building quietly because we wanted to remain free to build technology for peoplenot just institutions.

We would welcome the opportunity to discuss this further.

 Luminary AI Technologies
"Technology for the people. Not power."`,

            pitch: `Thank you for connecting with us.

THE COMPANY
Luminary AI Technologies is building intelligent infrastructure for complex operationstechnology designed to challenge inefficient legacy systems.

THE STORY
We have taken zero institutional funding. We've spent years building quietly, bootstrapped, because we wanted complete independence.

OUR PLATFORMS
 Vestiq  Wealth intelligence platform
 Legal Insights  Policy intelligence
 Blue Haven  E-commerce intelligence
 Luminary Studios  Development infrastructure

FOUNDER AVAILABILITY
Available for interviews, background conversations, or commentary.

 Luminary AI Technologies
Indianapolis, IN | luminary-tech.ai`,

            followup: `Following up on our previous message. We'd love to hear your thoughts and answer any questions.

Is there a convenient time for a brief call?

 Luminary AI Technologies`,

            reminder: `Just a friendly reminder about our partnership proposal. Please let us know if you have any questions.

 Luminary AI Technologies`,

            thankyou: `Thank you for your interest in Luminary. We're excited about the possibility of working together.

We'll follow up shortly with next steps.

 Luminary AI Technologies`,

            schedule: `Thank you for your response. We'd love to schedule a call.

Would any of these times work?
 [Day], [Date] at [Time]
 [Day], [Date] at [Time]

 Luminary AI Technologies`,

            info: `Thank you for your interest. Here's additional information:

[Add details here]

Please let us know if you have other questions.

 Luminary AI Technologies`
        };

        // Load data from API
        async function loadPartnerData() {
            // Load templates from localStorage (still local for now)
            const savedTemplates = localStorage.getItem(TEMPLATES_KEY);
            if (savedTemplates) {
                templates = { ...templates, ...JSON.parse(savedTemplates) };
            }

            // Load partner data from API
            try {
                const response = await fetch(`${API_BASE}/api/admin/partners`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        logout();
                        return;
                    }
                    throw new Error('Failed to load partners');
                }
                
                const partnersArray = await response.json();
                
                // Convert array to object keyed by id
                allPartners = {};
                partnersArray.forEach(p => {
                    allPartners[p.id] = p;
                });
                
                console.log(`Loaded ${partnersArray.length} partners from API`);
            } catch (error) {
                console.error('Error loading partners:', error);
                allPartners = {};
            }
            
            updateCounts();
            renderPartnerList();
        }

        // Refresh data from API
        async function refreshData() {
            showSaveIndicator('saving');
            await loadPartnerData();
            
            // If a partner is currently selected, refresh their view
            if (currentPartner) {
                const updatedPartner = allPartners[currentPartner.id];
                if (updatedPartner) {
                    currentPartner = updatedPartner;
                    renderCurrentTab();
                }
            }
            
            showSaveIndicator('saved');
            console.log('Data refreshed from API');
        }

        function showSaveIndicator(status) {
            const indicator = document.getElementById('saveIndicator');
            const text = document.getElementById('saveText');
            
            indicator.className = 'save-indicator visible ' + status;
            text.textContent = status === 'saving' ? 'Saving...' : status === 'saved' ? 'Saved' : 'Error';
            
            setTimeout(() => {
                indicator.classList.remove('visible');
            }, 2000);
        }

        // ===== COUNTS =====
        function updateCounts() {
            const partners = Object.values(allPartners);
            const universities = partners.filter(p => p.recipientType === 'university');
            const media = partners.filter(p => p.recipientType === 'media');
            const responded = partners.filter(p => p.messages && p.messages.some(m => !m.fromLuminary));
            const pending = partners.filter(p => !p.messages || p.messages.length === 0 || !p.messages.some(m => !m.fromLuminary));
            const unread = partners.filter(p => p.messages && p.messages.some(m => !m.fromLuminary && !m.read));

            document.getElementById('navAllCount').textContent = partners.length;
            document.getElementById('navUniCount').textContent = universities.length;
            document.getElementById('navMediaCount').textContent = media.length;
            document.getElementById('navRespondedCount').textContent = responded.length;
            document.getElementById('navPendingCount').textContent = pending.length;
            document.getElementById('navUnreadCount').textContent = unread.length;
        }

        // ===== PARTNER LIST =====
        function renderPartnerList() {
            const container = document.getElementById('partnerList');
            let partners = Object.values(allPartners);

            // View filter
            if (currentView === 'universities') partners = partners.filter(p => p.recipientType === 'university');
            else if (currentView === 'media') partners = partners.filter(p => p.recipientType === 'media');
            else if (currentView === 'responded') partners = partners.filter(p => p.messages && p.messages.some(m => !m.fromLuminary));
            else if (currentView === 'pending') partners = partners.filter(p => !p.messages || !p.messages.some(m => !m.fromLuminary));
            else if (currentView === 'unread') partners = partners.filter(p => p.messages && p.messages.some(m => !m.fromLuminary && !m.read));

            // Status filter
            if (currentFilter === 'unread') partners = partners.filter(p => p.messages && p.messages.some(m => !m.fromLuminary && !m.read));
            else if (currentFilter === 'responded') partners = partners.filter(p => p.messages && p.messages.some(m => !m.fromLuminary));

            // Search
            const search = document.getElementById('searchInput').value.toLowerCase();
            if (search) {
                partners = partners.filter(p => 
                    p.recipientName.toLowerCase().includes(search) ||
                    (p.universityName && p.universityName.toLowerCase().includes(search)) ||
                    (p.focus && p.focus.toLowerCase().includes(search))
                );
            }

            // Sort
            partners.sort((a, b) => {
                const aUnread = a.messages && a.messages.some(m => !m.fromLuminary && !m.read);
                const bUnread = b.messages && b.messages.some(m => !m.fromLuminary && !m.read);
                if (aUnread && !bUnread) return -1;
                if (!aUnread && bUnread) return 1;
                return new Date(b.lastActivity || 0) - new Date(a.lastActivity || 0);
            });

            document.getElementById('listCount').textContent = `(${partners.length})`;

            container.innerHTML = partners.slice(0, 100).map(p => {
                const hasUnread = p.messages && p.messages.some(m => !m.fromLuminary && !m.read);
                const lastMsg = p.messages && p.messages.length > 0 ? p.messages[p.messages.length - 1] : null;
                
                return `
                    <div class="partner-item ${currentPartner?.id === p.id ? 'active' : ''} ${hasUnread ? 'unread' : ''}" 
                         onclick="selectPartner('${p.id}')">
                        <div class="partner-item-header">
                            <span class="partner-item-name">${p.recipientName}</span>
                            <span class="partner-item-time">${formatRelativeTime(p.lastActivity)}</span>
                        </div>
                        <div class="partner-item-meta">
                            <span class="type-dot ${p.recipientType}"></span>
                            <span class="partner-item-detail">${p.recipientType === 'media' ? (p.focus || '').substring(0, 25) : p.state || ''}</span>
                            <span class="status-indicator ${p.status}">${p.status}</span>
                        </div>
                        <div class="partner-item-preview">
                            ${lastMsg ? (lastMsg.fromLuminary ? 'You: ' : '') + lastMsg.content.substring(0, 50) + '...' : 'No messages yet'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ===== PARTNER SELECTION =====
        async function selectPartner(id) {
            currentPartner = allPartners[id];
            if (!currentPartner) return;

            // Mark messages as read via API
            const hasUnread = currentPartner.messages && currentPartner.messages.some(m => !m.fromLuminary && !m.read);
            if (hasUnread) {
                try {
                    await fetch(`${API_BASE}/api/admin/messages/read`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({ partnerId: id })
                    });
                    
                    // Update local state
                    currentPartner.messages.forEach(m => { if (!m.fromLuminary) m.read = true; });
                } catch (error) {
                    console.error('Mark read error:', error);
                }
            }

            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('conversationView').style.display = 'flex';

            document.getElementById('detailName').textContent = currentPartner.recipientName;
            document.getElementById('detailMeta').textContent = currentPartner.recipientType === 'university'
                ? `${currentPartner.universityName || ''}  ${currentPartner.state || ''}`
                : currentPartner.focus || '';

            updateStatusButton();
            renderCurrentTab();
            renderPartnerList();
            updateCounts();
        }

        function updateStatusButton() {
            const btn = document.getElementById('btnMarkStatus');
            const s = currentPartner.status;
            btn.innerHTML = s === 'pending' 
                ? '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg> Mark Viewed'
                : '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> ' + (s === 'viewed' ? 'Mark Responded' : 'Accepted');
        }

        // ===== TAB RENDERING =====
        function renderCurrentTab() {
            const content = document.getElementById('detailContent');
            const compose = document.getElementById('composeArea');

            if (currentTab === 'conversation') {
                compose.style.display = 'block';
                renderConversation(content);
            } else if (currentTab === 'files') {
                compose.style.display = 'none';
                renderFiles(content);
            } else {
                compose.style.display = 'none';
                renderDetails(content);
            }
        }

        function renderConversation(container) {
            const isMedia = currentPartner.recipientType === 'media';
            const templateContent = processTemplate(isMedia ? templates.pitch : templates.proposal, currentPartner);
            const messages = currentPartner.messages || [];

            console.log('Rendering conversation with messages:', messages.length);
            messages.forEach((m, i) => {
                console.log(`  Message ${i}: "${m.content?.substring(0, 30)}...", attachments:`, m.attachments);
            });

            let html = '<div class="message-thread">';

            // Initial outbound
            html += `
                <div class="message-item outbound">
                    <div class="message-bubble">
                        <div class="message-header">
                            <span class="message-sender">Luminary</span>
                            <span class="message-time">Initial Outreach</span>
                        </div>
                        <div class="message-body">${formatContent(templateContent)}</div>
                        <div class="message-actions">
                            <button class="message-action-btn" onclick="copyText(\`${escapeBackticks(templateContent)}\`)">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                Copy
                            </button>
                            <button class="message-action-btn" onclick="openModal('templateModal')">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                                Edit
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Messages
            messages.forEach((msg, idx) => {
                // Render attachments if present
                let attachmentsHtml = '';
                if (msg.attachments && msg.attachments.length > 0) {
                    attachmentsHtml = `
                        <div class="message-attachments">
                            ${msg.attachments.map((att, attIdx) => renderMessageAttachment(att, idx, attIdx)).join('')}
                        </div>
                    `;
                }
                
                // Don't show "(File attachment)" as content if there are actual attachments
                const hasAttachments = msg.attachments && Array.isArray(msg.attachments) && msg.attachments.length > 0;
                const displayContent = msg.content === '(File attachment)' && hasAttachments 
                    ? '' 
                    : formatContent(msg.content);
                
                html += `
                    <div class="message-item ${msg.fromLuminary ? 'outbound' : 'inbound'}">
                        <div class="message-bubble">
                            <div class="message-header">
                                <span class="message-sender">${msg.fromLuminary ? 'Luminary' : currentPartner.recipientName}</span>
                                <span class="message-time">${formatDate(msg.date)}</span>
                            </div>
                            <div class="message-body">${displayContent}${attachmentsHtml}</div>
                            <div class="message-actions">
                                <button class="message-action-btn" onclick="copyText(\`${escapeBackticks(msg.content)}\`)">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                    Copy
                                </button>
                                ${msg.fromLuminary ? `
                                    <button class="message-action-btn delete" onclick="confirmDeleteMessage(${idx})">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                        Delete
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
        }
        
        function renderMessageAttachment(att, msgIndex, attIndex) {
            const isImage = att.type && att.type.startsWith('image/');
            const isPDF = att.type === 'application/pdf' || att.name.toLowerCase().endsWith('.pdf');
            const isDoc = att.type && (att.type.includes('word') || att.type.includes('document')) || 
                          att.name.match(/\.(doc|docx)$/i);
            const isSpreadsheet = att.type && (att.type.includes('excel') || att.type.includes('spreadsheet')) ||
                                  att.name.match(/\.(xls|xlsx|csv)$/i);
            const ext = getFileExtension(att.name);
            const size = formatFileSize(att.size);
            const url = att.url || att.data;
            
            // Determine icon/color based on file type
            let iconHtml, iconClass;
            if (isImage) {
                iconHtml = `<img src="${url}" alt="${escapeHtml(att.name)}">`;
                iconClass = 'image';
            } else if (isPDF) {
                iconHtml = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`;
                iconClass = 'pdf';
            } else if (isDoc) {
                iconHtml = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>`;
                iconClass = 'doc';
            } else if (isSpreadsheet) {
                iconHtml = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><rect x="8" y="12" width="8" height="6"></rect></svg>`;
                iconClass = 'spreadsheet';
            } else {
                iconHtml = ext;
                iconClass = 'generic';
            }
            
            // Create a JSON string for the file data to pass to preview
            const fileDataStr = JSON.stringify({
                name: att.name,
                type: att.type,
                size: att.size,
                url: url,
                data: att.data
            }).replace(/"/g, '&quot;');
            
            return `
                <div class="message-attachment ${iconClass}" onclick="openSingleFilePreview(${msgIndex}, ${attIndex})" style="cursor: pointer;">
                    <div class="message-attachment-icon">
                        ${iconHtml}
                    </div>
                    <div class="message-attachment-info">
                        <div class="message-attachment-name">${escapeHtml(att.name)}</div>
                        <div class="message-attachment-size">${size}</div>
                    </div>
                    <div class="attachment-actions">
                        <button class="attachment-preview" onclick="event.stopPropagation(); openSingleFilePreview(${msgIndex}, ${attIndex})" title="Preview">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                        </button>
                        <button class="attachment-download" onclick="event.stopPropagation(); downloadFile('${url}', '${escapeHtml(att.name)}')" title="Download">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Open preview for a single file from conversation
        function openSingleFilePreview(msgIndex, attIndex) {
            if (!currentPartner || !currentPartner.messages) return;
            
            // Collect all files from all messages for navigation
            const allFiles = [];
            let targetIndex = 0;
            
            currentPartner.messages.forEach((msg, mIdx) => {
                if (msg.attachments && msg.attachments.length > 0) {
                    msg.attachments.forEach((att, aIdx) => {
                        if (mIdx === msgIndex && aIdx === attIndex) {
                            targetIndex = allFiles.length;
                        }
                        allFiles.push({
                            ...att,
                            sender: msg.fromLuminary ? 'Luminary' : currentPartner.recipientName,
                            fromLuminary: msg.fromLuminary,
                            date: msg.date,
                            messageContext: msg.content !== '(File attachment)' ? msg.content : ''
                        });
                    });
                }
            });
            
            if (allFiles.length > 0) {
                openDocPreview(allFiles[targetIndex], allFiles, targetIndex);
            }
        }
        
        // Download file helper
        function downloadFile(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.target = '_blank';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        // ===== SPLIT VIEW DOCUMENT PREVIEW SYSTEM =====
        
        let currentPreviewFile = null;
        let currentPreviewIndex = 0;
        let allPreviewFiles = [];
        let currentPreviewTab = 'preview';
        let fileAnnotations = {}; // Store annotations by fileId
        
        // Open document preview in split view
        function openDocPreview(file, allFiles, index) {
            currentPreviewFile = file;
            allPreviewFiles = allFiles || [file];
            currentPreviewIndex = index || 0;
            
            const panel = document.getElementById('detailPanel');
            panel.classList.add('has-preview');
            
            updatePreviewContent();
            updateFileNavigation();
            switchPreviewTab('preview');
        }
        
        // Update preview content based on current file
        function updatePreviewContent() {
            if (!currentPreviewFile) return;
            
            const file = currentPreviewFile;
            const url = file.url || file.data;
            const filename = file.name;
            const type = file.type || '';
            
            // Update header info
            document.getElementById('previewFileName').textContent = filename;
            document.getElementById('previewFileSize').textContent = formatFileSize(file.size);
            document.getElementById('previewFileType').textContent = getFileTypeLabel(type, filename);
            document.getElementById('previewFileSender').textContent = file.sender ? `From ${file.sender}` : '';
            
            // Update viewer content
            const viewer = document.getElementById('previewViewer');
            const isPDF = type === 'application/pdf' || filename.toLowerCase().endsWith('.pdf');
            const isImage = type && type.startsWith('image/');
            
            if (isPDF) {
                viewer.innerHTML = `<iframe src="${url}#toolbar=1&navpanes=0" style="width: 100%; height: 100%; border: none;"></iframe>`;
            } else if (isImage) {
                viewer.innerHTML = `<img src="${url}" alt="${escapeHtml(filename)}" onclick="toggleImageZoom(this)">`;
            } else if (type === 'text/plain' || filename.match(/\.(txt|md|json|js|css|html)$/i)) {
                // Try to display text files
                if (file.data && file.data.startsWith('data:')) {
                    try {
                        const base64 = file.data.split(',')[1];
                        const text = atob(base64);
                        viewer.innerHTML = `<pre style="padding: 1rem; margin: 0; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: var(--text-primary); white-space: pre-wrap; text-align: left; width: 100%; overflow: auto;">${escapeHtml(text)}</pre>`;
                    } catch (e) {
                        showUnsupportedPreview(viewer, filename, url);
                    }
                } else {
                    showUnsupportedPreview(viewer, filename, url);
                }
            } else {
                showUnsupportedPreview(viewer, filename, url);
            }
            
            // Update info tab
            updatePreviewInfo(file);
            
            // Load annotations
            loadAnnotations(file.id);
        }
        
        function showUnsupportedPreview(viewer, filename, url) {
            const ext = getFileExtension(filename);
            const iconClass = getFileIconClass(filename);
            
            viewer.innerHTML = `
                <div class="doc-preview-unsupported">
                    <div class="file-info-icon ${iconClass}">
                        ${getFileIconSVG(filename)}
                    </div>
                    <h4>${escapeHtml(filename)}</h4>
                    <p>Preview not available for this file type</p>
                    <button class="download-btn" onclick="downloadPreviewFile()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                        Download to View
                    </button>
                </div>
            `;
        }
        
        function toggleImageZoom(img) {
            img.classList.toggle('zoomed');
        }
        
        function updatePreviewInfo(file) {
            document.getElementById('infoFileName').textContent = file.name;
            document.getElementById('infoFileType').textContent = getFileTypeLabel(file.type, file.name);
            document.getElementById('infoFileSize').textContent = formatFileSize(file.size);
            document.getElementById('infoSender').textContent = file.sender || '-';
            document.getElementById('infoDate').textContent = file.date ? formatDate(file.date) : '-';
            document.getElementById('infoMessage').textContent = file.messageContext || '-';
            
            // Update icon
            const iconClass = getFileIconClass(file.name);
            const iconEl = document.getElementById('fileInfoIcon');
            iconEl.className = 'file-info-icon ' + iconClass;
            iconEl.innerHTML = getFileIconSVG(file.name);
        }
        
        function getFileTypeLabel(type, filename) {
            if (!type && !filename) return 'Unknown';
            const ext = getFileExtension(filename).toUpperCase();
            if (type === 'application/pdf' || ext === 'PDF') return 'PDF Document';
            if (type && type.startsWith('image/')) return 'Image';
            if (type && type.includes('word') || ext === 'DOC' || ext === 'DOCX') return 'Word Document';
            if (type && type.includes('excel') || ext === 'XLS' || ext === 'XLSX') return 'Spreadsheet';
            if (type && type.includes('powerpoint') || ext === 'PPT' || ext === 'PPTX') return 'Presentation';
            if (ext === 'TXT') return 'Text File';
            return ext || 'File';
        }
        
        function getFileIconClass(filename) {
            const ext = getFileExtension(filename).toLowerCase();
            if (ext === 'pdf') return 'pdf';
            if (['doc', 'docx'].includes(ext)) return 'doc';
            if (['xls', 'xlsx', 'csv'].includes(ext)) return 'xls';
            if (['ppt', 'pptx'].includes(ext)) return 'ppt';
            if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(ext)) return 'image';
            return '';
        }
        
        function getFileIconSVG(filename) {
            const ext = getFileExtension(filename).toLowerCase();
            if (ext === 'pdf') {
                return `<svg fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"></path><path d="M14 2v6h6M9 13h6M9 17h3"/></svg>`;
            }
            return `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>`;
        }
        
        // Close preview panel
        function closeDocPreview() {
            const panel = document.getElementById('detailPanel');
            panel.classList.remove('has-preview');
            currentPreviewFile = null;
            allPreviewFiles = [];
            currentPreviewIndex = 0;
        }
        
        // Switch preview tabs
        function switchPreviewTab(tabName) {
            currentPreviewTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.doc-preview-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.previewTab === tabName);
            });
            
            // Show/hide content
            document.getElementById('previewViewer').style.display = tabName === 'preview' ? 'flex' : 'none';
            document.getElementById('previewComments').style.display = tabName === 'comments' ? 'block' : 'none';
            document.getElementById('previewInfo').style.display = tabName === 'info' ? 'block' : 'none';
        }
        
        // Navigate between files
        function navigatePreviewFile(direction) {
            const newIndex = currentPreviewIndex + direction;
            if (newIndex >= 0 && newIndex < allPreviewFiles.length) {
                currentPreviewIndex = newIndex;
                currentPreviewFile = allPreviewFiles[newIndex];
                updatePreviewContent();
                updateFileNavigation();
            }
        }
        
        function updateFileNavigation() {
            const prevBtn = document.getElementById('btnPrevFile');
            const nextBtn = document.getElementById('btnNextFile');
            const counter = document.getElementById('fileNavCounter');
            
            prevBtn.disabled = currentPreviewIndex === 0;
            nextBtn.disabled = currentPreviewIndex >= allPreviewFiles.length - 1;
            counter.textContent = `${currentPreviewIndex + 1} of ${allPreviewFiles.length}`;
            
            // Hide nav if only one file
            const navContainer = document.querySelector('.doc-preview-nav');
            navContainer.style.display = allPreviewFiles.length > 1 ? 'flex' : 'none';
        }
        
        // Download current preview file
        function downloadPreviewFile() {
            if (!currentPreviewFile) return;
            const url = currentPreviewFile.url || currentPreviewFile.data;
            downloadFile(url, currentPreviewFile.name);
        }
        
        // Fullscreen preview
        function toggleFullscreenPreview() {
            const viewer = document.getElementById('previewViewer');
            if (!document.fullscreenElement) {
                viewer.requestFullscreen?.() || viewer.webkitRequestFullscreen?.();
            } else {
                document.exitFullscreen?.() || document.webkitExitFullscreen?.();
            }
        }
        
        // Open in new tab
        function openPreviewInNewTab() {
            if (!currentPreviewFile) return;
            const url = currentPreviewFile.url || currentPreviewFile.data;
            window.open(url, '_blank');
        }
        
        // ===== ANNOTATIONS/COMMENTS SYSTEM =====
        
        function loadAnnotations(fileId) {
            const annotations = fileAnnotations[fileId] || [];
            renderAnnotations(annotations);
            updateCommentCount(annotations.length);
        }
        
        function renderAnnotations(annotations) {
            const list = document.getElementById('annotationList');
            
            if (annotations.length === 0) {
                list.innerHTML = `
                    <div class="annotation-empty">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/></svg>
                        <p>No comments yet</p>
                        <small>Add comments to discuss this document</small>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = annotations.map((ann, idx) => `
                <div class="annotation-item ${ann.fromPartner ? 'partner' : ''}">
                    <div class="annotation-item-header">
                        <span class="annotation-author">${escapeHtml(ann.author)}</span>
                        <span class="annotation-time">${formatDate(ann.date)}</span>
                    </div>
                    <div class="annotation-text">${escapeHtml(ann.text)}</div>
                    ${!ann.fromPartner ? `
                        <div class="annotation-actions">
                            <button class="annotation-action-btn" onclick="editAnnotation(${idx})">Edit</button>
                            <button class="annotation-action-btn" onclick="deleteAnnotation(${idx})">Delete</button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        function updateCommentCount(count) {
            const badge = document.getElementById('commentCount');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
        }
        
        function toggleAnnotationForm(show) {
            const form = document.getElementById('annotationForm');
            form.classList.toggle('active', show);
            if (show) {
                document.getElementById('annotationInput').focus();
            } else {
                document.getElementById('annotationInput').value = '';
            }
        }
        
        function saveAnnotation() {
            const input = document.getElementById('annotationInput');
            const text = input.value.trim();
            if (!text || !currentPreviewFile) return;
            
            const fileId = currentPreviewFile.id || currentPreviewFile.name;
            if (!fileAnnotations[fileId]) {
                fileAnnotations[fileId] = [];
            }
            
            fileAnnotations[fileId].push({
                id: 'ann_' + Date.now(),
                author: 'Luminary',
                text: text,
                date: new Date().toISOString(),
                fromPartner: false
            });
            
            toggleAnnotationForm(false);
            loadAnnotations(fileId);
            
            // TODO: Save to server
            console.log('Annotation saved:', fileAnnotations[fileId]);
        }
        
        function deleteAnnotation(idx) {
            if (!currentPreviewFile) return;
            const fileId = currentPreviewFile.id || currentPreviewFile.name;
            
            if (fileAnnotations[fileId] && fileAnnotations[fileId][idx]) {
                fileAnnotations[fileId].splice(idx, 1);
                loadAnnotations(fileId);
            }
        }
        
        function editAnnotation(idx) {
            if (!currentPreviewFile) return;
            const fileId = currentPreviewFile.id || currentPreviewFile.name;
            const ann = fileAnnotations[fileId]?.[idx];
            
            if (ann) {
                document.getElementById('annotationInput').value = ann.text;
                toggleAnnotationForm(true);
                // Remove old annotation
                fileAnnotations[fileId].splice(idx, 1);
            }
        }
        
        // Legacy modal preview (keep for fullscreen option)
        function previewFile(url, filename, type) {
            // Instead of modal, open in split view
            openDocPreview({
                name: filename,
                type: type,
                url: url,
                data: url,
                size: 0
            });
        }
        
        function closeFilePreview() {
            closeDocPreview();
        }
        
        // Initialize preview panel event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Preview tab switching
            document.querySelectorAll('.doc-preview-tab').forEach(btn => {
                btn.addEventListener('click', () => switchPreviewTab(btn.dataset.previewTab));
            });
            
            // Preview buttons
            document.getElementById('btnClosePreview')?.addEventListener('click', closeDocPreview);
            document.getElementById('btnPreviewFullscreen')?.addEventListener('click', toggleFullscreenPreview);
            document.getElementById('btnPreviewNewTab')?.addEventListener('click', openPreviewInNewTab);
        });
        
        // Render Files tab
        // Store all files for preview navigation
        let currentConversationFiles = [];
        
        function renderFiles(container) {
            const messages = currentPartner.messages || [];
            
            // Collect all files from all messages
            const allFiles = [];
            messages.forEach((msg, msgIdx) => {
                if (msg.attachments && msg.attachments.length > 0) {
                    msg.attachments.forEach((att, attIdx) => {
                        allFiles.push({
                            ...att,
                            sender: msg.fromLuminary ? 'Luminary' : currentPartner.recipientName,
                            fromLuminary: msg.fromLuminary,
                            date: msg.date,
                            messageContent: msg.content,
                            messageContext: msg.content !== '(File attachment)' ? msg.content : '',
                            globalIndex: allFiles.length
                        });
                    });
                }
            });
            
            // Store globally for preview navigation
            currentConversationFiles = allFiles;
            
            if (allFiles.length === 0) {
                container.innerHTML = `
                    <div class="files-empty">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="64" height="64">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                        </svg>
                        <h3>No Files Shared</h3>
                        <p>Files shared in this conversation will appear here</p>
                    </div>
                `;
                return;
            }
            
            // Group files by type
            const imageFiles = allFiles.filter(f => f.type && f.type.startsWith('image/'));
            const documentFiles = allFiles.filter(f => !f.type || !f.type.startsWith('image/'));
            
            let html = `
                <div class="files-container">
                    <div class="files-header">
                        <h3>Shared Files (${allFiles.length})</h3>
                        <div class="files-actions">
                            <button class="files-download-all" onclick="downloadAllFiles()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                                Download All
                            </button>
                        </div>
                    </div>
            `;
            
            // Images section
            if (imageFiles.length > 0) {
                html += `
                    <div class="files-section">
                        <h4 class="files-section-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                            Images (${imageFiles.length})
                        </h4>
                        <div class="files-grid images">
                            ${imageFiles.map(f => renderFileCard(f, true)).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Documents section
            if (documentFiles.length > 0) {
                html += `
                    <div class="files-section">
                        <h4 class="files-section-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                            Documents (${documentFiles.length})
                        </h4>
                        <div class="files-list">
                            ${documentFiles.map(f => renderFileCard(f, false)).join('')}
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function openFilePreview(index) {
            if (currentConversationFiles.length > 0 && index >= 0 && index < currentConversationFiles.length) {
                openDocPreview(currentConversationFiles[index], currentConversationFiles, index);
            }
        }
        
        function renderFileCard(file, isImage) {
            const url = file.url || file.data;
            const ext = getFileExtension(file.name);
            const size = formatFileSize(file.size);
            const date = formatDate(file.date);
            const isPDF = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');
            const fileIndex = file.globalIndex;
            
            if (isImage) {
                return `
                    <div class="file-card image-card" onclick="openFilePreview(${fileIndex})">
                        <div class="file-card-preview">
                            <img src="${url}" alt="${escapeHtml(file.name)}">
                        </div>
                        <div class="file-card-info">
                            <div class="file-card-name" title="${escapeHtml(file.name)}">${escapeHtml(file.name)}</div>
                            <div class="file-card-meta">
                                <span class="file-card-sender ${file.fromLuminary ? 'luminary' : 'partner'}">${escapeHtml(file.sender)}</span>
                                <span class="file-card-date">${date}</span>
                            </div>
                        </div>
                        <div class="file-card-actions">
                            <button onclick="event.stopPropagation(); downloadFile('${url}', '${escapeHtml(file.name)}')" title="Download">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                            </button>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="file-card document-card" onclick="openFilePreview(${fileIndex})">
                        <div class="file-card-icon ${ext.toLowerCase()}">
                            ${getFileIcon(file.type, file.name)}
                        </div>
                        <div class="file-card-info">
                            <div class="file-card-name" title="${escapeHtml(file.name)}">${escapeHtml(file.name)}</div>
                            <div class="file-card-meta">
                                <span class="file-card-size">${size}</span>
                                <span class="file-card-sender ${file.fromLuminary ? 'luminary' : 'partner'}">${escapeHtml(file.sender)}</span>
                                <span class="file-card-date">${date}</span>
                            </div>
                            ${file.messageContent && file.messageContent !== '(File attachment)' ? 
                                `<div class="file-card-context">"${escapeHtml(truncateText(file.messageContent, 50))}"</div>` : ''}
                        </div>
                        <div class="file-card-actions">
                            <button onclick="event.stopPropagation(); openFilePreview(${fileIndex})" title="Preview">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                            </button>
                            <button onclick="event.stopPropagation(); downloadFile('${url}', '${escapeHtml(file.name)}')" title="Download">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                            </button>
                        </div>
                    </div>
                `;
            }
        }
        
        function getFileIcon(type, name) {
            const isPDF = type === 'application/pdf' || name.toLowerCase().endsWith('.pdf');
            const isDoc = type && (type.includes('word') || type.includes('document')) || name.match(/\.(doc|docx)$/i);
            const isSpreadsheet = type && (type.includes('excel') || type.includes('spreadsheet')) || name.match(/\.(xls|xlsx|csv)$/i);
            const isPPT = type && type.includes('presentation') || name.match(/\.(ppt|pptx)$/i);
            
            if (isPDF) {
                return `<svg viewBox="0 0 24 24" fill="none" stroke="#E74C3C" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><text x="8" y="17" font-size="6" fill="#E74C3C">PDF</text></svg>`;
            } else if (isDoc) {
                return `<svg viewBox="0 0 24 24" fill="none" stroke="#2B579A" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><text x="7" y="17" font-size="5" fill="#2B579A">DOC</text></svg>`;
            } else if (isSpreadsheet) {
                return `<svg viewBox="0 0 24 24" fill="none" stroke="#217346" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><text x="7" y="17" font-size="5" fill="#217346">XLS</text></svg>`;
            } else if (isPPT) {
                return `<svg viewBox="0 0 24 24" fill="none" stroke="#D24726" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><text x="7" y="17" font-size="5" fill="#D24726">PPT</text></svg>`;
            } else {
                return `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>`;
            }
        }
        
        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }
        
        function downloadAllFiles() {
            const messages = currentPartner.messages || [];
            messages.forEach(msg => {
                if (msg.attachments && msg.attachments.length > 0) {
                    msg.attachments.forEach(att => {
                        const url = att.url || att.data;
                        downloadFile(url, att.name);
                    });
                }
            });
        }

        function renderDetails(container) {
            const p = currentPartner;
            const isMedia = p.recipientType === 'media';
            const partnerEmail = p.email || p.contactEmail || '';

            container.innerHTML = `
                <div class="details-grid">
                    <div class="detail-card">
                        <div class="detail-card-title">Contact Information</div>
                        <div class="detail-row">
                            <span class="detail-row-label">Access Key</span>
                            <span class="detail-row-value"><span class="key-display">${p.id}</span></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-row-label">Type</span>
                            <span class="detail-row-value">${isMedia ? 'Media' : 'University'}</span>
                        </div>
                        <div class="detail-row email-row">
                            <span class="detail-row-label">Email</span>
                            <span class="detail-row-value">
                                <div class="email-edit-container">
                                    <input type="email" 
                                           id="partnerEmailInput" 
                                           class="email-input" 
                                           value="${escapeHtml(partnerEmail)}" 
                                           placeholder="Enter email address">
                                    <button class="email-save-btn" onclick="savePartnerEmail()" title="Save email">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                    </button>
                                </div>
                                ${partnerEmail ? 
                                    `<a href="mailto:${escapeHtml(partnerEmail)}" class="email-link">${escapeHtml(partnerEmail)}</a>` : 
                                    `<span class="no-email-warning">No email - cannot send press releases</span>`
                                }
                            </span>
                        </div>
                        ${!isMedia ? `
                            <div class="detail-row">
                                <span class="detail-row-label">University</span>
                                <span class="detail-row-value">${escapeHtml(p.universityName || 'N/A')}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-row-label">State</span>
                                <span class="detail-row-value">${escapeHtml(p.state || 'N/A')}</span>
                            </div>
                        ` : `
                            <div class="detail-row">
                                <span class="detail-row-label">Category</span>
                                <span class="detail-row-value">${escapeHtml(p.category || p.focus || 'N/A')}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-row-label">Location</span>
                                <span class="detail-row-value">${escapeHtml(p.location || 'N/A')}</span>
                            </div>
                        `}
                        <div class="detail-row">
                            <span class="detail-row-label">Status</span>
                            <span class="detail-row-value"><span class="status-indicator ${p.status}">${p.status}</span></span>
                        </div>
                    </div>
                    
                    <div class="detail-card ai-drafting-card">
                        <div class="detail-card-title">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="18" height="18"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                            Proposal Tools
                        </div>
                        <p class="ai-description">Build data-backed proposals with transparent investment rationale</p>
                        
                        <button class="ai-btn" onclick="openResearchHub()" style="grid-column: span 2; background: linear-gradient(135deg, rgba(212, 168, 83, 0.15) 0%, rgba(212, 168, 83, 0.05) 100%); border-color: var(--gold-primary); margin-bottom: 0.5rem;">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>
                            <span style="color: var(--gold-primary); font-weight: 600;">Open Research Hub</span>
                        </button>
                        
                        <button class="ai-btn" onclick="openProposalWizard()" style="grid-column: span 2; margin-bottom: 0.5rem;">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                            Create Proposal
                        </button>
                        
                        <button class="ai-btn" onclick="openDocReview()" style="grid-column: span 2;">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                            Review Document
                        </button>
                        
                        <div class="ai-actions" style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-subtle);">
                            <button class="ai-btn" onclick="generateAIDraft('pitch')">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                                Draft Pitch
                            </button>
                            <button class="ai-btn" onclick="generateAIDraft('followup')">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/></svg>
                                Follow-up
                            </button>
                            <button class="ai-btn" onclick="generateAIDraft('contract')">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                Partnership Agreement
                            </button>
                            <button class="ai-btn research" onclick="generateAIDraft('research')">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                                Research Partner
                            </button>
                        </div>
                        <div class="ai-output" id="aiOutputContainer" style="display: none;">
                            <div class="ai-output-header">
                                <span>AI Generated Content</span>
                                <div class="ai-output-actions">
                                    <button onclick="copyAIOutput()" title="Copy to clipboard">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                    </button>
                                    <button onclick="useAIOutput()" title="Use in message">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                                    </button>
                                    <button onclick="closeAIOutput()" title="Close">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="ai-output-content" id="aiOutputContent"></div>
                        </div>
                    </div>
                    
                    <div class="detail-card">
                        <div class="detail-card-title">Branding</div>
                        <div class="detail-row">
                            <span class="detail-row-label">Primary</span>
                            <span class="detail-row-value"><div class="color-swatch-row"><div class="color-swatch" style="background:${p.colors?.primary || '#003366'}"></div>${p.colors?.primary || '#003366'}</div></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-row-label">Secondary</span>
                            <span class="detail-row-value"><div class="color-swatch-row"><div class="color-swatch" style="background:${p.colors?.secondary || '#D4A853'}"></div>${p.colors?.secondary || '#D4A853'}</div></span>
                        </div>
                    </div>
                    
                    <div class="detail-card">
                        <div class="detail-card-title">Additional Contacts</div>
                        ${(p.contacts || []).map(c => `
                            <div class="contact-card">
                                <div class="contact-name">${escapeHtml(c.name || 'N/A')}</div>
                                <div class="contact-title">${escapeHtml(c.title || c.type || '')}</div>
                                <div class="contact-email">${escapeHtml(c.email || '')}</div>
                            </div>
                        `).join('') || '<p style="color:var(--text-muted)">No additional contacts</p>'}
                    </div>
                </div>
            `;
        }

        // ===== MESSAGING =====
        let adminPendingFiles = [];
        const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        function getFileExtension(filename) {
            return filename.split('.').pop().toUpperCase();
        }
        
        function handleAdminFileSelect(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                if (file.size > MAX_FILE_SIZE) {
                    alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
                    return;
                }
                adminPendingFiles.push(file);
            });
            renderAdminFilePreview();
            event.target.value = '';
        }
        
        function renderAdminFilePreview() {
            const container = document.getElementById('adminFilePreview');
            container.innerHTML = adminPendingFiles.map((file, index) => {
                const isImage = file.type.startsWith('image/');
                const ext = file.name.split('.').pop().toUpperCase();
                const size = formatFileSize(file.size);
                return `
                    <div class="file-preview-item">
                        ${isImage ? `<img src="${URL.createObjectURL(file)}" alt="${file.name}">` 
                                  : `<div class="file-icon">${ext}</div>`}
                        <div class="file-preview-info">
                            <div class="file-preview-name">${file.name}</div>
                            <div class="file-preview-size">${size}</div>
                        </div>
                        <button class="file-preview-remove" onclick="removeAdminFile(${index})">&times;</button>
                    </div>
                `;
            }).join('');
        }
        
        function removeAdminFile(index) {
            adminPendingFiles.splice(index, 1);
            renderAdminFilePreview();
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        async function uploadAdminFiles(files) {
            if (!files.length) return [];
            const uploadedFiles = [];
            
            for (const file of files) {
                try {
                    const base64 = await fileToBase64(file);
                    console.log(`Admin uploading file: ${file.name}, size: ${file.size}`);
                    
                    // Try to upload to R2 via API
                    try {
                        const response = await fetch(`${API_BASE}/api/admin/files/upload`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${authToken}`
                            },
                            body: JSON.stringify({
                                partnerId: currentPartner.id,
                                filename: file.name,
                                contentType: file.type,
                                data: base64,
                                size: file.size
                            })
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            console.log('R2 upload success:', result);
                            uploadedFiles.push({
                                id: result.fileId,
                                name: file.name,
                                type: file.type,
                                size: file.size,
                                url: result.url
                            });
                            continue;
                        } else {
                            const errText = await response.text();
                            console.warn('R2 upload failed:', response.status, errText);
                        }
                    } catch (r2Error) {
                        console.warn('R2 upload error:', r2Error);
                    }
                    
                    // Fallback to base64 if R2 upload fails
                    console.log('Using base64 fallback for:', file.name);
                    uploadedFiles.push({
                        id: 'local_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: base64
                    });
                    
                } catch (error) {
                    console.error('File processing error:', error);
                }
            }
            
            console.log('Admin uploaded files:', uploadedFiles.map(f => ({ name: f.name, hasUrl: !!f.url, hasData: !!f.data })));
            return uploadedFiles;
        }
        
        // Image lightbox
        function openLightbox(src) {
            let lightbox = document.getElementById('imageLightbox');
            if (!lightbox) {
                lightbox = document.createElement('div');
                lightbox.id = 'imageLightbox';
                lightbox.className = 'image-lightbox';
                lightbox.innerHTML = `
                    <button class="image-lightbox-close" onclick="closeLightbox()">&times;</button>
                    <img src="" alt="Full size">
                `;
                lightbox.addEventListener('click', (e) => {
                    if (e.target === lightbox) closeLightbox();
                });
                document.body.appendChild(lightbox);
            }
            lightbox.querySelector('img').src = src;
            lightbox.classList.add('active');
        }
        
        function closeLightbox() {
            const lightbox = document.getElementById('imageLightbox');
            if (lightbox) lightbox.classList.remove('active');
        }
        
        async function sendMessage() {
            const content = document.getElementById('composeEditor').value.trim();
            if (!content && adminPendingFiles.length === 0) return;
            if (!currentPartner) return;

            showSaveIndicator('saving');
            
            try {
                // Upload files
                let attachments = [];
                if (adminPendingFiles.length > 0) {
                    console.log('Admin: uploading files...');
                    attachments = await uploadAdminFiles(adminPendingFiles);
                    console.log('Admin: upload complete, attachments:', attachments);
                }
                
                const payload = {
                    partnerId: currentPartner.id,
                    content: content || '(File attachment)',
                    attachments: attachments
                };
                console.log('Admin: sending message payload:', { ...payload, attachments: payload.attachments.map(a => ({ name: a.name, hasUrl: !!a.url, hasData: !!a.data })) });
                
                const response = await fetch(`${API_BASE}/api/admin/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errText = await response.text();
                    console.error('Admin: send message failed:', response.status, errText);
                    throw new Error('Failed to send message');
                }
                
                const data = await response.json();
                console.log('Admin: message sent, response:', data);
                
                // Ensure attachments are preserved
                if (attachments.length > 0 && (!data.message.attachments || data.message.attachments.length === 0)) {
                    console.log('Admin: preserving local attachments');
                    data.message.attachments = attachments;
                }
                
                // Add message to local state
                if (!currentPartner.messages) currentPartner.messages = [];
                currentPartner.messages.push(data.message);
                currentPartner.lastActivity = new Date().toISOString();
                
                document.getElementById('composeEditor').value = '';
                adminPendingFiles = [];
                renderAdminFilePreview();
                
                showSaveIndicator('saved');
                renderCurrentTab();
                renderPartnerList();
                updateCounts();
                
            } catch (error) {
                console.error('Send message error:', error);
                showSaveIndicator('error');
            }
        }

        function confirmDeleteMessage(idx) {
            document.getElementById('confirmTitle').textContent = 'Delete Message?';
            document.getElementById('confirmText').textContent = 'This will permanently remove this message.';
            document.getElementById('confirmAction').onclick = () => deleteMessage(idx);
            openModal('confirmModal');
        }

        async function deleteMessage(idx) {
            if (!currentPartner || !currentPartner.messages || !currentPartner.messages[idx]) {
                closeModal('confirmModal');
                return;
            }
            
            const messageId = currentPartner.messages[idx].id;
            showSaveIndicator('saving');
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/messages/${messageId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to delete message');
                
                currentPartner.messages.splice(idx, 1);
                currentPartner.lastActivity = new Date().toISOString();
                
                showSaveIndicator('saved');
                renderCurrentTab();
                renderPartnerList();
                
            } catch (error) {
                console.error('Delete message error:', error);
                showSaveIndicator('error');
            }
            
            closeModal('confirmModal');
        }

        // ===== TEMPLATES =====
        function processTemplate(template, partner) {
            return template
                .replace(/\{\{partnerName\}\}/g, partner.recipientName || '')
                .replace(/\{\{schoolName\}\}/g, partner.schoolName || partner.recipientName || '')
                .replace(/\{\{universityName\}\}/g, partner.universityName || '')
                .replace(/\{\{outletName\}\}/g, partner.outletName || partner.recipientName || '')
                .replace(/\{\{focus\}\}/g, partner.focus || '')
                .replace(/\{\{state\}\}/g, partner.state || '');
        }

        function loadTemplateContent() {
            const type = document.getElementById('templateType').value;
            document.getElementById('templateEditor').value = templates[type] || '';
        }

        function saveTemplateChanges() {
            const type = document.getElementById('templateType').value;
            templates[type] = document.getElementById('templateEditor').value;
            localStorage.setItem(TEMPLATES_KEY, JSON.stringify(templates));
            closeModal('templateModal');
            if (currentPartner) renderCurrentTab();
            showSaveIndicator('saved');
        }

        function insertQuickReply(type) {
            const template = templates[type] || '';
            const processed = currentPartner ? processTemplate(template, currentPartner) : template;
            document.getElementById('composeEditor').value = processed;
            closeModal('quickReplyModal');
        }

        // ===== IMPORT/EXPORT =====
        function exportData() {
            const data = {
                partners: allPartners,
                templates: templates,
                exportDate: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `luminary-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        document.getElementById('importFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    
                    // Import partners via API
                    if (data.partners) {
                        showSaveIndicator('saving');
                        
                        // Convert to array if it's an object
                        let partnersArray = Array.isArray(data.partners) 
                            ? data.partners 
                            : Object.values(data.partners);
                        
                        const response = await fetch(`${API_BASE}/api/admin/import`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${authToken}`
                            },
                            body: JSON.stringify({ partners: partnersArray })
                        });
                        
                        if (!response.ok) throw new Error('Import failed');
                        
                        const result = await response.json();
                        console.log(`Imported ${result.insertedCount} partners`);
                        
                        // Reload data from API
                        await loadPartnerData();
                        showSaveIndicator('saved');
                    }
                    
                    // Templates still stored locally
                    if (data.templates) {
                        templates = { ...templates, ...data.templates };
                        localStorage.setItem(TEMPLATES_KEY, JSON.stringify(templates));
                    }
                    
                    alert('Data imported successfully!');
                } catch (err) {
                    console.error('Import error:', err);
                    alert('Import failed: ' + err.message);
                    showSaveIndicator('error');
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        });

        // ===== UTILITIES =====
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => showSaveIndicator('saved'));
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeBackticks(text) {
            if (!text) return '';
            return text.replace(/`/g, '\\`').replace(/\$/g, '\\$');
        }

        function formatDate(d) {
            if (!d) return '';
            return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
        }

        function formatRelativeTime(d) {
            if (!d) return '';
            const diff = Date.now() - new Date(d).getTime();
            const mins = Math.floor(diff / 60000);
            if (mins < 60) return mins + 'm';
            const hrs = Math.floor(diff / 3600000);
            if (hrs < 24) return hrs + 'h';
            const days = Math.floor(diff / 86400000);
            if (days < 7) return days + 'd';
            return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function formatContent(text) {
            return text.replace(/\n/g, '<br>');
        }

        function escapeBackticks(str) {
            return str.replace(/`/g, '\\`').replace(/\$/g, '\\$');
        }

        async function markStatus() {
            if (!currentPartner) return;
            
            let newStatus;
            if (currentPartner.status === 'pending') newStatus = 'viewed';
            else if (currentPartner.status === 'viewed') newStatus = 'responded';
            else return;
            
            showSaveIndicator('saving');
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/partners/status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        partnerId: currentPartner.id,
                        status: newStatus
                    })
                });
                
                if (!response.ok) throw new Error('Failed to update status');
                
                currentPartner.status = newStatus;
                showSaveIndicator('saved');
                updateStatusButton();
                renderPartnerList();
                updateCounts();
                
            } catch (error) {
                console.error('Mark status error:', error);
                showSaveIndicator('error');
            }
        }

        function copyKey() {
            if (currentPartner) copyText(currentPartner.id);
        }

        // ===== EVENT LISTENERS =====
        document.addEventListener('DOMContentLoaded', () => {
            if (!checkAuth()) {
                document.getElementById('accessCode').focus();
            }

            // Nav items
            document.querySelectorAll('.nav-item[data-view]').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    currentView = item.dataset.view;
                    document.getElementById('listTitle').textContent = item.textContent.trim().split(/\d/)[0].trim();
                    renderPartnerList();
                });
            });

            // Actions
            document.querySelectorAll('.nav-item[data-action]').forEach(item => {
                item.addEventListener('click', () => {
                    const action = item.dataset.action;
                    if (action === 'templates') { loadTemplateContent(); openModal('templateModal'); }
                    if (action === 'export') exportData();
                    if (action === 'import') importData();
                    if (action === 'refresh') refreshData();
                    if (action === 'pressRelease') openPressReleaseModal();
                    if (action === 'pressHistory') openPressHistoryModal();
                });
            });

            // Filters
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    currentFilter = chip.dataset.filter;
                    renderPartnerList();
                });
            });

            // Tabs
            document.querySelectorAll('.detail-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.detail-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentTab = tab.dataset.tab;
                    renderCurrentTab();
                });
            });

            // Search
            document.getElementById('searchInput').addEventListener('input', renderPartnerList);

            // Compose
            document.getElementById('composeEditor').addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'Enter') sendMessage();
            });

            // Buttons
            document.getElementById('btnCopyKey').addEventListener('click', copyKey);
            document.getElementById('btnMarkStatus').addEventListener('click', markStatus);
            document.getElementById('btnInsertTemplate').addEventListener('click', () => openModal('quickReplyModal'));
            document.getElementById('btnSendMessage').addEventListener('click', sendMessage);
            document.getElementById('btnAttachFile').addEventListener('click', () => document.getElementById('adminFileInput').click());
            document.getElementById('adminFileInput').addEventListener('change', handleAdminFileSelect);

            // Escape to close modals
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeModal('templateModal');
                    closeModal('quickReplyModal');
                    closeModal('confirmModal');
                    closeLightbox();
                }
            });
        });
    </script>
</body>
</html>
