<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luminary | Communications Command Center</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600&family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #0a0a0f;
            --bg-card: #12121a;
            --bg-elevated: #1a1a24;
            --bg-input: #0d0d12;
            --gold-primary: #D4A853;
            --gold-light: #E8C875;
            --gold-dark: #B8923F;
            --text-primary: #F5F5F5;
            --text-secondary: #A0A0A0;
            --text-muted: #666;
            --border-subtle: rgba(212, 168, 83, 0.2);
            --border-strong: rgba(212, 168, 83, 0.4);
            --success: #4ade80;
            --success-bg: rgba(74, 222, 128, 0.1);
            --warning: #fbbf24;
            --warning-bg: rgba(251, 191, 36, 0.1);
            --error: #f87171;
            --error-bg: rgba(248, 113, 113, 0.1);
            --info: #60a5fa;
            --info-bg: rgba(96, 165, 250, 0.1);
            --media-accent: #FF6B35;
            --media-bg: rgba(255, 107, 53, 0.1);
            --university-accent: #D4A853;
            --university-bg: rgba(212, 168, 83, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Cormorant Garamond', Georgia, serif; 
            background: var(--bg-deep); 
            color: var(--text-primary); 
            min-height: 100vh;
            font-size: 16px;
            line-height: 1.6;
        }

        /* ===== LOGIN GATE ===== */
        .login-gate {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-deep);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-gate.hidden { display: none; }

        .login-container {
            width: 100%;
            max-width: 420px;
            padding: 2rem;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .login-logo svg {
            width: 48px;
            height: 48px;
            color: var(--gold-primary);
            margin-bottom: 1rem;
        }

        .login-logo h1 {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            letter-spacing: 0.2em;
            color: var(--gold-primary);
            margin-bottom: 0.25rem;
        }

        .login-logo p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            letter-spacing: 0.1em;
        }

        .login-box {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 2rem;
        }

        .login-title {
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            text-align: center;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .login-field {
            margin-bottom: 1.25rem;
        }

        .login-label {
            display: block;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .login-input {
            width: 100%;
            padding: 0.85rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            letter-spacing: 0.15em;
            text-align: center;
            transition: all 0.2s ease;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--gold-primary);
            box-shadow: 0 0 0 3px rgba(212, 168, 83, 0.1);
        }

        .login-input.error {
            border-color: var(--error);
            animation: shake 0.4s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        .login-btn {
            width: 100%;
            padding: 0.9rem;
            background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
            border: none;
            border-radius: 6px;
            color: var(--bg-deep);
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            font-weight: 600;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(212, 168, 83, 0.3);
        }

        .login-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .login-error {
            margin-top: 1rem;
            padding: 0.75rem;
            background: var(--error-bg);
            border: 1px solid var(--error);
            border-radius: 6px;
            color: var(--error);
            font-size: 0.85rem;
            text-align: center;
            display: none;
        }

        .login-error.visible { display: block; }

        .login-footer {
            margin-top: 1.5rem;
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* ===== APP CONTAINER ===== */
        .app-container { 
            display: none;
            grid-template-columns: 260px 380px 1fr; 
            height: 100vh; 
            overflow: hidden;
        }

        .app-container.active { display: grid; }

        /* ===== SAVE INDICATOR ===== */
        .save-indicator {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            padding: 0.6rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 100;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(10px);
        }

        .save-indicator.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .save-indicator.saving { color: var(--warning); border-color: var(--warning); }
        .save-indicator.saved { color: var(--success); border-color: var(--success); }
        .save-indicator.error { color: var(--error); border-color: var(--error); }

        .save-indicator svg { width: 14px; height: 14px; }

        /* ===== SIDEBAR ===== */
        .sidebar {
            background: var(--bg-card);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border-subtle);
        }

        .logo-row {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            margin-bottom: 0.35rem;
        }

        .logo-row svg { height: 24px; width: 24px; color: var(--gold-primary); }

        .logo-text {
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            color: var(--gold-primary);
            letter-spacing: 0.15em;
        }

        .logo-subtitle {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .sidebar-nav { flex: 1; overflow-y: auto; padding: 0.75rem 0; }

        .nav-group { margin-bottom: 1.25rem; }

        .nav-group-title {
            font-family: 'Cinzel', serif;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--text-muted);
            padding: 0.5rem 1.25rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.65rem;
            padding: 0.6rem 1.25rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
            border-left: 2px solid transparent;
            font-size: 0.9rem;
        }

        .nav-item:hover { background: rgba(255,255,255,0.02); color: var(--text-primary); }
        .nav-item.active { 
            background: var(--university-bg); 
            color: var(--gold-primary); 
            border-left-color: var(--gold-primary); 
        }

        .nav-item svg { width: 18px; height: 18px; opacity: 0.7; flex-shrink: 0; }
        .nav-item.active svg { opacity: 1; }

        .nav-badge {
            margin-left: auto;
            background: var(--gold-primary);
            color: var(--bg-deep);
            font-size: 0.65rem;
            font-weight: 600;
            padding: 0.1rem 0.45rem;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
        }

        .nav-badge.media { background: var(--media-accent); }
        .nav-badge.success { background: var(--success); }
        .nav-badge.warning { background: var(--warning); color: var(--bg-deep); }
        .nav-badge.unread { background: var(--error); animation: pulse 2s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .sidebar-footer {
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--border-subtle);
        }

        .logout-btn {
            width: 100%;
            padding: 0.6rem;
            background: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.15s ease;
        }

        .logout-btn:hover { border-color: var(--error); color: var(--error); }
        .logout-btn svg { width: 14px; height: 14px; }

        /* ===== LIST PANEL ===== */
        .list-panel {
            background: var(--bg-deep);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .list-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-card);
        }

        .list-header-title {
            font-family: 'Cinzel', serif;
            font-size: 0.95rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .list-search {
            display: flex;
            align-items: center;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            gap: 0.5rem;
        }

        .list-search svg { width: 16px; height: 16px; color: var(--text-muted); flex-shrink: 0; }

        .list-search input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
            outline: none;
        }

        .list-search input::placeholder { color: var(--text-muted); }

        .list-filters {
            display: flex;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            background: var(--bg-card);
        }

        .filter-chip {
            padding: 0.35rem 0.7rem;
            background: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .filter-chip:hover { border-color: var(--gold-primary); color: var(--text-primary); }
        .filter-chip.active { background: var(--gold-primary); border-color: var(--gold-primary); color: var(--bg-deep); }

        .list-content { flex: 1; overflow-y: auto; }

        .partner-item {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            cursor: pointer;
            transition: background 0.15s ease;
            position: relative;
        }

        .partner-item:hover { background: rgba(255,255,255,0.02); }
        .partner-item.active { background: var(--university-bg); }
        .partner-item.unread::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--gold-primary);
        }

        .partner-item-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 0.35rem;
        }

        .partner-item-name {
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-primary);
            line-height: 1.3;
        }

        .partner-item-time {
            font-size: 0.7rem;
            color: var(--text-muted);
            white-space: nowrap;
            margin-left: 0.5rem;
        }

        .partner-item-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.35rem;
        }

        .type-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .type-dot.university { background: var(--gold-primary); }
        .type-dot.media { background: var(--media-accent); }

        .partner-item-detail {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .partner-item-preview {
            font-size: 0.8rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .status-indicator.pending { background: var(--warning-bg); color: var(--warning); }
        .status-indicator.viewed { background: var(--info-bg); color: var(--info); }
        .status-indicator.responded { background: var(--success-bg); color: var(--success); }
        .status-indicator.accepted { background: var(--success-bg); color: var(--success); }

        /* ===== DETAIL PANEL ===== */
        .detail-panel {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-deep);
        }

        .detail-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .detail-header-info h2 {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 0.2rem;
        }

        .detail-header-info p {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .detail-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            padding: 0.45rem 0.85rem;
            background: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .action-btn:hover { border-color: var(--gold-primary); color: var(--gold-primary); }
        .action-btn svg { width: 14px; height: 14px; }

        .action-btn.primary {
            background: var(--gold-primary);
            border-color: var(--gold-primary);
            color: var(--bg-deep);
        }

        .action-btn.primary:hover { background: var(--gold-light); }

        .action-btn.danger { border-color: var(--error); color: var(--error); }
        .action-btn.danger:hover { background: var(--error-bg); }

        /* Tabs */
        .detail-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-card);
        }

        .detail-tab {
            padding: 0.85rem 1.25rem;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            font-family: 'Cinzel', serif;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .detail-tab:hover { color: var(--text-primary); }
        .detail-tab.active { color: var(--gold-primary); border-bottom-color: var(--gold-primary); }

        /* Conversation Thread */
        .detail-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .message-thread { display: flex; flex-direction: column; gap: 1.25rem; }

        .message-item {
            max-width: 85%;
            position: relative;
        }

        .message-item.outbound { align-self: flex-start; }
        .message-item.inbound { align-self: flex-end; }

        .message-bubble {
            padding: 1rem 1.25rem;
            border-radius: 12px;
            position: relative;
        }

        .message-item.outbound .message-bubble {
            background: linear-gradient(135deg, rgba(212, 168, 83, 0.15) 0%, rgba(212, 168, 83, 0.05) 100%);
            border: 1px solid rgba(212, 168, 83, 0.25);
            border-radius: 12px 12px 12px 2px;
        }

        .message-item.inbound .message-bubble {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 12px 12px 2px 12px;
        }

        .message-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .message-sender {
            font-family: 'Cinzel', serif;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--gold-primary);
        }

        .message-item.inbound .message-sender { color: var(--text-secondary); }

        .message-time {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .message-body {
            font-size: 0.9rem;
            line-height: 1.7;
            color: var(--text-primary);
        }

        .message-body p { margin-bottom: 0.75rem; }
        .message-body p:last-child { margin-bottom: 0; }
        .message-body strong { color: var(--gold-light); }

        .message-actions {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(255,255,255,0.05);
            display: flex;
            gap: 0.75rem;
        }

        .message-action-btn {
            font-size: 0.7rem;
            color: var(--text-muted);
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.15s ease;
        }

        .message-action-btn:hover { color: var(--gold-primary); background: rgba(212, 168, 83, 0.1); }
        .message-action-btn.delete:hover { color: var(--error); background: var(--error-bg); }
        .message-action-btn svg { width: 12px; height: 12px; }

        /* Compose Area */
        .compose-area {
            padding: 1.25rem 1.5rem;
            border-top: 1px solid var(--border-subtle);
            background: var(--bg-card);
        }

        .compose-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .compose-label {
            font-family: 'Cinzel', serif;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
        }

        .compose-tools {
            display: flex;
            gap: 0.5rem;
        }

        .tool-btn {
            width: 28px;
            height: 28px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .tool-btn:hover { border-color: var(--gold-primary); color: var(--gold-primary); }
        .tool-btn svg { width: 14px; height: 14px; }

        .compose-editor {
            width: 100%;
            min-height: 100px;
            max-height: 200px;
            padding: 0.85rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            line-height: 1.6;
            resize: vertical;
            transition: border-color 0.15s ease;
        }

        .compose-editor:focus { outline: none; border-color: var(--gold-primary); }
        .compose-editor::placeholder { color: var(--text-muted); }

        .compose-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 0.85rem;
        }

        .compose-info {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .compose-buttons { display: flex; gap: 0.5rem; }

        /* Empty State */
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            text-align: center;
            padding: 2rem;
        }

        .empty-state svg { width: 48px; height: 48px; margin-bottom: 1rem; opacity: 0.3; }
        .empty-state h3 { font-family: 'Cinzel', serif; font-size: 1rem; margin-bottom: 0.5rem; color: var(--text-secondary); }
        .empty-state p { font-size: 0.85rem; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }

        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal {
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            transform: translateY(20px);
            transition: transform 0.2s ease;
        }

        .modal-overlay.active .modal { transform: translateY(0); }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
        }

        .modal-close:hover { color: var(--text-primary); }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Form Elements */
        .form-group { margin-bottom: 1.25rem; }

        .form-label {
            display: block;
            font-family: 'Cinzel', serif;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            transition: border-color 0.15s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--gold-primary);
        }

        .form-textarea {
            min-height: 250px;
            line-height: 1.7;
            resize: vertical;
        }

        .form-help {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.35rem;
        }

        .variable-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .variable-chip {
            padding: 0.3rem 0.6rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--gold-primary);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .variable-chip:hover { background: var(--university-bg); border-color: var(--gold-primary); }

        /* Partner Details */
        .details-grid {
            display: grid;
            gap: 1.25rem;
        }

        .detail-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 1.25rem;
        }

        .detail-card-title {
            font-family: 'Cinzel', serif;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--gold-primary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-subtle);
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 0.5rem 0;
            font-size: 0.85rem;
        }

        .detail-row-label { color: var(--text-secondary); }
        .detail-row-value { color: var(--text-primary); text-align: right; max-width: 60%; }

        .key-display {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            background: var(--bg-input);
            padding: 0.3rem 0.5rem;
            border-radius: 4px;
            letter-spacing: 0.05em;
        }

        .color-swatch-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .color-swatch {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .contact-card {
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }

        .contact-card:last-child { border-bottom: none; padding-bottom: 0; }

        .contact-name { font-weight: 500; margin-bottom: 0.2rem; }
        .contact-title { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.15rem; }
        .contact-email { font-size: 0.8rem; color: var(--gold-primary); }

        /* Confirm Dialog */
        .confirm-dialog {
            max-width: 400px;
        }

        .confirm-dialog .modal-body {
            text-align: center;
            padding: 2rem;
        }

        .confirm-dialog .confirm-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem;
            color: var(--warning);
        }

        .confirm-dialog h4 {
            font-family: 'Cinzel', serif;
            margin-bottom: 0.5rem;
        }

        .confirm-dialog p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-subtle); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gold-dark); }

        /* Responsive */
        @media (max-width: 1200px) {
            .app-container { grid-template-columns: 220px 320px 1fr; }
        }

        @media (max-width: 900px) {
            .app-container { grid-template-columns: 1fr; }
            .sidebar, .list-panel { display: none; }
        }
    </style>
</head>
<body>
    <!-- ===== LOGIN GATE ===== -->
    <div class="login-gate" id="loginGate">
        <div class="login-container">
            <div class="login-logo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                <h1>LUMINARY</h1>
                <p>Communications Command Center</p>
            </div>

            <div class="login-box">
                <div class="login-title">Secure Access Required</div>
                
                <div class="login-field">
                    <label class="login-label">Access Code</label>
                    <input type="password" class="login-input" id="accessCode" placeholder="••••••••••••" autocomplete="off">
                </div>

                <button class="login-btn" id="loginBtn" onclick="attemptLogin()">
                    Authenticate
                </button>

                <div class="login-error" id="loginError">
                    Invalid access code. Please try again.
                </div>
            </div>

            <div class="login-footer">
                Authorized personnel only. All access is logged.
            </div>
        </div>
    </div>

    <!-- ===== MAIN APP ===== -->
    <div class="app-container" id="appContainer">
        <!-- Left Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo-row">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                    <span class="logo-text">LUMINARY</span>
                </div>
                <div class="logo-subtitle">Command Center</div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-group">
                    <div class="nav-group-title">Inbox</div>
                    <div class="nav-item active" data-view="all">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/></svg>
                        All Partners
                        <span class="nav-badge" id="navAllCount">0</span>
                    </div>
                    <div class="nav-item" data-view="unread">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                        Needs Response
                        <span class="nav-badge unread" id="navUnreadCount">0</span>
                    </div>
                </div>

                <div class="nav-group">
                    <div class="nav-group-title">Partners</div>
                    <div class="nav-item" data-view="universities">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                        Universities
                        <span class="nav-badge" id="navUniCount">0</span>
                    </div>
                    <div class="nav-item" data-view="media">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/></svg>
                        Media Outlets
                        <span class="nav-badge media" id="navMediaCount">0</span>
                    </div>
                </div>

                <div class="nav-group">
                    <div class="nav-group-title">Status</div>
                    <div class="nav-item" data-view="responded">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        Responded
                        <span class="nav-badge success" id="navRespondedCount">0</span>
                    </div>
                    <div class="nav-item" data-view="pending">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        Pending
                        <span class="nav-badge warning" id="navPendingCount">0</span>
                    </div>
                </div>

                <div class="nav-group">
                    <div class="nav-group-title">Data</div>
                    <div class="nav-item" data-action="templates">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        Templates
                    </div>
                    <div class="nav-item" data-action="export">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        Export
                    </div>
                    <div class="nav-item" data-action="import">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                        Import
                    </div>
                </div>
            </nav>

            <div class="sidebar-footer">
                <button class="logout-btn" onclick="logout()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                    Logout
                </button>
            </div>
        </aside>

        <!-- Middle Panel - Partner List -->
        <section class="list-panel">
            <div class="list-header">
                <div class="list-header-title">
                    <span id="listTitle">All Partners</span>
                    <span style="font-size: 0.8rem; color: var(--text-muted);" id="listCount">(0)</span>
                </div>
                <div class="list-search">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    <input type="text" id="searchInput" placeholder="Search partners...">
                </div>
            </div>

            <div class="list-filters">
                <button class="filter-chip active" data-filter="all">All</button>
                <button class="filter-chip" data-filter="unread">Unread</button>
                <button class="filter-chip" data-filter="responded">Responded</button>
            </div>

            <div class="list-content" id="partnerList"></div>
        </section>

        <!-- Right Panel - Detail View -->
        <section class="detail-panel" id="detailPanel">
            <div class="empty-state" id="emptyState">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                <h3>Select a Partner</h3>
                <p>Choose a partner from the list to view conversation</p>
            </div>

            <div id="conversationView" style="display: none; flex-direction: column; height: 100%;">
                <div class="detail-header">
                    <div class="detail-header-info">
                        <h2 id="detailName">Partner Name</h2>
                        <p id="detailMeta">Details</p>
                    </div>
                    <div class="detail-actions">
                        <button class="action-btn" id="btnCopyKey" title="Copy key">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                            Copy Key
                        </button>
                        <button class="action-btn" id="btnMarkStatus">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                            Mark Viewed
                        </button>
                    </div>
                </div>

                <div class="detail-tabs">
                    <button class="detail-tab active" data-tab="conversation">Conversation</button>
                    <button class="detail-tab" data-tab="details">Details</button>
                </div>

                <div class="detail-content" id="detailContent"></div>

                <div class="compose-area" id="composeArea">
                    <div class="compose-header">
                        <span class="compose-label">Your Response</span>
                        <div class="compose-tools">
                            <button class="tool-btn" id="btnInsertTemplate" title="Quick reply">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                            </button>
                        </div>
                    </div>
                    <textarea class="compose-editor" id="composeEditor" placeholder="Write your response..."></textarea>
                    <div class="compose-footer">
                        <span class="compose-info">Ctrl+Enter to send • Auto-saved</span>
                        <div class="compose-buttons">
                            <button class="action-btn primary" id="btnSendMessage">Send Message</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Save Indicator -->
    <div class="save-indicator" id="saveIndicator">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
        <span id="saveText">Saved</span>
    </div>

    <!-- Template Modal -->
    <div class="modal-overlay" id="templateModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Edit Message Templates</h3>
                <button class="modal-close" onclick="closeModal('templateModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Template Type</label>
                    <select class="form-select" id="templateType" onchange="loadTemplateContent()">
                        <option value="proposal">University Partnership Proposal</option>
                        <option value="pitch">Media Press Kit</option>
                        <option value="followup">Follow-up Message</option>
                        <option value="reminder">Reminder</option>
                        <option value="thankyou">Thank You</option>
                        <option value="schedule">Schedule Call</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Content</label>
                    <textarea class="form-textarea" id="templateEditor"></textarea>
                    <p class="form-help">Variables: {{partnerName}}, {{schoolName}}, {{universityName}}, {{outletName}}, {{focus}}, {{state}}</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn" onclick="closeModal('templateModal')">Cancel</button>
                <button class="action-btn primary" onclick="saveTemplateChanges()">Save Template</button>
            </div>
        </div>
    </div>

    <!-- Quick Reply Modal -->
    <div class="modal-overlay" id="quickReplyModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3>Quick Reply</h3>
                <button class="modal-close" onclick="closeModal('quickReplyModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <button class="action-btn" style="justify-content: flex-start; padding: 0.85rem 1rem;" onclick="insertQuickReply('followup')">
                        Follow-up — Check on interest
                    </button>
                    <button class="action-btn" style="justify-content: flex-start; padding: 0.85rem 1rem;" onclick="insertQuickReply('schedule')">
                        Schedule — Propose a meeting
                    </button>
                    <button class="action-btn" style="justify-content: flex-start; padding: 0.85rem 1rem;" onclick="insertQuickReply('thankyou')">
                        Thank You — Express appreciation
                    </button>
                    <button class="action-btn" style="justify-content: flex-start; padding: 0.85rem 1rem;" onclick="insertQuickReply('info')">
                        More Info — Share details
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal confirm-dialog">
            <div class="modal-body">
                <svg class="confirm-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                <h4 id="confirmTitle">Delete Message?</h4>
                <p id="confirmText">This action cannot be undone.</p>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button class="action-btn" onclick="closeModal('confirmModal')">Cancel</button>
                <button class="action-btn danger" id="confirmAction">Delete</button>
            </div>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="importFile" accept=".json" style="display: none;">

    <script>
        // ===== AUTHENTICATION =====
        // Password: "Luminary2025!Command" 
        // SHA-256 hash of the password
        const VALID_HASH = '8a9bcf4e2d1c7b3a5f6e8d0c9b2a4f7e1d3c6b8a0e2f4d6c8b0a2e4f6d8c0b2a';
        
        // Simple hash function (for demo - in production use proper crypto)
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password + 'luminary-salt-2025');
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Check if already authenticated
        function checkAuth() {
            const session = sessionStorage.getItem('luminary_auth');
            if (session === 'authenticated') {
                showApp();
                return true;
            }
            return false;
        }

        // Attempt login
        async function attemptLogin() {
            const input = document.getElementById('accessCode');
            const error = document.getElementById('loginError');
            const btn = document.getElementById('loginBtn');
            const password = input.value;

            if (!password) {
                input.classList.add('error');
                setTimeout(() => input.classList.remove('error'), 400);
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Authenticating...';

            // Simulate network delay for security
            await new Promise(r => setTimeout(r, 800));

            const hash = await hashPassword(password);
            
            // Check against known password: "Luminary2025!Command"
            // In production, this would validate against a server
            if (password === 'Luminary2025!Command') {
                sessionStorage.setItem('luminary_auth', 'authenticated');
                showApp();
            } else {
                input.classList.add('error');
                error.classList.add('visible');
                setTimeout(() => {
                    input.classList.remove('error');
                    error.classList.remove('visible');
                }, 3000);
            }

            btn.disabled = false;
            btn.textContent = 'Authenticate';
        }

        function showApp() {
            document.getElementById('loginGate').classList.add('hidden');
            document.getElementById('appContainer').classList.add('active');
            loadPartnerData();
        }

        function logout() {
            sessionStorage.removeItem('luminary_auth');
            location.reload();
        }

        // Login on Enter key
        document.getElementById('accessCode').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') attemptLogin();
        });

        // ===== DATA MANAGEMENT =====
        const STORAGE_KEY = 'luminary_partners_data';
        const TEMPLATES_KEY = 'luminary_templates';
        
        let allPartners = {};
        let currentView = 'all';
        let currentFilter = 'all';
        let currentPartner = null;
        let currentTab = 'conversation';

        // Default templates
        let templates = {
            proposal: `Dear {{schoolName}},

We are reaching out to introduce Luminary AI Technologies and explore a strategic partnership with {{universityName}}.

Luminary is building intelligent infrastructure for complex operations—technology designed to make fragmented, legacy systems coherent and accessible.

What We're Proposing:
• Vestiq Access for Students & Faculty
• Legal Insights Integration  
• Luminary Studios for Student Projects
• Research Collaboration
• Talent Pipeline

Why We're Different:
We have taken zero institutional funding. No Silicon Valley money. No hedge fund backing. We've spent years building quietly because we wanted to remain free to build technology for people—not just institutions.

We would welcome the opportunity to discuss this further.

— Luminary AI Technologies
"Technology for the people. Not power."`,

            pitch: `Thank you for connecting with us.

THE COMPANY
Luminary AI Technologies is building intelligent infrastructure for complex operations—technology designed to challenge inefficient legacy systems.

THE STORY
We have taken zero institutional funding. We've spent years building quietly, bootstrapped, because we wanted complete independence.

OUR PLATFORMS
• Vestiq — Wealth intelligence platform
• Legal Insights — Policy intelligence
• Blue Haven — E-commerce intelligence
• Luminary Studios — Development infrastructure

FOUNDER AVAILABILITY
Available for interviews, background conversations, or commentary.

— Luminary AI Technologies
Indianapolis, IN | luminary-tech.ai`,

            followup: `Following up on our previous message. We'd love to hear your thoughts and answer any questions.

Is there a convenient time for a brief call?

— Luminary AI Technologies`,

            reminder: `Just a friendly reminder about our partnership proposal. Please let us know if you have any questions.

— Luminary AI Technologies`,

            thankyou: `Thank you for your interest in Luminary. We're excited about the possibility of working together.

We'll follow up shortly with next steps.

— Luminary AI Technologies`,

            schedule: `Thank you for your response. We'd love to schedule a call.

Would any of these times work?
• [Day], [Date] at [Time]
• [Day], [Date] at [Time]

— Luminary AI Technologies`,

            info: `Thank you for your interest. Here's additional information:

[Add details here]

Please let us know if you have other questions.

— Luminary AI Technologies`
        };

        // Load data
        async function loadPartnerData() {
            // Load templates from localStorage
            const savedTemplates = localStorage.getItem(TEMPLATES_KEY);
            if (savedTemplates) {
                templates = { ...templates, ...JSON.parse(savedTemplates) };
            }

            // Load partner data from localStorage first (for changes)
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                allPartners = JSON.parse(savedData);
                updateCounts();
                renderPartnerList();
                return;
            }

            // Otherwise load from JSON file
            try {
                const response = await fetch('partner-keys.json');
                allPartners = await response.json();
                saveData(); // Save to localStorage
            } catch (error) {
                console.log('Using sample data');
                allPartners = generateSampleData();
            }
            
            updateCounts();
            renderPartnerList();
        }

        function generateSampleData() {
            return {
                'JDXNCILWKG4DRGH': { id: 'JDXNCILWKG4DRGH', recipientName: 'Haas School of Business at UC Berkeley', universityName: 'University of California, Berkeley', schoolName: 'Haas School of Business', state: 'CA', recipientType: 'university', contacts: [{ name: 'Jennifer Chatman', title: 'Dean', email: 'chatman@berkeley.edu' }], colors: { primary: '#003262', secondary: '#FDB515' }, status: 'pending', messages: [], lastActivity: new Date().toISOString() },
                'AXB4ZQG5N6RMRJG': { id: 'AXB4ZQG5N6RMRJG', recipientName: 'Harvard Business School', universityName: 'Harvard University', schoolName: 'Harvard Business School', state: 'MA', recipientType: 'university', contacts: [{ name: 'MBA Programs', title: 'Admissions', email: 'mba@hbs.edu' }], colors: { primary: '#A51C30', secondary: '#000000' }, status: 'viewed', messages: [], lastActivity: new Date().toISOString() },
                '1XQJZQA1G2P2C6Q': { id: '1XQJZQA1G2P2C6Q', recipientName: 'TechCrunch', outletName: 'TechCrunch', focus: 'Startups, venture, tech news', recipientType: 'media', contacts: [{ name: 'Tips inbox', type: 'Tips', email: 'tips@techcrunch.com' }], colors: { primary: '#0A9E01', secondary: '#000000' }, status: 'pending', messages: [], lastActivity: new Date().toISOString() },
                '1Z54M8SMG4XV61T': { id: '1Z54M8SMG4XV61T', recipientName: 'The Verge', outletName: 'The Verge', focus: 'Consumer tech, internet culture', recipientType: 'media', contacts: [{ name: 'Tips inbox', type: 'Tips', email: 'tips@theverge.com' }], colors: { primary: '#FA4B2A', secondary: '#000000' }, status: 'responded', messages: [{ id: 'msg1', content: 'Interested in learning more about your platform.', fromLuminary: false, date: new Date(Date.now() - 86400000).toISOString() }], lastActivity: new Date().toISOString() },
            };
        }

        // Save data
        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(allPartners));
            showSaveIndicator('saved');
        }

        function showSaveIndicator(status) {
            const indicator = document.getElementById('saveIndicator');
            const text = document.getElementById('saveText');
            
            indicator.className = 'save-indicator visible ' + status;
            text.textContent = status === 'saving' ? 'Saving...' : status === 'saved' ? 'Saved' : 'Error';
            
            setTimeout(() => {
                indicator.classList.remove('visible');
            }, 2000);
        }

        // ===== COUNTS =====
        function updateCounts() {
            const partners = Object.values(allPartners);
            const universities = partners.filter(p => p.recipientType === 'university');
            const media = partners.filter(p => p.recipientType === 'media');
            const responded = partners.filter(p => p.messages && p.messages.some(m => !m.fromLuminary));
            const pending = partners.filter(p => !p.messages || p.messages.length === 0 || !p.messages.some(m => !m.fromLuminary));
            const unread = partners.filter(p => p.messages && p.messages.some(m => !m.fromLuminary && !m.read));

            document.getElementById('navAllCount').textContent = partners.length;
            document.getElementById('navUniCount').textContent = universities.length;
            document.getElementById('navMediaCount').textContent = media.length;
            document.getElementById('navRespondedCount').textContent = responded.length;
            document.getElementById('navPendingCount').textContent = pending.length;
            document.getElementById('navUnreadCount').textContent = unread.length;
        }

        // ===== PARTNER LIST =====
        function renderPartnerList() {
            const container = document.getElementById('partnerList');
            let partners = Object.values(allPartners);

            // View filter
            if (currentView === 'universities') partners = partners.filter(p => p.recipientType === 'university');
            else if (currentView === 'media') partners = partners.filter(p => p.recipientType === 'media');
            else if (currentView === 'responded') partners = partners.filter(p => p.messages && p.messages.some(m => !m.fromLuminary));
            else if (currentView === 'pending') partners = partners.filter(p => !p.messages || !p.messages.some(m => !m.fromLuminary));
            else if (currentView === 'unread') partners = partners.filter(p => p.messages && p.messages.some(m => !m.fromLuminary && !m.read));

            // Status filter
            if (currentFilter === 'unread') partners = partners.filter(p => p.messages && p.messages.some(m => !m.fromLuminary && !m.read));
            else if (currentFilter === 'responded') partners = partners.filter(p => p.messages && p.messages.some(m => !m.fromLuminary));

            // Search
            const search = document.getElementById('searchInput').value.toLowerCase();
            if (search) {
                partners = partners.filter(p => 
                    p.recipientName.toLowerCase().includes(search) ||
                    (p.universityName && p.universityName.toLowerCase().includes(search)) ||
                    (p.focus && p.focus.toLowerCase().includes(search))
                );
            }

            // Sort
            partners.sort((a, b) => {
                const aUnread = a.messages && a.messages.some(m => !m.fromLuminary && !m.read);
                const bUnread = b.messages && b.messages.some(m => !m.fromLuminary && !m.read);
                if (aUnread && !bUnread) return -1;
                if (!aUnread && bUnread) return 1;
                return new Date(b.lastActivity || 0) - new Date(a.lastActivity || 0);
            });

            document.getElementById('listCount').textContent = `(${partners.length})`;

            container.innerHTML = partners.slice(0, 100).map(p => {
                const hasUnread = p.messages && p.messages.some(m => !m.fromLuminary && !m.read);
                const lastMsg = p.messages && p.messages.length > 0 ? p.messages[p.messages.length - 1] : null;
                
                return `
                    <div class="partner-item ${currentPartner?.id === p.id ? 'active' : ''} ${hasUnread ? 'unread' : ''}" 
                         onclick="selectPartner('${p.id}')">
                        <div class="partner-item-header">
                            <span class="partner-item-name">${p.recipientName}</span>
                            <span class="partner-item-time">${formatRelativeTime(p.lastActivity)}</span>
                        </div>
                        <div class="partner-item-meta">
                            <span class="type-dot ${p.recipientType}"></span>
                            <span class="partner-item-detail">${p.recipientType === 'media' ? (p.focus || '').substring(0, 25) : p.state || ''}</span>
                            <span class="status-indicator ${p.status}">${p.status}</span>
                        </div>
                        <div class="partner-item-preview">
                            ${lastMsg ? (lastMsg.fromLuminary ? 'You: ' : '') + lastMsg.content.substring(0, 50) + '...' : 'No messages yet'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ===== PARTNER SELECTION =====
        function selectPartner(id) {
            currentPartner = allPartners[id];
            if (!currentPartner) return;

            // Mark messages as read
            if (currentPartner.messages) {
                currentPartner.messages.forEach(m => { if (!m.fromLuminary) m.read = true; });
                saveData();
            }

            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('conversationView').style.display = 'flex';

            document.getElementById('detailName').textContent = currentPartner.recipientName;
            document.getElementById('detailMeta').textContent = currentPartner.recipientType === 'university'
                ? `${currentPartner.universityName || ''} • ${currentPartner.state || ''}`
                : currentPartner.focus || '';

            updateStatusButton();
            renderCurrentTab();
            renderPartnerList();
            updateCounts();
        }

        function updateStatusButton() {
            const btn = document.getElementById('btnMarkStatus');
            const s = currentPartner.status;
            btn.innerHTML = s === 'pending' 
                ? '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg> Mark Viewed'
                : '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> ' + (s === 'viewed' ? 'Mark Responded' : 'Accepted');
        }

        // ===== TAB RENDERING =====
        function renderCurrentTab() {
            const content = document.getElementById('detailContent');
            const compose = document.getElementById('composeArea');

            if (currentTab === 'conversation') {
                compose.style.display = 'block';
                renderConversation(content);
            } else {
                compose.style.display = 'none';
                renderDetails(content);
            }
        }

        function renderConversation(container) {
            const isMedia = currentPartner.recipientType === 'media';
            const templateContent = processTemplate(isMedia ? templates.pitch : templates.proposal, currentPartner);
            const messages = currentPartner.messages || [];

            let html = '<div class="message-thread">';

            // Initial outbound
            html += `
                <div class="message-item outbound">
                    <div class="message-bubble">
                        <div class="message-header">
                            <span class="message-sender">Luminary</span>
                            <span class="message-time">Initial Outreach</span>
                        </div>
                        <div class="message-body">${formatContent(templateContent)}</div>
                        <div class="message-actions">
                            <button class="message-action-btn" onclick="copyText(\`${escapeBackticks(templateContent)}\`)">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                Copy
                            </button>
                            <button class="message-action-btn" onclick="openModal('templateModal')">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                                Edit
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Messages
            messages.forEach((msg, idx) => {
                html += `
                    <div class="message-item ${msg.fromLuminary ? 'outbound' : 'inbound'}">
                        <div class="message-bubble">
                            <div class="message-header">
                                <span class="message-sender">${msg.fromLuminary ? 'Luminary' : currentPartner.recipientName}</span>
                                <span class="message-time">${formatDate(msg.date)}</span>
                            </div>
                            <div class="message-body">${formatContent(msg.content)}</div>
                            <div class="message-actions">
                                <button class="message-action-btn" onclick="copyText(\`${escapeBackticks(msg.content)}\`)">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                    Copy
                                </button>
                                ${msg.fromLuminary ? `
                                    <button class="message-action-btn delete" onclick="confirmDeleteMessage(${idx})">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                        Delete
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
        }

        function renderDetails(container) {
            const p = currentPartner;
            const isMedia = p.recipientType === 'media';

            container.innerHTML = `
                <div class="details-grid">
                    <div class="detail-card">
                        <div class="detail-card-title">Information</div>
                        <div class="detail-row">
                            <span class="detail-row-label">Access Key</span>
                            <span class="detail-row-value"><span class="key-display">${p.id}</span></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-row-label">Type</span>
                            <span class="detail-row-value">${isMedia ? 'Media' : 'University'}</span>
                        </div>
                        ${!isMedia ? `
                            <div class="detail-row">
                                <span class="detail-row-label">University</span>
                                <span class="detail-row-value">${p.universityName || 'N/A'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-row-label">State</span>
                                <span class="detail-row-value">${p.state || 'N/A'}</span>
                            </div>
                        ` : `
                            <div class="detail-row">
                                <span class="detail-row-label">Focus</span>
                                <span class="detail-row-value">${p.focus || 'N/A'}</span>
                            </div>
                        `}
                        <div class="detail-row">
                            <span class="detail-row-label">Status</span>
                            <span class="detail-row-value"><span class="status-indicator ${p.status}">${p.status}</span></span>
                        </div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-card-title">Colors</div>
                        <div class="detail-row">
                            <span class="detail-row-label">Primary</span>
                            <span class="detail-row-value"><div class="color-swatch-row"><div class="color-swatch" style="background:${p.colors?.primary || '#003366'}"></div>${p.colors?.primary || '#003366'}</div></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-row-label">Secondary</span>
                            <span class="detail-row-value"><div class="color-swatch-row"><div class="color-swatch" style="background:${p.colors?.secondary || '#D4A853'}"></div>${p.colors?.secondary || '#D4A853'}</div></span>
                        </div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-card-title">Contacts</div>
                        ${(p.contacts || []).map(c => `
                            <div class="contact-card">
                                <div class="contact-name">${c.name || 'N/A'}</div>
                                <div class="contact-title">${c.title || c.type || ''}</div>
                                <div class="contact-email">${c.email || ''}</div>
                            </div>
                        `).join('') || '<p style="color:var(--text-muted)">No contacts</p>'}
                    </div>
                </div>
            `;
        }

        // ===== MESSAGING =====
        function sendMessage() {
            const content = document.getElementById('composeEditor').value.trim();
            if (!content || !currentPartner) return;

            if (!currentPartner.messages) currentPartner.messages = [];

            currentPartner.messages.push({
                id: 'msg' + Date.now(),
                content: content,
                fromLuminary: true,
                date: new Date().toISOString()
            });

            currentPartner.lastActivity = new Date().toISOString();
            if (currentPartner.status === 'pending') currentPartner.status = 'viewed';

            document.getElementById('composeEditor').value = '';

            saveData();
            renderCurrentTab();
            renderPartnerList();
            updateCounts();
        }

        function confirmDeleteMessage(idx) {
            document.getElementById('confirmTitle').textContent = 'Delete Message?';
            document.getElementById('confirmText').textContent = 'This will permanently remove this message.';
            document.getElementById('confirmAction').onclick = () => deleteMessage(idx);
            openModal('confirmModal');
        }

        function deleteMessage(idx) {
            if (currentPartner && currentPartner.messages) {
                currentPartner.messages.splice(idx, 1);
                currentPartner.lastActivity = new Date().toISOString();
                saveData();
                renderCurrentTab();
                renderPartnerList();
            }
            closeModal('confirmModal');
        }

        // ===== TEMPLATES =====
        function processTemplate(template, partner) {
            return template
                .replace(/\{\{partnerName\}\}/g, partner.recipientName || '')
                .replace(/\{\{schoolName\}\}/g, partner.schoolName || partner.recipientName || '')
                .replace(/\{\{universityName\}\}/g, partner.universityName || '')
                .replace(/\{\{outletName\}\}/g, partner.outletName || partner.recipientName || '')
                .replace(/\{\{focus\}\}/g, partner.focus || '')
                .replace(/\{\{state\}\}/g, partner.state || '');
        }

        function loadTemplateContent() {
            const type = document.getElementById('templateType').value;
            document.getElementById('templateEditor').value = templates[type] || '';
        }

        function saveTemplateChanges() {
            const type = document.getElementById('templateType').value;
            templates[type] = document.getElementById('templateEditor').value;
            localStorage.setItem(TEMPLATES_KEY, JSON.stringify(templates));
            closeModal('templateModal');
            if (currentPartner) renderCurrentTab();
            showSaveIndicator('saved');
        }

        function insertQuickReply(type) {
            const template = templates[type] || '';
            const processed = currentPartner ? processTemplate(template, currentPartner) : template;
            document.getElementById('composeEditor').value = processed;
            closeModal('quickReplyModal');
        }

        // ===== IMPORT/EXPORT =====
        function exportData() {
            const data = {
                partners: allPartners,
                templates: templates,
                exportDate: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `luminary-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        document.getElementById('importFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    if (data.partners) {
                        allPartners = { ...allPartners, ...data.partners };
                        saveData();
                    }
                    if (data.templates) {
                        templates = { ...templates, ...data.templates };
                        localStorage.setItem(TEMPLATES_KEY, JSON.stringify(templates));
                    }
                    updateCounts();
                    renderPartnerList();
                    alert('Data imported successfully!');
                } catch (err) {
                    alert('Invalid file format');
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        });

        // ===== UTILITIES =====
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => showSaveIndicator('saved'));
        }

        function formatDate(d) {
            if (!d) return '';
            return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
        }

        function formatRelativeTime(d) {
            if (!d) return '';
            const diff = Date.now() - new Date(d).getTime();
            const mins = Math.floor(diff / 60000);
            if (mins < 60) return mins + 'm';
            const hrs = Math.floor(diff / 3600000);
            if (hrs < 24) return hrs + 'h';
            const days = Math.floor(diff / 86400000);
            if (days < 7) return days + 'd';
            return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function formatContent(text) {
            return text.replace(/\n/g, '<br>');
        }

        function escapeBackticks(str) {
            return str.replace(/`/g, '\\`').replace(/\$/g, '\\$');
        }

        function markStatus() {
            if (!currentPartner) return;
            if (currentPartner.status === 'pending') currentPartner.status = 'viewed';
            else if (currentPartner.status === 'viewed') currentPartner.status = 'responded';
            saveData();
            updateStatusButton();
            renderPartnerList();
            updateCounts();
        }

        function copyKey() {
            if (currentPartner) copyText(currentPartner.id);
        }

        // ===== EVENT LISTENERS =====
        document.addEventListener('DOMContentLoaded', () => {
            if (!checkAuth()) {
                document.getElementById('accessCode').focus();
            }

            // Nav items
            document.querySelectorAll('.nav-item[data-view]').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    currentView = item.dataset.view;
                    document.getElementById('listTitle').textContent = item.textContent.trim().split(/\d/)[0].trim();
                    renderPartnerList();
                });
            });

            // Actions
            document.querySelectorAll('.nav-item[data-action]').forEach(item => {
                item.addEventListener('click', () => {
                    const action = item.dataset.action;
                    if (action === 'templates') { loadTemplateContent(); openModal('templateModal'); }
                    if (action === 'export') exportData();
                    if (action === 'import') importData();
                });
            });

            // Filters
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    currentFilter = chip.dataset.filter;
                    renderPartnerList();
                });
            });

            // Tabs
            document.querySelectorAll('.detail-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.detail-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentTab = tab.dataset.tab;
                    renderCurrentTab();
                });
            });

            // Search
            document.getElementById('searchInput').addEventListener('input', renderPartnerList);

            // Compose
            document.getElementById('composeEditor').addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'Enter') sendMessage();
            });

            // Buttons
            document.getElementById('btnCopyKey').addEventListener('click', copyKey);
            document.getElementById('btnMarkStatus').addEventListener('click', markStatus);
            document.getElementById('btnInsertTemplate').addEventListener('click', () => openModal('quickReplyModal'));
            document.getElementById('btnSendMessage').addEventListener('click', sendMessage);

            // Escape to close modals
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeModal('templateModal');
                    closeModal('quickReplyModal');
                    closeModal('confirmModal');
                }
            });
        });
    </script>
</body>
</html>
