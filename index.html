<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luminary | Communications Command Center</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600&family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #0a0a0f;
            --bg-card: #12121a;
            --bg-elevated: #1a1a24;
            --bg-input: #0d0d12;
            --gold-primary: #D4A853;
            --gold-light: #E8C875;
            --gold-dark: #B8923F;
            --text-primary: #F5F5F5;
            --text-secondary: #A0A0A0;
            --text-muted: #666;
            --border-subtle: rgba(212, 168, 83, 0.2);
            --border-strong: rgba(212, 168, 83, 0.4);
            --success: #4ade80;
            --success-bg: rgba(74, 222, 128, 0.1);
            --warning: #fbbf24;
            --warning-bg: rgba(251, 191, 36, 0.1);
            --error: #f87171;
            --error-bg: rgba(248, 113, 113, 0.1);
            --info: #60a5fa;
            --info-bg: rgba(96, 165, 250, 0.1);
            --media-accent: #FF6B35;
            --media-bg: rgba(255, 107, 53, 0.1);
            --university-accent: #D4A853;
            --university-bg: rgba(212, 168, 83, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Cormorant Garamond', Georgia, serif; 
            background: var(--bg-deep); 
            color: var(--text-primary); 
            min-height: 100vh;
            font-size: 16px;
            line-height: 1.6;
        }

        /* ===== LOGIN GATE ===== */
        .login-gate {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-deep);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-gate.hidden { display: none; }

        .login-container {
            width: 100%;
            max-width: 420px;
            padding: 2rem;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .login-logo svg {
            width: 48px;
            height: 48px;
            color: var(--gold-primary);
            margin-bottom: 1rem;
        }

        .login-logo h1 {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            letter-spacing: 0.2em;
            color: var(--gold-primary);
            margin-bottom: 0.25rem;
        }

        .login-logo p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            letter-spacing: 0.1em;
        }

        .login-box {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 2rem;
        }

        .login-title {
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            text-align: center;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .login-field {
            margin-bottom: 1.25rem;
        }

        .login-label {
            display: block;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .login-input {
            width: 100%;
            padding: 0.85rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            letter-spacing: 0.15em;
            text-align: center;
            transition: all 0.2s ease;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--gold-primary);
            box-shadow: 0 0 0 3px rgba(212, 168, 83, 0.1);
        }

        .login-input.error {
            border-color: var(--error);
            animation: shake 0.4s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        .login-btn {
            width: 100%;
            padding: 0.9rem;
            background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
            border: none;
            border-radius: 6px;
            color: var(--bg-deep);
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            font-weight: 600;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(212, 168, 83, 0.3);
        }

        .login-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .login-error {
            margin-top: 1rem;
            padding: 0.75rem;
            background: var(--error-bg);
            border: 1px solid var(--error);
            border-radius: 6px;
            color: var(--error);
            font-size: 0.85rem;
            text-align: center;
            display: none;
        }

        .login-error.visible { display: block; }

        .login-footer {
            margin-top: 1.5rem;
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* ===== APP CONTAINER ===== */
        .app-container { 
            display: none;
            grid-template-columns: 260px 380px 1fr; 
            height: 100vh; 
            overflow: hidden;
        }

        .app-container.active { display: grid; }

        /* ===== SAVE INDICATOR ===== */
        .save-indicator {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            padding: 0.6rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 100;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(10px);
        }

        .save-indicator.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .save-indicator.saving { color: var(--warning); border-color: var(--warning); }
        .save-indicator.saved { color: var(--success); border-color: var(--success); }
        .save-indicator.error { color: var(--error); border-color: var(--error); }

        .save-indicator svg { width: 14px; height: 14px; }

        /* ===== SIDEBAR ===== */
        .sidebar {
            background: var(--bg-card);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border-subtle);
        }

        .logo-row {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            margin-bottom: 0.35rem;
        }

        .logo-row svg { height: 24px; width: 24px; color: var(--gold-primary); }

        .logo-text {
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            color: var(--gold-primary);
            letter-spacing: 0.15em;
        }

        .logo-subtitle {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .sidebar-nav { flex: 1; overflow-y: auto; padding: 0.75rem 0; }

        .nav-group { margin-bottom: 1.25rem; }

        .nav-group-title {
            font-family: 'Cinzel', serif;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--text-muted);
            padding: 0.5rem 1.25rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.65rem;
            padding: 0.6rem 1.25rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
            border-left: 2px solid transparent;
            font-size: 0.9rem;
        }

        .nav-item:hover { background: rgba(255,255,255,0.02); color: var(--text-primary); }
        .nav-item.active { 
            background: var(--university-bg); 
            color: var(--gold-primary); 
            border-left-color: var(--gold-primary); 
        }

        .nav-item svg { width: 18px; height: 18px; opacity: 0.7; flex-shrink: 0; }
        .nav-item.active svg { opacity: 1; }

        .nav-badge {
            margin-left: auto;
            background: var(--gold-primary);
            color: var(--bg-deep);
            font-size: 0.65rem;
            font-weight: 600;
            padding: 0.1rem 0.45rem;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
        }

        .nav-badge.media { background: var(--media-accent); }
        .nav-badge.success { background: var(--success); }
        .nav-badge.warning { background: var(--warning); color: var(--bg-deep); }
        .nav-badge.unread { background: var(--error); animation: pulse 2s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .sidebar-footer {
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--border-subtle);
        }

        .logout-btn {
            width: 100%;
            padding: 0.6rem;
            background: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.15s ease;
        }

        .logout-btn:hover { border-color: var(--error); color: var(--error); }
        .logout-btn svg { width: 14px; height: 14px; }

        /* ===== LIST PANEL ===== */
        .list-panel {
            background: var(--bg-deep);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .list-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-card);
        }

        .list-header-title {
            font-family: 'Cinzel', serif;
            font-size: 0.95rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .list-search {
            display: flex;
            align-items: center;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            gap: 0.5rem;
        }

        .list-search svg { width: 16px; height: 16px; color: var(--text-muted); flex-shrink: 0; }

        .list-search input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
            outline: none;
        }

        .list-search input::placeholder { color: var(--text-muted); }

        .list-filters {
            display: flex;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            background: var(--bg-card);
        }

        .filter-chip {
            padding: 0.35rem 0.7rem;
            background: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .filter-chip:hover { border-color: var(--gold-primary); color: var(--text-primary); }
        .filter-chip.active { background: var(--gold-primary); border-color: var(--gold-primary); color: var(--bg-deep); }

        .list-content { flex: 1; overflow-y: auto; }

        .partner-item {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            cursor: pointer;
            transition: background 0.15s ease;
            position: relative;
        }

        .partner-item:hover { background: rgba(255,255,255,0.02); }
        .partner-item.active { background: var(--university-bg); }
        .partner-item.unread::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--gold-primary);
        }

        .partner-item-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 0.35rem;
        }

        .partner-item-name {
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-primary);
            line-height: 1.3;
        }

        .partner-item-time {
            font-size: 0.7rem;
            color: var(--text-muted);
            white-space: nowrap;
            margin-left: 0.5rem;
        }

        .partner-item-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.35rem;
        }

        .type-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .type-dot.university { background: var(--gold-primary); }
        .type-dot.media { background: var(--media-accent); }

        .partner-item-detail {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .partner-item-preview {
            font-size: 0.8rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .status-indicator.pending { background: var(--warning-bg); color: var(--warning); }
        .status-indicator.viewed { background: var(--info-bg); color: var(--info); }
        .status-indicator.responded { background: var(--success-bg); color: var(--success); }
        .status-indicator.accepted { background: var(--success-bg); color: var(--success); }

        /* ===== DETAIL PANEL ===== */
        .detail-panel {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-deep);
        }

        .detail-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .detail-header-info h2 {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 0.2rem;
        }

        .detail-header-info p {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .detail-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            padding: 0.45rem 0.85rem;
            background: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .action-btn:hover { border-color: var(--gold-primary); color: var(--gold-primary); }
        .action-btn svg { width: 14px; height: 14px; }

        .action-btn.primary {
            background: var(--gold-primary);
            border-color: var(--gold-primary);
            color: var(--bg-deep);
        }

        .action-btn.primary:hover { background: var(--gold-light); }

        .action-btn.danger { border-color: var(--error); color: var(--error); }
        .action-btn.danger:hover { background: var(--error-bg); }

        /* Tabs */
        .detail-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-card);
        }

        .detail-tab {
            padding: 0.85rem 1.25rem;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            font-family: 'Cinzel', serif;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .detail-tab:hover { color: var(--text-primary); }
        .detail-tab.active { color: var(--gold-primary); border-bottom-color: var(--gold-primary); }

        /* Conversation Thread */
        .detail-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .message-thread { display: flex; flex-direction: column; gap: 1.25rem; }

        .message-item {
            max-width: 85%;
            position: relative;
        }

        .message-item.outbound { align-self: flex-start; }
        .message-item.inbound { align-self: flex-end; }

        .message-bubble {
            padding: 1rem 1.25rem;
            border-radius: 12px;
            position: relative;
        }

        .message-item.outbound .message-bubble {
            background: linear-gradient(135deg, rgba(212, 168, 83, 0.15) 0%, rgba(212, 168, 83, 0.05) 100%);
            border: 1px solid rgba(212, 168, 83, 0.25);
            border-radius: 12px 12px 12px 2px;
        }

        .message-item.inbound .message-bubble {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 12px 12px 2px 12px;
        }

        .message-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .message-sender {
            font-family: 'Cinzel', serif;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--gold-primary);
        }

        .message-item.inbound .message-sender { color: var(--text-secondary); }

        .message-time {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .message-body {
            font-size: 0.9rem;
            line-height: 1.7;
            color: var(--text-primary);
        }

        .message-body p { margin-bottom: 0.75rem; }
        .message-body p:last-child { margin-bottom: 0; }
        .message-body strong { color: var(--gold-light); }

        .message-actions {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(255,255,255,0.05);
            display: flex;
            gap: 0.75rem;
        }

        .message-action-btn {
            font-size: 0.7rem;
            color: var(--text-muted);
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.15s ease;
        }

        .message-action-btn:hover { color: var(--gold-primary); background: rgba(212, 168, 83, 0.1); }
        .message-action-btn.delete:hover { color: var(--error); background: var(--error-bg); }
        .message-action-btn svg { width: 12px; height: 12px; }

        /* Compose Area */
        .compose-area {
            padding: 1.25rem 1.5rem;
            border-top: 1px solid var(--border-subtle);
            background: var(--bg-card);
        }

        .compose-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .compose-label {
            font-family: 'Cinzel', serif;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
        }

        .compose-tools {
            display: flex;
            gap: 0.5rem;
        }

        .tool-btn {
            width: 28px;
            height: 28px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .tool-btn:hover { border-color: var(--gold-primary); color: var(--gold-primary); }
        .tool-btn svg { width: 14px; height: 14px; }

        .compose-editor {
            width: 100%;
            min-height: 100px;
            max-height: 200px;
            padding: 0.85rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            line-height: 1.6;
            resize: vertical;
            transition: border-color 0.15s ease;
        }

        .compose-editor:focus { outline: none; border-color: var(--gold-primary); }
        .compose-editor::placeholder { color: var(--text-muted); }

        .compose-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 0.85rem;
        }

        .compose-info {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .compose-buttons { display: flex; gap: 0.5rem; }

        /* Empty State */
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            text-align: center;
            padding: 2rem;
        }

        .empty-state svg { width: 48px; height: 48px; margin-bottom: 1rem; opacity: 0.3; }
        .empty-state h3 { font-family: 'Cinzel', serif; font-size: 1rem; margin-bottom: 0.5rem; color: var(--text-secondary); }
        .empty-state p { font-size: 0.85rem; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }

        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal {
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            transform: translateY(20px);
            transition: transform 0.2s ease;
        }

        .modal-overlay.active .modal { transform: translateY(0); }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
        }

        .modal-close:hover { color: var(--text-primary); }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Form Elements */
        .form-group { margin-bottom: 1.25rem; }

        .form-label {
            display: block;
            font-family: 'Cinzel', serif;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            transition: border-color 0.15s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--gold-primary);
        }

        .form-textarea {
            min-height: 250px;
            line-height: 1.7;
            resize: vertical;
        }

        .form-help {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.35rem;
        }

        .variable-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .variable-chip {
            padding: 0.3rem 0.6rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--gold-primary);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .variable-chip:hover { background: var(--university-bg); border-color: var(--gold-primary); }

        /* Partner Details */
        .details-grid {
            display: grid;
            gap: 1.25rem;
        }

        .detail-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 1.25rem;
        }

        .detail-card-title {
            font-family: 'Cinzel', serif;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--gold-primary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-subtle);
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 0.5rem 0;
            font-size: 0.85rem;
        }

        .detail-row-label { color: var(--text-secondary); }
        .detail-row-value { color: var(--text-primary); text-align: right; max-width: 60%; }

        .key-display {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            background: var(--bg-input);
            padding: 0.3rem 0.5rem;
            border-radius: 4px;
            letter-spacing: 0.05em;
        }

        .color-swatch-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .color-swatch {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .contact-card {
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }

        .contact-card:last-child { border-bottom: none; padding-bottom: 0; }

        .contact-name { font-weight: 500; margin-bottom: 0.2rem; }
        .contact-title { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.15rem; }
        .contact-email { font-size: 0.8rem; color: var(--gold-primary); }

        /* Confirm Dialog */
        .confirm-dialog {
            max-width: 400px;
        }

        .confirm-dialog .modal-body {
            text-align: center;
            padding: 2rem;
        }

        .confirm-dialog .confirm-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem;
            color: var(--warning);
        }

        .confirm-dialog h4 {
            font-family: 'Cinzel', serif;
            margin-bottom: 0.5rem;
        }

        .confirm-dialog p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-subtle); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gold-dark); }

        /* File Preview */
        .file-preview-container { display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 0.5rem 0; }
        .file-preview-container:empty { display: none; }
        .file-preview-item { position: relative; background: var(--bg-dark); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .file-preview-item img { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; }
        .file-preview-item .file-icon { width: 40px; height: 40px; background: var(--bg-deep); border-radius: 4px; display: flex; align-items: center; justify-content: center; color: var(--gold); font-size: 0.7rem; font-weight: 600; }
        .file-preview-info { flex: 1; min-width: 0; }
        .file-preview-name { color: var(--text-light); font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px; }
        .file-preview-size { color: var(--text-muted); font-size: 0.7rem; }
        .file-preview-remove { position: absolute; top: -6px; right: -6px; width: 18px; height: 18px; background: #e74c3c; border: none; border-radius: 50%; color: white; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* Message Attachments */
        .message-attachments { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-subtle); }
        .message-attachment { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: var(--bg-deep); border-radius: 6px; cursor: pointer; transition: all 0.2s ease; text-decoration: none; color: inherit; position: relative; }
        .message-attachment:hover { background: rgba(212, 175, 55, 0.15); }
        .message-attachment.pdf { border-left: 3px solid #E74C3C; }
        .message-attachment.doc { border-left: 3px solid #2B579A; }
        .message-attachment.spreadsheet { border-left: 3px solid #217346; }
        .message-attachment.image { border-left: 3px solid #9B59B6; }
        .message-attachment-icon { width: 32px; height: 32px; border-radius: 4px; display: flex; align-items: center; justify-content: center; background: var(--bg-card); color: var(--gold); font-size: 0.65rem; font-weight: 600; }
        .message-attachment-icon img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; }
        .message-attachment-icon svg { width: 18px; height: 18px; }
        .message-attachment-info { font-size: 0.8rem; flex: 1; min-width: 0; }
        .message-attachment-name { color: var(--text-light); max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .message-attachment-size { color: var(--text-muted); font-size: 0.7rem; }
        .attachment-actions { display: flex; gap: 0.25rem; }
        .attachment-download, .attachment-preview { background: transparent; border: none; color: var(--text-muted); cursor: pointer; padding: 0.25rem; border-radius: 4px; transition: all 0.2s ease; }
        .attachment-download:hover, .attachment-preview:hover { color: var(--gold); background: rgba(212, 175, 55, 0.1); }
        .attachment-download svg, .attachment-preview svg { width: 16px; height: 16px; }

        /* File Preview Modal */
        .file-preview-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .file-preview-modal.active { opacity: 1; visibility: visible; }
        .file-preview-modal-content { width: 90vw; height: 90vh; background: var(--bg-card); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; }
        .file-preview-modal-header { display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-subtle); background: var(--bg-deep); }
        .file-preview-modal-title { font-weight: 600; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 60%; }

        /* ===== SPLIT VIEW DOCUMENT PREVIEW ===== */
        .detail-panel { position: relative; transition: all 0.3s ease; }
        .detail-panel.has-preview { }
        
        .detail-main { display: flex; flex-direction: column; height: 100%; transition: all 0.3s ease; }
        .detail-panel.has-preview .detail-main { width: 50%; border-right: 1px solid var(--border-subtle); }
        
        /* Document Preview Panel */
        .doc-preview-panel {
            position: absolute;
            top: 0;
            right: 0;
            width: 50%;
            height: 100%;
            background: var(--bg-card);
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
        }
        .detail-panel.has-preview .doc-preview-panel {
            transform: translateX(0);
            opacity: 1;
        }
        
        /* Preview Header */
        .doc-preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            background: linear-gradient(135deg, var(--bg-deep) 0%, var(--bg-card) 100%);
            border-bottom: 1px solid var(--border-subtle);
        }
        .doc-preview-header-info {
            flex: 1;
            min-width: 0;
        }
        .doc-preview-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0.25rem;
        }
        .doc-preview-meta {
            display: flex;
            gap: 0.75rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .doc-preview-meta span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .doc-preview-actions {
            display: flex;
            gap: 0.5rem;
        }
        .doc-preview-btn {
            width: 36px;
            height: 36px;
            background: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .doc-preview-btn:hover {
            border-color: var(--gold-primary);
            color: var(--gold-primary);
            background: rgba(212, 168, 83, 0.1);
        }
        .doc-preview-btn.close:hover {
            border-color: var(--error);
            color: var(--error);
            background: var(--error-bg);
        }
        .doc-preview-btn svg {
            width: 18px;
            height: 18px;
        }
        
        /* Preview Tabs */
        .doc-preview-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-deep);
        }
        .doc-preview-tab {
            flex: 1;
            padding: 0.75rem;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 0.8rem;
            font-family: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            position: relative;
            transition: all 0.2s ease;
        }
        .doc-preview-tab:hover {
            color: var(--text-primary);
            background: rgba(255,255,255,0.03);
        }
        .doc-preview-tab.active {
            color: var(--gold-primary);
        }
        .doc-preview-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gold-primary);
        }
        .doc-preview-tab svg {
            width: 14px;
            height: 14px;
        }
        .doc-preview-tab-badge {
            background: var(--gold-primary);
            color: var(--bg-deep);
            font-size: 0.65rem;
            padding: 0.1rem 0.35rem;
            border-radius: 8px;
            font-weight: 600;
        }
        
        /* Preview Content Area */
        .doc-preview-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* Preview Viewer */
        .doc-preview-viewer {
            flex: 1;
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #0d0d12;
            position: relative;
        }
        .doc-preview-viewer iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }
        .doc-preview-viewer img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            cursor: zoom-in;
        }
        .doc-preview-viewer img.zoomed {
            max-width: none;
            max-height: none;
            cursor: zoom-out;
        }
        
        /* Unsupported File */
        .doc-preview-unsupported {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }
        .doc-preview-unsupported svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        .doc-preview-unsupported h4 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        .doc-preview-unsupported .download-btn {
            margin-top: 1rem;
            padding: 0.75rem 1.5rem;
            background: var(--gold-primary);
            color: var(--bg-deep);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }
        .doc-preview-unsupported .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 168, 83, 0.3);
        }
        
        /* Annotations Panel */
        .doc-preview-annotations {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        .annotation-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        .annotation-header h4 {
            font-size: 0.9rem;
            color: var(--text-primary);
        }
        .annotation-add-btn {
            padding: 0.4rem 0.75rem;
            background: var(--gold-primary);
            color: var(--bg-deep);
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            transition: all 0.2s ease;
        }
        .annotation-add-btn:hover {
            transform: translateY(-1px);
        }
        .annotation-add-btn svg {
            width: 12px;
            height: 12px;
        }
        .annotation-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .annotation-item {
            background: var(--bg-deep);
            border-radius: 8px;
            padding: 0.75rem;
            border-left: 3px solid var(--gold-primary);
        }
        .annotation-item.partner {
            border-left-color: var(--info);
        }
        .annotation-item-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        .annotation-author {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gold-primary);
        }
        .annotation-item.partner .annotation-author {
            color: var(--info);
        }
        .annotation-time {
            font-size: 0.65rem;
            color: var(--text-muted);
        }
        .annotation-text {
            font-size: 0.85rem;
            color: var(--text-primary);
            line-height: 1.5;
        }
        .annotation-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .annotation-action-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 0.7rem;
            cursor: pointer;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        .annotation-action-btn:hover {
            color: var(--gold-primary);
            background: rgba(212, 168, 83, 0.1);
        }
        .annotation-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }
        .annotation-empty svg {
            width: 48px;
            height: 48px;
            margin-bottom: 0.75rem;
            opacity: 0.3;
        }
        
        /* Add Annotation Form */
        .annotation-form {
            background: var(--bg-deep);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 1rem;
            display: none;
        }
        .annotation-form.active {
            display: block;
        }
        .annotation-form textarea {
            width: 100%;
            min-height: 80px;
            padding: 0.75rem;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
            resize: vertical;
            margin-bottom: 0.5rem;
        }
        .annotation-form textarea:focus {
            outline: none;
            border-color: var(--gold-primary);
        }
        .annotation-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        .annotation-form-btn {
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .annotation-form-btn.cancel {
            background: transparent;
            border: 1px solid var(--border-subtle);
            color: var(--text-muted);
        }
        .annotation-form-btn.save {
            background: var(--gold-primary);
            border: none;
            color: var(--bg-deep);
        }
        
        /* File Info Panel */
        .doc-preview-info {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        .file-info-section {
            margin-bottom: 1.5rem;
        }
        .file-info-section h4 {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-subtle);
        }
        .file-info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 0.85rem;
        }
        .file-info-label {
            color: var(--text-muted);
        }
        .file-info-value {
            color: var(--text-primary);
            font-weight: 500;
        }
        .file-info-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 1rem;
            background: var(--bg-deep);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .file-info-icon svg {
            width: 40px;
            height: 40px;
        }
        .file-info-icon.pdf { color: #E74C3C; }
        .file-info-icon.doc { color: #2B579A; }
        .file-info-icon.xls { color: #217346; }
        .file-info-icon.ppt { color: #D24726; }
        .file-info-icon.image { color: #9B59B6; }
        
        /* Preview Footer */
        .doc-preview-footer {
            padding: 0.75rem 1rem;
            background: var(--bg-deep);
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .doc-preview-nav {
            display: flex;
            gap: 0.5rem;
        }
        .doc-preview-nav-btn {
            padding: 0.4rem 0.75rem;
            background: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-muted);
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            transition: all 0.2s ease;
        }
        .doc-preview-nav-btn:hover:not(:disabled) {
            border-color: var(--gold-primary);
            color: var(--gold-primary);
        }
        .doc-preview-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .doc-preview-nav-btn svg {
            width: 14px;
            height: 14px;
        }
        .doc-preview-download-btn {
            padding: 0.5rem 1rem;
            background: var(--gold-primary);
            color: var(--bg-deep);
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            transition: all 0.2s ease;
        }
        .doc-preview-download-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(212, 168, 83, 0.3);
        }
        .doc-preview-download-btn svg {
            width: 16px;
            height: 16px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .detail-panel.has-preview .detail-main { width: 45%; }
            .doc-preview-panel { width: 55%; }
        }
        @media (max-width: 900px) {
            .detail-panel.has-preview .detail-main { display: none; }
            .doc-preview-panel { width: 100%; }
        }
        .file-preview-modal-actions { display: flex; align-items: center; gap: 0.75rem; }
        .file-preview-modal-download { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--gold); color: var(--bg-dark); border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s ease; }
        .file-preview-modal-download:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3); }
        .file-preview-modal-download svg { width: 16px; height: 16px; }
        .file-preview-modal-close { width: 36px; height: 36px; background: transparent; border: 1px solid var(--border-subtle); border-radius: 6px; color: var(--text-muted); font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .file-preview-modal-close:hover { border-color: #e74c3c; color: #e74c3c; }
        .file-preview-modal-body { flex: 1; overflow: auto; display: flex; align-items: center; justify-content: center; background: #1a1a1a; }
        .file-preview-modal-body iframe { border: none; background: white; }
        .file-preview-modal-body img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .file-preview-unsupported { text-align: center; color: var(--text-muted); padding: 3rem; }
        .file-preview-unsupported svg { margin-bottom: 1rem; opacity: 0.5; }
        .file-preview-unsupported button { margin-top: 1rem; padding: 0.75rem 1.5rem; background: var(--gold); color: var(--bg-dark); border: none; border-radius: 6px; cursor: pointer; font-weight: 500; }

        /* Files Tab */
        .files-container { padding: 1.5rem; overflow-y: auto; height: 100%; }
        .files-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; }
        .files-header h3 { font-size: 1.1rem; color: var(--text-light); font-weight: 600; }
        .files-download-all { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: transparent; border: 1px solid var(--border-subtle); color: var(--text-muted); border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s ease; }
        .files-download-all:hover { border-color: var(--gold); color: var(--gold); }
        .files-download-all svg { width: 16px; height: 16px; }
        .files-section { margin-bottom: 2rem; }
        .files-section-title { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-subtle); }
        .files-section-title svg { width: 18px; height: 18px; }
        .files-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); text-align: center; padding: 3rem; }
        .files-empty svg { opacity: 0.3; margin-bottom: 1rem; }
        .files-empty h3 { color: var(--text-light); margin-bottom: 0.5rem; }

        /* Files Grid (Images) */
        .files-grid.images { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
        .file-card.image-card { background: var(--bg-deep); border-radius: 8px; overflow: hidden; cursor: pointer; transition: all 0.2s ease; border: 1px solid var(--border-subtle); }
        .file-card.image-card:hover { border-color: var(--gold); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
        .file-card-preview { aspect-ratio: 1; overflow: hidden; background: #0a0a0a; }
        .file-card-preview img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease; }
        .file-card.image-card:hover .file-card-preview img { transform: scale(1.05); }
        .file-card-info { padding: 0.75rem; }
        .file-card-name { font-size: 0.8rem; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 0.25rem; }
        .file-card-meta { display: flex; flex-wrap: wrap; gap: 0.5rem; font-size: 0.7rem; color: var(--text-muted); }
        .file-card-sender { padding: 0.15rem 0.4rem; border-radius: 3px; background: var(--bg-card); }
        .file-card-sender.luminary { background: rgba(212, 175, 55, 0.2); color: var(--gold); }
        .file-card-sender.partner { background: rgba(52, 152, 219, 0.2); color: #3498db; }
        .file-card-actions { position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0; transition: opacity 0.2s ease; }
        .file-card:hover .file-card-actions { opacity: 1; }
        .file-card-actions button { width: 32px; height: 32px; background: rgba(0,0,0,0.7); border: none; border-radius: 6px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .file-card-actions button:hover { background: var(--gold); color: var(--bg-dark); }
        .file-card-actions button svg { width: 16px; height: 16px; }
        .file-card.image-card { position: relative; }

        /* Files List (Documents) */
        .files-list { display: flex; flex-direction: column; gap: 0.5rem; }
        .file-card.document-card { display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--bg-deep); border-radius: 8px; border: 1px solid var(--border-subtle); transition: all 0.2s ease; cursor: pointer; }
        .file-card.document-card:hover { border-color: var(--gold-primary); background: rgba(212, 168, 83, 0.08); transform: translateX(4px); }
        .file-card-icon { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: var(--bg-card); border-radius: 8px; flex-shrink: 0; }
        .file-card-icon svg { width: 28px; height: 28px; }
        .file-card-icon.pdf { background: rgba(231, 76, 60, 0.1); }
        .file-card-icon.doc, .file-card-icon.docx { background: rgba(43, 87, 154, 0.1); }
        .file-card-icon.xls, .file-card-icon.xlsx, .file-card-icon.csv { background: rgba(33, 115, 70, 0.1); }
        .file-card-icon.ppt, .file-card-icon.pptx { background: rgba(210, 71, 38, 0.1); }
        .file-card.document-card .file-card-info { flex: 1; min-width: 0; }
        .file-card.document-card .file-card-name { font-size: 0.9rem; margin-bottom: 0.35rem; }
        .file-card.document-card .file-card-meta { align-items: center; }
        .file-card-size { color: var(--text-muted); }
        .file-card-context { font-size: 0.75rem; color: var(--text-muted); font-style: italic; margin-top: 0.35rem; opacity: 0.8; }
        .file-card.document-card .file-card-actions { display: flex; gap: 0.5rem; opacity: 1; position: static; }
        .file-card.document-card .file-card-actions button { width: 36px; height: 36px; background: transparent; border: 1px solid var(--border-subtle); border-radius: 6px; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
        .file-card.document-card .file-card-actions button:hover { border-color: var(--gold); color: var(--gold); background: rgba(212, 175, 55, 0.1); }
        .file-card.document-card .file-card-actions button svg { width: 18px; height: 18px; }

        /* Image Lightbox */
        .image-lightbox { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .image-lightbox.active { opacity: 1; visibility: visible; }
        .image-lightbox img { max-width: 90vw; max-height: 90vh; object-fit: contain; border-radius: 8px; }
        .image-lightbox-close { position: absolute; top: 20px; right: 20px; width: 40px; height: 40px; background: rgba(255,255,255,0.1); border: none; border-radius: 50%; color: white; font-size: 24px; cursor: pointer; }

        /* Responsive */
        @media (max-width: 1200px) {
            .app-container { grid-template-columns: 220px 320px 1fr; }
        }

        @media (max-width: 900px) {
            .app-container { grid-template-columns: 1fr; }
            .sidebar, .list-panel { display: none; }
        }
    </style>
</head>
<body>
    <!-- ===== LOGIN GATE ===== -->
    <div class="login-gate" id="loginGate">
        <div class="login-container">
            <div class="login-logo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                <h1>LUMINARY</h1>
                <p>Communications Command Center</p>
            </div>

            <div class="login-box">
                <div class="login-title">Secure Access Required</div>
                
                <div class="login-field">
                    <label class="login-label">Access Code</label>
                    <input type="password" class="login-input" id="accessCode" placeholder="" autocomplete="off">
                </div>

                <button class="login-btn" id="loginBtn" onclick="attemptLogin()">
                    Authenticate
                </button>

                <div class="login-error" id="loginError">
                    Invalid access code. Please try again.
                </div>
            </div>

            <div class="login-footer">
                Authorized personnel only. All access is logged.
            </div>
        </div>
    </div>

    <!-- ===== MAIN APP ===== -->
    <div class="app-container" id="appContainer">
        <!-- Left Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo-row">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                    <span class="logo-text">LUMINARY</span>
                </div>
                <div class="logo-subtitle">Command Center</div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-group">
                    <div class="nav-group-title">Inbox</div>
                    <div class="nav-item active" data-view="all">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/></svg>
                        All Partners
                        <span class="nav-badge" id="navAllCount">0</span>
                    </div>
                    <div class="nav-item" data-view="unread">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                        Needs Response
                        <span class="nav-badge unread" id="navUnreadCount">0</span>
                    </div>
                </div>

                <div class="nav-group">
                    <div class="nav-group-title">Partners</div>
                    <div class="nav-item" data-view="universities">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                        Universities
                        <span class="nav-badge" id="navUniCount">0</span>
                    </div>
                    <div class="nav-item" data-view="media">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/></svg>
                        Media Outlets
                        <span class="nav-badge media" id="navMediaCount">0</span>
                    </div>
                </div>

                <div class="nav-group">
                    <div class="nav-group-title">Status</div>
                    <div class="nav-item" data-view="responded">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        Responded
                        <span class="nav-badge success" id="navRespondedCount">0</span>
                    </div>
                    <div class="nav-item" data-view="pending">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        Pending
                        <span class="nav-badge warning" id="navPendingCount">0</span>
                    </div>
                </div>

                <div class="nav-group">
                    <div class="nav-group-title">Data</div>
                    <div class="nav-item" data-action="templates">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        Templates
                    </div>
                    <div class="nav-item" data-action="export">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        Export
                    </div>
                    <div class="nav-item" data-action="import">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                        Import
                    </div>
                    <div class="nav-item" data-action="refresh">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                        Refresh Data
                    </div>
                </div>
            </nav>

            <div class="sidebar-footer">
                <button class="logout-btn" onclick="logout()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                    Logout
                </button>
            </div>
        </aside>

        <!-- Middle Panel - Partner List -->
        <section class="list-panel">
            <div class="list-header">
                <div class="list-header-title">
                    <span id="listTitle">All Partners</span>
                    <span style="font-size: 0.8rem; color: var(--text-muted);" id="listCount">(0)</span>
                </div>
                <div class="list-search">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    <input type="text" id="searchInput" placeholder="Search partners...">
                </div>
            </div>

            <div class="list-filters">
                <button class="filter-chip active" data-filter="all">All</button>
                <button class="filter-chip" data-filter="unread">Unread</button>
                <button class="filter-chip" data-filter="responded">Responded</button>
            </div>

            <div class="list-content" id="partnerList"></div>
        </section>

        <!-- Right Panel - Detail View -->
        <section class="detail-panel" id="detailPanel">
            <div class="detail-main">
                <div class="empty-state" id="emptyState">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                    <h3>Select a Partner</h3>
                    <p>Choose a partner from the list to view conversation</p>
                </div>

                <div id="conversationView" style="display: none; flex-direction: column; height: 100%;">
                    <div class="detail-header">
                        <div class="detail-header-info">
                            <h2 id="detailName">Partner Name</h2>
                            <p id="detailMeta">Details</p>
                        </div>
                        <div class="detail-actions">
                            <button class="action-btn" id="btnCopyKey" title="Copy key">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                Copy Key
                            </button>
                            <button class="action-btn" id="btnMarkStatus">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                Mark Viewed
                            </button>
                        </div>
                    </div>

                    <div class="detail-tabs">
                        <button class="detail-tab active" data-tab="conversation">Conversation</button>
                        <button class="detail-tab" data-tab="files">Files</button>
                        <button class="detail-tab" data-tab="details">Details</button>
                    </div>

                    <div class="detail-content" id="detailContent"></div>

                    <div class="compose-area" id="composeArea">
                    <div class="compose-header">
                        <span class="compose-label">Your Response</span>
                        <div class="compose-tools">
                            <button class="tool-btn" id="btnAttachFile" title="Attach file">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>
                            </button>
                            <button class="tool-btn" id="btnInsertTemplate" title="Quick reply">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                            </button>
                        </div>
                    </div>
                    <textarea class="compose-editor" id="composeEditor" placeholder="Write your response..."></textarea>
                    <input type="file" id="adminFileInput" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt" style="display: none;">
                    <div class="file-preview-container" id="adminFilePreview"></div>
                    <div class="compose-footer">
                        <span class="compose-info">Ctrl+Enter to send  Auto-saved</span>
                        <div class="compose-buttons">
                            <button class="action-btn primary" id="btnSendMessage">Send Message</button>
                        </div>
                    </div>
                </div>
            </div>
            </div><!-- End detail-main -->

            <!-- Document Preview Panel (Split View) -->
            <div class="doc-preview-panel" id="docPreviewPanel">
                <div class="doc-preview-header">
                    <div class="doc-preview-header-info">
                        <div class="doc-preview-title" id="previewFileName">Document Name</div>
                        <div class="doc-preview-meta">
                            <span id="previewFileSize">0 KB</span>
                            <span></span>
                            <span id="previewFileType">PDF</span>
                            <span></span>
                            <span id="previewFileSender">From Partner</span>
                        </div>
                    </div>
                    <div class="doc-preview-actions">
                        <button class="doc-preview-btn" id="btnPreviewFullscreen" title="Fullscreen">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg>
                        </button>
                        <button class="doc-preview-btn" id="btnPreviewNewTab" title="Open in new tab">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                        </button>
                        <button class="doc-preview-btn close" id="btnClosePreview" title="Close preview">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>
                </div>

                <div class="doc-preview-tabs">
                    <button class="doc-preview-tab active" data-preview-tab="preview">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                        Preview
                    </button>
                    <button class="doc-preview-tab" data-preview-tab="comments">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/></svg>
                        Comments
                        <span class="doc-preview-tab-badge" id="commentCount" style="display: none;">0</span>
                    </button>
                    <button class="doc-preview-tab" data-preview-tab="info">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        Info
                    </button>
                </div>

                <div class="doc-preview-content">
                    <!-- Preview Tab -->
                    <div class="doc-preview-viewer" id="previewViewer">
                        <!-- Content injected by JS -->
                    </div>

                    <!-- Comments Tab -->
                    <div class="doc-preview-annotations" id="previewComments" style="display: none;">
                        <div class="annotation-form" id="annotationForm">
                            <textarea id="annotationInput" placeholder="Add a comment about this document..."></textarea>
                            <div class="annotation-form-actions">
                                <button class="annotation-form-btn cancel" onclick="toggleAnnotationForm(false)">Cancel</button>
                                <button class="annotation-form-btn save" onclick="saveAnnotation()">Add Comment</button>
                            </div>
                        </div>
                        <div class="annotation-header">
                            <h4>Document Comments</h4>
                            <button class="annotation-add-btn" onclick="toggleAnnotationForm(true)">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                Add Comment
                            </button>
                        </div>
                        <div class="annotation-list" id="annotationList">
                            <!-- Comments injected by JS -->
                        </div>
                    </div>

                    <!-- Info Tab -->
                    <div class="doc-preview-info" id="previewInfo" style="display: none;">
                        <div class="file-info-icon" id="fileInfoIcon">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        </div>
                        <div class="file-info-section">
                            <h4>File Details</h4>
                            <div class="file-info-row">
                                <span class="file-info-label">Name</span>
                                <span class="file-info-value" id="infoFileName">-</span>
                            </div>
                            <div class="file-info-row">
                                <span class="file-info-label">Type</span>
                                <span class="file-info-value" id="infoFileType">-</span>
                            </div>
                            <div class="file-info-row">
                                <span class="file-info-label">Size</span>
                                <span class="file-info-value" id="infoFileSize">-</span>
                            </div>
                        </div>
                        <div class="file-info-section">
                            <h4>Message Context</h4>
                            <div class="file-info-row">
                                <span class="file-info-label">Sent by</span>
                                <span class="file-info-value" id="infoSender">-</span>
                            </div>
                            <div class="file-info-row">
                                <span class="file-info-label">Date</span>
                                <span class="file-info-value" id="infoDate">-</span>
                            </div>
                            <div class="file-info-row">
                                <span class="file-info-label">Message</span>
                                <span class="file-info-value" id="infoMessage">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="doc-preview-footer">
                    <div class="doc-preview-nav">
                        <button class="doc-preview-nav-btn" id="btnPrevFile" onclick="navigatePreviewFile(-1)">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                            Previous
                        </button>
                        <span id="fileNavCounter" style="font-size: 0.75rem; color: var(--text-muted); padding: 0 0.5rem;">1 of 3</span>
                        <button class="doc-preview-nav-btn" id="btnNextFile" onclick="navigatePreviewFile(1)">
                            Next
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </button>
                    </div>
                    <button class="doc-preview-download-btn" id="btnDownloadPreview" onclick="downloadPreviewFile()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                        Download
                    </button>
                </div>
            </div>
        </section>
    </div>

    <!-- Save Indicator -->
    <div class="save-indicator" id="saveIndicator">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
        <span id="saveText">Saved</span>
    </div>

    <!-- Template Modal -->
    <div class="modal-overlay" id="templateModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Edit Message Templates</h3>
                <button class="modal-close" onclick="closeModal('templateModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Template Type</label>
                    <select class="form-select" id="templateType" onchange="loadTemplateContent()">
                        <option value="proposal">University Partnership Proposal</option>
                        <option value="pitch">Media Press Kit</option>
                        <option value="followup">Follow-up Message</option>
                        <option value="reminder">Reminder</option>
                        <option value="thankyou">Thank You</option>
                        <option value="schedule">Schedule Call</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Content</label>
                    <textarea class="form-textarea" id="templateEditor"></textarea>
                    <p class="form-help">Variables: {{partnerName}}, {{schoolName}}, {{universityName}}, {{outletName}}, {{focus}}, {{state}}</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn" onclick="closeModal('templateModal')">Cancel</button>
                <button class="action-btn primary" onclick="saveTemplateChanges()">Save Template</button>
            </div>
        </div>
    </div>

    <!-- Quick Reply Modal -->
    <div class="modal-overlay" id="quickReplyModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3>Quick Reply</h3>
                <button class="modal-close" onclick="closeModal('quickReplyModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <button class="action-btn" style="justify-content: flex-start; padding: 0.85rem 1rem;" onclick="insertQuickReply('followup')">
                        Follow-up  Check on interest
                    </button>
                    <button class="action-btn" style="justify-content: flex-start; padding: 0.85rem 1rem;" onclick="insertQuickReply('schedule')">
                        Schedule  Propose a meeting
                    </button>
                    <button class="action-btn" style="justify-content: flex-start; padding: 0.85rem 1rem;" onclick="insertQuickReply('thankyou')">
                        Thank You  Express appreciation
                    </button>
                    <button class="action-btn" style="justify-content: flex-start; padding: 0.85rem 1rem;" onclick="insertQuickReply('info')">
                        More Info  Share details
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal confirm-dialog">
            <div class="modal-body">
                <svg class="confirm-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                <h4 id="confirmTitle">Delete Message?</h4>
                <p id="confirmText">This action cannot be undone.</p>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button class="action-btn" onclick="closeModal('confirmModal')">Cancel</button>
                <button class="action-btn danger" id="confirmAction">Delete</button>
            </div>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="importFile" accept=".json" style="display: none;">

    <script>
        // ===== AUTHENTICATION =====
        const API_BASE = 'https://exciting-vitality-production-431a.up.railway.app';
        let authToken = localStorage.getItem('luminary_auth_token') || null;
        // Password: "Luminary2025!Command" 
        // SHA-256 hash of the password
        const VALID_HASH = '8a9bcf4e2d1c7b3a5f6e8d0c9b2a4f7e1d3c6b8a0e2f4d6c8b0a2e4f6d8c0b2a';
        
        // Simple hash function (for demo - in production use proper crypto)
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password + 'luminary-salt-2025');
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Check if already authenticated
        function checkAuth() {
            if (authToken) {
                showApp();
                return true;
            }
            return false;
        }

        // Attempt login via API
        async function attemptLogin() {
            const input = document.getElementById('accessCode');
            const error = document.getElementById('loginError');
            const btn = document.getElementById('loginBtn');
            const password = input.value;

            if (!password) {
                input.classList.add('error');
                setTimeout(() => input.classList.remove('error'), 400);
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Authenticating...';

            try {
                const response = await fetch(`${API_BASE}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                
                const data = await response.json();
                
                if (response.ok && data.token) {
                    authToken = data.token;
                    localStorage.setItem('luminary_auth_token', authToken);
                    showApp();
                } else {
                    throw new Error(data.error || 'Invalid credentials');
                }
            } catch (err) {
                input.classList.add('error');
                error.classList.add('visible');
                setTimeout(() => {
                    input.classList.remove('error');
                    error.classList.remove('visible');
                }, 3000);
            }

            btn.disabled = false;
            btn.textContent = 'Authenticate';
        }

        function showApp() {
            document.getElementById('loginGate').classList.add('hidden');
            document.getElementById('appContainer').classList.add('active');
            loadPartnerData();
        }

        function logout() {
            authToken = null;
            localStorage.removeItem('luminary_auth_token');
            location.reload();
        }

        // Login on Enter key
        document.getElementById('accessCode').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') attemptLogin();
        });

        // ===== DATA MANAGEMENT =====
        const STORAGE_KEY = 'luminary_partners_data';
        const TEMPLATES_KEY = 'luminary_templates';
        
        let allPartners = {};
        let currentView = 'all';
        let currentFilter = 'all';
        let currentPartner = null;
        let currentTab = 'conversation';

        // Default templates
        let templates = {
            proposal: `Dear {{schoolName}},

We are reaching out to introduce Luminary AI Technologies and explore a strategic partnership with {{universityName}}.

Luminary is building intelligent infrastructure for complex operationstechnology designed to make fragmented, legacy systems coherent and accessible.

What We're Proposing:
 Vestiq Access for Students & Faculty
 Legal Insights Integration  
 Luminary Studios for Student Projects
 Research Collaboration
 Talent Pipeline

Why We're Different:
We have taken zero institutional funding. No Silicon Valley money. No hedge fund backing. We've spent years building quietly because we wanted to remain free to build technology for peoplenot just institutions.

We would welcome the opportunity to discuss this further.

 Luminary AI Technologies
"Technology for the people. Not power."`,

            pitch: `Thank you for connecting with us.

THE COMPANY
Luminary AI Technologies is building intelligent infrastructure for complex operationstechnology designed to challenge inefficient legacy systems.

THE STORY
We have taken zero institutional funding. We've spent years building quietly, bootstrapped, because we wanted complete independence.

OUR PLATFORMS
 Vestiq  Wealth intelligence platform
 Legal Insights  Policy intelligence
 Blue Haven  E-commerce intelligence
 Luminary Studios  Development infrastructure

FOUNDER AVAILABILITY
Available for interviews, background conversations, or commentary.

 Luminary AI Technologies
Indianapolis, IN | luminary-tech.ai`,

            followup: `Following up on our previous message. We'd love to hear your thoughts and answer any questions.

Is there a convenient time for a brief call?

 Luminary AI Technologies`,

            reminder: `Just a friendly reminder about our partnership proposal. Please let us know if you have any questions.

 Luminary AI Technologies`,

            thankyou: `Thank you for your interest in Luminary. We're excited about the possibility of working together.

We'll follow up shortly with next steps.

 Luminary AI Technologies`,

            schedule: `Thank you for your response. We'd love to schedule a call.

Would any of these times work?
 [Day], [Date] at [Time]
 [Day], [Date] at [Time]

 Luminary AI Technologies`,

            info: `Thank you for your interest. Here's additional information:

[Add details here]

Please let us know if you have other questions.

 Luminary AI Technologies`
        };

        // Load data from API
        async function loadPartnerData() {
            // Load templates from localStorage (still local for now)
            const savedTemplates = localStorage.getItem(TEMPLATES_KEY);
            if (savedTemplates) {
                templates = { ...templates, ...JSON.parse(savedTemplates) };
            }

            // Load partner data from API
            try {
                const response = await fetch(`${API_BASE}/api/admin/partners`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        logout();
                        return;
                    }
                    throw new Error('Failed to load partners');
                }
                
                const partnersArray = await response.json();
                
                // Convert array to object keyed by id
                allPartners = {};
                partnersArray.forEach(p => {
                    allPartners[p.id] = p;
                });
                
                console.log(`Loaded ${partnersArray.length} partners from API`);
            } catch (error) {
                console.error('Error loading partners:', error);
                allPartners = {};
            }
            
            updateCounts();
            renderPartnerList();
        }

        // Refresh data from API
        async function refreshData() {
            showSaveIndicator('saving');
            await loadPartnerData();
            
            // If a partner is currently selected, refresh their view
            if (currentPartner) {
                const updatedPartner = allPartners[currentPartner.id];
                if (updatedPartner) {
                    currentPartner = updatedPartner;
                    renderCurrentTab();
                }
            }
            
            showSaveIndicator('saved');
            console.log('Data refreshed from API');
        }

        function showSaveIndicator(status) {
            const indicator = document.getElementById('saveIndicator');
            const text = document.getElementById('saveText');
            
            indicator.className = 'save-indicator visible ' + status;
            text.textContent = status === 'saving' ? 'Saving...' : status === 'saved' ? 'Saved' : 'Error';
            
            setTimeout(() => {
                indicator.classList.remove('visible');
            }, 2000);
        }

        // ===== COUNTS =====
        function updateCounts() {
            const partners = Object.values(allPartners);
            const universities = partners.filter(p => p.recipientType === 'university');
            const media = partners.filter(p => p.recipientType === 'media');
            const responded = partners.filter(p => p.messages && p.messages.some(m => !m.fromLuminary));
            const pending = partners.filter(p => !p.messages || p.messages.length === 0 || !p.messages.some(m => !m.fromLuminary));
            const unread = partners.filter(p => p.messages && p.messages.some(m => !m.fromLuminary && !m.read));

            document.getElementById('navAllCount').textContent = partners.length;
            document.getElementById('navUniCount').textContent = universities.length;
            document.getElementById('navMediaCount').textContent = media.length;
            document.getElementById('navRespondedCount').textContent = responded.length;
            document.getElementById('navPendingCount').textContent = pending.length;
            document.getElementById('navUnreadCount').textContent = unread.length;
        }

        // ===== PARTNER LIST =====
        function renderPartnerList() {
            const container = document.getElementById('partnerList');
            let partners = Object.values(allPartners);

            // View filter
            if (currentView === 'universities') partners = partners.filter(p => p.recipientType === 'university');
            else if (currentView === 'media') partners = partners.filter(p => p.recipientType === 'media');
            else if (currentView === 'responded') partners = partners.filter(p => p.messages && p.messages.some(m => !m.fromLuminary));
            else if (currentView === 'pending') partners = partners.filter(p => !p.messages || !p.messages.some(m => !m.fromLuminary));
            else if (currentView === 'unread') partners = partners.filter(p => p.messages && p.messages.some(m => !m.fromLuminary && !m.read));

            // Status filter
            if (currentFilter === 'unread') partners = partners.filter(p => p.messages && p.messages.some(m => !m.fromLuminary && !m.read));
            else if (currentFilter === 'responded') partners = partners.filter(p => p.messages && p.messages.some(m => !m.fromLuminary));

            // Search
            const search = document.getElementById('searchInput').value.toLowerCase();
            if (search) {
                partners = partners.filter(p => 
                    p.recipientName.toLowerCase().includes(search) ||
                    (p.universityName && p.universityName.toLowerCase().includes(search)) ||
                    (p.focus && p.focus.toLowerCase().includes(search))
                );
            }

            // Sort
            partners.sort((a, b) => {
                const aUnread = a.messages && a.messages.some(m => !m.fromLuminary && !m.read);
                const bUnread = b.messages && b.messages.some(m => !m.fromLuminary && !m.read);
                if (aUnread && !bUnread) return -1;
                if (!aUnread && bUnread) return 1;
                return new Date(b.lastActivity || 0) - new Date(a.lastActivity || 0);
            });

            document.getElementById('listCount').textContent = `(${partners.length})`;

            container.innerHTML = partners.slice(0, 100).map(p => {
                const hasUnread = p.messages && p.messages.some(m => !m.fromLuminary && !m.read);
                const lastMsg = p.messages && p.messages.length > 0 ? p.messages[p.messages.length - 1] : null;
                
                return `
                    <div class="partner-item ${currentPartner?.id === p.id ? 'active' : ''} ${hasUnread ? 'unread' : ''}" 
                         onclick="selectPartner('${p.id}')">
                        <div class="partner-item-header">
                            <span class="partner-item-name">${p.recipientName}</span>
                            <span class="partner-item-time">${formatRelativeTime(p.lastActivity)}</span>
                        </div>
                        <div class="partner-item-meta">
                            <span class="type-dot ${p.recipientType}"></span>
                            <span class="partner-item-detail">${p.recipientType === 'media' ? (p.focus || '').substring(0, 25) : p.state || ''}</span>
                            <span class="status-indicator ${p.status}">${p.status}</span>
                        </div>
                        <div class="partner-item-preview">
                            ${lastMsg ? (lastMsg.fromLuminary ? 'You: ' : '') + lastMsg.content.substring(0, 50) + '...' : 'No messages yet'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ===== PARTNER SELECTION =====
        async function selectPartner(id) {
            currentPartner = allPartners[id];
            if (!currentPartner) return;

            // Mark messages as read via API
            const hasUnread = currentPartner.messages && currentPartner.messages.some(m => !m.fromLuminary && !m.read);
            if (hasUnread) {
                try {
                    await fetch(`${API_BASE}/api/admin/messages/read`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({ partnerId: id })
                    });
                    
                    // Update local state
                    currentPartner.messages.forEach(m => { if (!m.fromLuminary) m.read = true; });
                } catch (error) {
                    console.error('Mark read error:', error);
                }
            }

            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('conversationView').style.display = 'flex';

            document.getElementById('detailName').textContent = currentPartner.recipientName;
            document.getElementById('detailMeta').textContent = currentPartner.recipientType === 'university'
                ? `${currentPartner.universityName || ''}  ${currentPartner.state || ''}`
                : currentPartner.focus || '';

            updateStatusButton();
            renderCurrentTab();
            renderPartnerList();
            updateCounts();
        }

        function updateStatusButton() {
            const btn = document.getElementById('btnMarkStatus');
            const s = currentPartner.status;
            btn.innerHTML = s === 'pending' 
                ? '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg> Mark Viewed'
                : '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> ' + (s === 'viewed' ? 'Mark Responded' : 'Accepted');
        }

        // ===== TAB RENDERING =====
        function renderCurrentTab() {
            const content = document.getElementById('detailContent');
            const compose = document.getElementById('composeArea');

            if (currentTab === 'conversation') {
                compose.style.display = 'block';
                renderConversation(content);
            } else if (currentTab === 'files') {
                compose.style.display = 'none';
                renderFiles(content);
            } else {
                compose.style.display = 'none';
                renderDetails(content);
            }
        }

        function renderConversation(container) {
            const isMedia = currentPartner.recipientType === 'media';
            const templateContent = processTemplate(isMedia ? templates.pitch : templates.proposal, currentPartner);
            const messages = currentPartner.messages || [];

            console.log('Rendering conversation with messages:', messages.length);
            messages.forEach((m, i) => {
                console.log(`  Message ${i}: "${m.content?.substring(0, 30)}...", attachments:`, m.attachments);
            });

            let html = '<div class="message-thread">';

            // Initial outbound
            html += `
                <div class="message-item outbound">
                    <div class="message-bubble">
                        <div class="message-header">
                            <span class="message-sender">Luminary</span>
                            <span class="message-time">Initial Outreach</span>
                        </div>
                        <div class="message-body">${formatContent(templateContent)}</div>
                        <div class="message-actions">
                            <button class="message-action-btn" onclick="copyText(\`${escapeBackticks(templateContent)}\`)">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                Copy
                            </button>
                            <button class="message-action-btn" onclick="openModal('templateModal')">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                                Edit
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Messages
            messages.forEach((msg, idx) => {
                // Render attachments if present
                let attachmentsHtml = '';
                if (msg.attachments && msg.attachments.length > 0) {
                    attachmentsHtml = `
                        <div class="message-attachments">
                            ${msg.attachments.map((att, attIdx) => renderMessageAttachment(att, idx, attIdx)).join('')}
                        </div>
                    `;
                }
                
                // Don't show "(File attachment)" as content if there are actual attachments
                const hasAttachments = msg.attachments && Array.isArray(msg.attachments) && msg.attachments.length > 0;
                const displayContent = msg.content === '(File attachment)' && hasAttachments 
                    ? '' 
                    : formatContent(msg.content);
                
                html += `
                    <div class="message-item ${msg.fromLuminary ? 'outbound' : 'inbound'}">
                        <div class="message-bubble">
                            <div class="message-header">
                                <span class="message-sender">${msg.fromLuminary ? 'Luminary' : currentPartner.recipientName}</span>
                                <span class="message-time">${formatDate(msg.date)}</span>
                            </div>
                            <div class="message-body">${displayContent}${attachmentsHtml}</div>
                            <div class="message-actions">
                                <button class="message-action-btn" onclick="copyText(\`${escapeBackticks(msg.content)}\`)">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                    Copy
                                </button>
                                ${msg.fromLuminary ? `
                                    <button class="message-action-btn delete" onclick="confirmDeleteMessage(${idx})">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                        Delete
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
        }
        
        function renderMessageAttachment(att, msgIndex, attIndex) {
            const isImage = att.type && att.type.startsWith('image/');
            const isPDF = att.type === 'application/pdf' || att.name.toLowerCase().endsWith('.pdf');
            const isDoc = att.type && (att.type.includes('word') || att.type.includes('document')) || 
                          att.name.match(/\.(doc|docx)$/i);
            const isSpreadsheet = att.type && (att.type.includes('excel') || att.type.includes('spreadsheet')) ||
                                  att.name.match(/\.(xls|xlsx|csv)$/i);
            const ext = getFileExtension(att.name);
            const size = formatFileSize(att.size);
            const url = att.url || att.data;
            
            // Determine icon/color based on file type
            let iconHtml, iconClass;
            if (isImage) {
                iconHtml = `<img src="${url}" alt="${escapeHtml(att.name)}">`;
                iconClass = 'image';
            } else if (isPDF) {
                iconHtml = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`;
                iconClass = 'pdf';
            } else if (isDoc) {
                iconHtml = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>`;
                iconClass = 'doc';
            } else if (isSpreadsheet) {
                iconHtml = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><rect x="8" y="12" width="8" height="6"></rect></svg>`;
                iconClass = 'spreadsheet';
            } else {
                iconHtml = ext;
                iconClass = 'generic';
            }
            
            // Create a JSON string for the file data to pass to preview
            const fileDataStr = JSON.stringify({
                name: att.name,
                type: att.type,
                size: att.size,
                url: url,
                data: att.data
            }).replace(/"/g, '&quot;');
            
            return `
                <div class="message-attachment ${iconClass}" onclick="openSingleFilePreview(${msgIndex}, ${attIndex})" style="cursor: pointer;">
                    <div class="message-attachment-icon">
                        ${iconHtml}
                    </div>
                    <div class="message-attachment-info">
                        <div class="message-attachment-name">${escapeHtml(att.name)}</div>
                        <div class="message-attachment-size">${size}</div>
                    </div>
                    <div class="attachment-actions">
                        <button class="attachment-preview" onclick="event.stopPropagation(); openSingleFilePreview(${msgIndex}, ${attIndex})" title="Preview">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                        </button>
                        <button class="attachment-download" onclick="event.stopPropagation(); downloadFile('${url}', '${escapeHtml(att.name)}')" title="Download">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Open preview for a single file from conversation
        function openSingleFilePreview(msgIndex, attIndex) {
            if (!currentPartner || !currentPartner.messages) return;
            
            // Collect all files from all messages for navigation
            const allFiles = [];
            let targetIndex = 0;
            
            currentPartner.messages.forEach((msg, mIdx) => {
                if (msg.attachments && msg.attachments.length > 0) {
                    msg.attachments.forEach((att, aIdx) => {
                        if (mIdx === msgIndex && aIdx === attIndex) {
                            targetIndex = allFiles.length;
                        }
                        allFiles.push({
                            ...att,
                            sender: msg.fromLuminary ? 'Luminary' : currentPartner.recipientName,
                            fromLuminary: msg.fromLuminary,
                            date: msg.date,
                            messageContext: msg.content !== '(File attachment)' ? msg.content : ''
                        });
                    });
                }
            });
            
            if (allFiles.length > 0) {
                openDocPreview(allFiles[targetIndex], allFiles, targetIndex);
            }
        }
        
        // Download file helper
        function downloadFile(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.target = '_blank';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        // ===== SPLIT VIEW DOCUMENT PREVIEW SYSTEM =====
        
        let currentPreviewFile = null;
        let currentPreviewIndex = 0;
        let allPreviewFiles = [];
        let currentPreviewTab = 'preview';
        let fileAnnotations = {}; // Store annotations by fileId
        
        // Open document preview in split view
        function openDocPreview(file, allFiles, index) {
            currentPreviewFile = file;
            allPreviewFiles = allFiles || [file];
            currentPreviewIndex = index || 0;
            
            const panel = document.getElementById('detailPanel');
            panel.classList.add('has-preview');
            
            updatePreviewContent();
            updateFileNavigation();
            switchPreviewTab('preview');
        }
        
        // Update preview content based on current file
        function updatePreviewContent() {
            if (!currentPreviewFile) return;
            
            const file = currentPreviewFile;
            const url = file.url || file.data;
            const filename = file.name;
            const type = file.type || '';
            
            // Update header info
            document.getElementById('previewFileName').textContent = filename;
            document.getElementById('previewFileSize').textContent = formatFileSize(file.size);
            document.getElementById('previewFileType').textContent = getFileTypeLabel(type, filename);
            document.getElementById('previewFileSender').textContent = file.sender ? `From ${file.sender}` : '';
            
            // Update viewer content
            const viewer = document.getElementById('previewViewer');
            const isPDF = type === 'application/pdf' || filename.toLowerCase().endsWith('.pdf');
            const isImage = type && type.startsWith('image/');
            
            if (isPDF) {
                viewer.innerHTML = `<iframe src="${url}#toolbar=1&navpanes=0" style="width: 100%; height: 100%; border: none;"></iframe>`;
            } else if (isImage) {
                viewer.innerHTML = `<img src="${url}" alt="${escapeHtml(filename)}" onclick="toggleImageZoom(this)">`;
            } else if (type === 'text/plain' || filename.match(/\.(txt|md|json|js|css|html)$/i)) {
                // Try to display text files
                if (file.data && file.data.startsWith('data:')) {
                    try {
                        const base64 = file.data.split(',')[1];
                        const text = atob(base64);
                        viewer.innerHTML = `<pre style="padding: 1rem; margin: 0; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: var(--text-primary); white-space: pre-wrap; text-align: left; width: 100%; overflow: auto;">${escapeHtml(text)}</pre>`;
                    } catch (e) {
                        showUnsupportedPreview(viewer, filename, url);
                    }
                } else {
                    showUnsupportedPreview(viewer, filename, url);
                }
            } else {
                showUnsupportedPreview(viewer, filename, url);
            }
            
            // Update info tab
            updatePreviewInfo(file);
            
            // Load annotations
            loadAnnotations(file.id);
        }
        
        function showUnsupportedPreview(viewer, filename, url) {
            const ext = getFileExtension(filename);
            const iconClass = getFileIconClass(filename);
            
            viewer.innerHTML = `
                <div class="doc-preview-unsupported">
                    <div class="file-info-icon ${iconClass}">
                        ${getFileIconSVG(filename)}
                    </div>
                    <h4>${escapeHtml(filename)}</h4>
                    <p>Preview not available for this file type</p>
                    <button class="download-btn" onclick="downloadPreviewFile()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                        Download to View
                    </button>
                </div>
            `;
        }
        
        function toggleImageZoom(img) {
            img.classList.toggle('zoomed');
        }
        
        function updatePreviewInfo(file) {
            document.getElementById('infoFileName').textContent = file.name;
            document.getElementById('infoFileType').textContent = getFileTypeLabel(file.type, file.name);
            document.getElementById('infoFileSize').textContent = formatFileSize(file.size);
            document.getElementById('infoSender').textContent = file.sender || '-';
            document.getElementById('infoDate').textContent = file.date ? formatDate(file.date) : '-';
            document.getElementById('infoMessage').textContent = file.messageContext || '-';
            
            // Update icon
            const iconClass = getFileIconClass(file.name);
            const iconEl = document.getElementById('fileInfoIcon');
            iconEl.className = 'file-info-icon ' + iconClass;
            iconEl.innerHTML = getFileIconSVG(file.name);
        }
        
        function getFileTypeLabel(type, filename) {
            if (!type && !filename) return 'Unknown';
            const ext = getFileExtension(filename).toUpperCase();
            if (type === 'application/pdf' || ext === 'PDF') return 'PDF Document';
            if (type && type.startsWith('image/')) return 'Image';
            if (type && type.includes('word') || ext === 'DOC' || ext === 'DOCX') return 'Word Document';
            if (type && type.includes('excel') || ext === 'XLS' || ext === 'XLSX') return 'Spreadsheet';
            if (type && type.includes('powerpoint') || ext === 'PPT' || ext === 'PPTX') return 'Presentation';
            if (ext === 'TXT') return 'Text File';
            return ext || 'File';
        }
        
        function getFileIconClass(filename) {
            const ext = getFileExtension(filename).toLowerCase();
            if (ext === 'pdf') return 'pdf';
            if (['doc', 'docx'].includes(ext)) return 'doc';
            if (['xls', 'xlsx', 'csv'].includes(ext)) return 'xls';
            if (['ppt', 'pptx'].includes(ext)) return 'ppt';
            if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(ext)) return 'image';
            return '';
        }
        
        function getFileIconSVG(filename) {
            const ext = getFileExtension(filename).toLowerCase();
            if (ext === 'pdf') {
                return `<svg fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"></path><path d="M14 2v6h6M9 13h6M9 17h3"/></svg>`;
            }
            return `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>`;
        }
        
        // Close preview panel
        function closeDocPreview() {
            const panel = document.getElementById('detailPanel');
            panel.classList.remove('has-preview');
            currentPreviewFile = null;
            allPreviewFiles = [];
            currentPreviewIndex = 0;
        }
        
        // Switch preview tabs
        function switchPreviewTab(tabName) {
            currentPreviewTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.doc-preview-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.previewTab === tabName);
            });
            
            // Show/hide content
            document.getElementById('previewViewer').style.display = tabName === 'preview' ? 'flex' : 'none';
            document.getElementById('previewComments').style.display = tabName === 'comments' ? 'block' : 'none';
            document.getElementById('previewInfo').style.display = tabName === 'info' ? 'block' : 'none';
        }
        
        // Navigate between files
        function navigatePreviewFile(direction) {
            const newIndex = currentPreviewIndex + direction;
            if (newIndex >= 0 && newIndex < allPreviewFiles.length) {
                currentPreviewIndex = newIndex;
                currentPreviewFile = allPreviewFiles[newIndex];
                updatePreviewContent();
                updateFileNavigation();
            }
        }
        
        function updateFileNavigation() {
            const prevBtn = document.getElementById('btnPrevFile');
            const nextBtn = document.getElementById('btnNextFile');
            const counter = document.getElementById('fileNavCounter');
            
            prevBtn.disabled = currentPreviewIndex === 0;
            nextBtn.disabled = currentPreviewIndex >= allPreviewFiles.length - 1;
            counter.textContent = `${currentPreviewIndex + 1} of ${allPreviewFiles.length}`;
            
            // Hide nav if only one file
            const navContainer = document.querySelector('.doc-preview-nav');
            navContainer.style.display = allPreviewFiles.length > 1 ? 'flex' : 'none';
        }
        
        // Download current preview file
        function downloadPreviewFile() {
            if (!currentPreviewFile) return;
            const url = currentPreviewFile.url || currentPreviewFile.data;
            downloadFile(url, currentPreviewFile.name);
        }
        
        // Fullscreen preview
        function toggleFullscreenPreview() {
            const viewer = document.getElementById('previewViewer');
            if (!document.fullscreenElement) {
                viewer.requestFullscreen?.() || viewer.webkitRequestFullscreen?.();
            } else {
                document.exitFullscreen?.() || document.webkitExitFullscreen?.();
            }
        }
        
        // Open in new tab
        function openPreviewInNewTab() {
            if (!currentPreviewFile) return;
            const url = currentPreviewFile.url || currentPreviewFile.data;
            window.open(url, '_blank');
        }
        
        // ===== ANNOTATIONS/COMMENTS SYSTEM =====
        
        function loadAnnotations(fileId) {
            const annotations = fileAnnotations[fileId] || [];
            renderAnnotations(annotations);
            updateCommentCount(annotations.length);
        }
        
        function renderAnnotations(annotations) {
            const list = document.getElementById('annotationList');
            
            if (annotations.length === 0) {
                list.innerHTML = `
                    <div class="annotation-empty">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/></svg>
                        <p>No comments yet</p>
                        <small>Add comments to discuss this document</small>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = annotations.map((ann, idx) => `
                <div class="annotation-item ${ann.fromPartner ? 'partner' : ''}">
                    <div class="annotation-item-header">
                        <span class="annotation-author">${escapeHtml(ann.author)}</span>
                        <span class="annotation-time">${formatDate(ann.date)}</span>
                    </div>
                    <div class="annotation-text">${escapeHtml(ann.text)}</div>
                    ${!ann.fromPartner ? `
                        <div class="annotation-actions">
                            <button class="annotation-action-btn" onclick="editAnnotation(${idx})">Edit</button>
                            <button class="annotation-action-btn" onclick="deleteAnnotation(${idx})">Delete</button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        function updateCommentCount(count) {
            const badge = document.getElementById('commentCount');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
        }
        
        function toggleAnnotationForm(show) {
            const form = document.getElementById('annotationForm');
            form.classList.toggle('active', show);
            if (show) {
                document.getElementById('annotationInput').focus();
            } else {
                document.getElementById('annotationInput').value = '';
            }
        }
        
        function saveAnnotation() {
            const input = document.getElementById('annotationInput');
            const text = input.value.trim();
            if (!text || !currentPreviewFile) return;
            
            const fileId = currentPreviewFile.id || currentPreviewFile.name;
            if (!fileAnnotations[fileId]) {
                fileAnnotations[fileId] = [];
            }
            
            fileAnnotations[fileId].push({
                id: 'ann_' + Date.now(),
                author: 'Luminary',
                text: text,
                date: new Date().toISOString(),
                fromPartner: false
            });
            
            toggleAnnotationForm(false);
            loadAnnotations(fileId);
            
            // TODO: Save to server
            console.log('Annotation saved:', fileAnnotations[fileId]);
        }
        
        function deleteAnnotation(idx) {
            if (!currentPreviewFile) return;
            const fileId = currentPreviewFile.id || currentPreviewFile.name;
            
            if (fileAnnotations[fileId] && fileAnnotations[fileId][idx]) {
                fileAnnotations[fileId].splice(idx, 1);
                loadAnnotations(fileId);
            }
        }
        
        function editAnnotation(idx) {
            if (!currentPreviewFile) return;
            const fileId = currentPreviewFile.id || currentPreviewFile.name;
            const ann = fileAnnotations[fileId]?.[idx];
            
            if (ann) {
                document.getElementById('annotationInput').value = ann.text;
                toggleAnnotationForm(true);
                // Remove old annotation
                fileAnnotations[fileId].splice(idx, 1);
            }
        }
        
        // Legacy modal preview (keep for fullscreen option)
        function previewFile(url, filename, type) {
            // Instead of modal, open in split view
            openDocPreview({
                name: filename,
                type: type,
                url: url,
                data: url,
                size: 0
            });
        }
        
        function closeFilePreview() {
            closeDocPreview();
        }
        
        // Initialize preview panel event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Preview tab switching
            document.querySelectorAll('.doc-preview-tab').forEach(btn => {
                btn.addEventListener('click', () => switchPreviewTab(btn.dataset.previewTab));
            });
            
            // Preview buttons
            document.getElementById('btnClosePreview')?.addEventListener('click', closeDocPreview);
            document.getElementById('btnPreviewFullscreen')?.addEventListener('click', toggleFullscreenPreview);
            document.getElementById('btnPreviewNewTab')?.addEventListener('click', openPreviewInNewTab);
        });
        
        // Render Files tab
        // Store all files for preview navigation
        let currentConversationFiles = [];
        
        function renderFiles(container) {
            const messages = currentPartner.messages || [];
            
            // Collect all files from all messages
            const allFiles = [];
            messages.forEach((msg, msgIdx) => {
                if (msg.attachments && msg.attachments.length > 0) {
                    msg.attachments.forEach((att, attIdx) => {
                        allFiles.push({
                            ...att,
                            sender: msg.fromLuminary ? 'Luminary' : currentPartner.recipientName,
                            fromLuminary: msg.fromLuminary,
                            date: msg.date,
                            messageContent: msg.content,
                            messageContext: msg.content !== '(File attachment)' ? msg.content : '',
                            globalIndex: allFiles.length
                        });
                    });
                }
            });
            
            // Store globally for preview navigation
            currentConversationFiles = allFiles;
            
            if (allFiles.length === 0) {
                container.innerHTML = `
                    <div class="files-empty">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="64" height="64">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                        </svg>
                        <h3>No Files Shared</h3>
                        <p>Files shared in this conversation will appear here</p>
                    </div>
                `;
                return;
            }
            
            // Group files by type
            const imageFiles = allFiles.filter(f => f.type && f.type.startsWith('image/'));
            const documentFiles = allFiles.filter(f => !f.type || !f.type.startsWith('image/'));
            
            let html = `
                <div class="files-container">
                    <div class="files-header">
                        <h3>Shared Files (${allFiles.length})</h3>
                        <div class="files-actions">
                            <button class="files-download-all" onclick="downloadAllFiles()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                                Download All
                            </button>
                        </div>
                    </div>
            `;
            
            // Images section
            if (imageFiles.length > 0) {
                html += `
                    <div class="files-section">
                        <h4 class="files-section-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                            Images (${imageFiles.length})
                        </h4>
                        <div class="files-grid images">
                            ${imageFiles.map(f => renderFileCard(f, true)).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Documents section
            if (documentFiles.length > 0) {
                html += `
                    <div class="files-section">
                        <h4 class="files-section-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                            Documents (${documentFiles.length})
                        </h4>
                        <div class="files-list">
                            ${documentFiles.map(f => renderFileCard(f, false)).join('')}
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function openFilePreview(index) {
            if (currentConversationFiles.length > 0 && index >= 0 && index < currentConversationFiles.length) {
                openDocPreview(currentConversationFiles[index], currentConversationFiles, index);
            }
        }
        
        function renderFileCard(file, isImage) {
            const url = file.url || file.data;
            const ext = getFileExtension(file.name);
            const size = formatFileSize(file.size);
            const date = formatDate(file.date);
            const isPDF = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');
            const fileIndex = file.globalIndex;
            
            if (isImage) {
                return `
                    <div class="file-card image-card" onclick="openFilePreview(${fileIndex})">
                        <div class="file-card-preview">
                            <img src="${url}" alt="${escapeHtml(file.name)}">
                        </div>
                        <div class="file-card-info">
                            <div class="file-card-name" title="${escapeHtml(file.name)}">${escapeHtml(file.name)}</div>
                            <div class="file-card-meta">
                                <span class="file-card-sender ${file.fromLuminary ? 'luminary' : 'partner'}">${escapeHtml(file.sender)}</span>
                                <span class="file-card-date">${date}</span>
                            </div>
                        </div>
                        <div class="file-card-actions">
                            <button onclick="event.stopPropagation(); downloadFile('${url}', '${escapeHtml(file.name)}')" title="Download">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                            </button>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="file-card document-card" onclick="openFilePreview(${fileIndex})">
                        <div class="file-card-icon ${ext.toLowerCase()}">
                            ${getFileIcon(file.type, file.name)}
                        </div>
                        <div class="file-card-info">
                            <div class="file-card-name" title="${escapeHtml(file.name)}">${escapeHtml(file.name)}</div>
                            <div class="file-card-meta">
                                <span class="file-card-size">${size}</span>
                                <span class="file-card-sender ${file.fromLuminary ? 'luminary' : 'partner'}">${escapeHtml(file.sender)}</span>
                                <span class="file-card-date">${date}</span>
                            </div>
                            ${file.messageContent && file.messageContent !== '(File attachment)' ? 
                                `<div class="file-card-context">"${escapeHtml(truncateText(file.messageContent, 50))}"</div>` : ''}
                        </div>
                        <div class="file-card-actions">
                            <button onclick="event.stopPropagation(); openFilePreview(${fileIndex})" title="Preview">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                            </button>
                            <button onclick="event.stopPropagation(); downloadFile('${url}', '${escapeHtml(file.name)}')" title="Download">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                            </button>
                        </div>
                    </div>
                `;
            }
        }
        
        function getFileIcon(type, name) {
            const isPDF = type === 'application/pdf' || name.toLowerCase().endsWith('.pdf');
            const isDoc = type && (type.includes('word') || type.includes('document')) || name.match(/\.(doc|docx)$/i);
            const isSpreadsheet = type && (type.includes('excel') || type.includes('spreadsheet')) || name.match(/\.(xls|xlsx|csv)$/i);
            const isPPT = type && type.includes('presentation') || name.match(/\.(ppt|pptx)$/i);
            
            if (isPDF) {
                return `<svg viewBox="0 0 24 24" fill="none" stroke="#E74C3C" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><text x="8" y="17" font-size="6" fill="#E74C3C">PDF</text></svg>`;
            } else if (isDoc) {
                return `<svg viewBox="0 0 24 24" fill="none" stroke="#2B579A" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><text x="7" y="17" font-size="5" fill="#2B579A">DOC</text></svg>`;
            } else if (isSpreadsheet) {
                return `<svg viewBox="0 0 24 24" fill="none" stroke="#217346" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><text x="7" y="17" font-size="5" fill="#217346">XLS</text></svg>`;
            } else if (isPPT) {
                return `<svg viewBox="0 0 24 24" fill="none" stroke="#D24726" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><text x="7" y="17" font-size="5" fill="#D24726">PPT</text></svg>`;
            } else {
                return `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>`;
            }
        }
        
        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }
        
        function downloadAllFiles() {
            const messages = currentPartner.messages || [];
            messages.forEach(msg => {
                if (msg.attachments && msg.attachments.length > 0) {
                    msg.attachments.forEach(att => {
                        const url = att.url || att.data;
                        downloadFile(url, att.name);
                    });
                }
            });
        }

        function renderDetails(container) {
            const p = currentPartner;
            const isMedia = p.recipientType === 'media';

            container.innerHTML = `
                <div class="details-grid">
                    <div class="detail-card">
                        <div class="detail-card-title">Information</div>
                        <div class="detail-row">
                            <span class="detail-row-label">Access Key</span>
                            <span class="detail-row-value"><span class="key-display">${p.id}</span></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-row-label">Type</span>
                            <span class="detail-row-value">${isMedia ? 'Media' : 'University'}</span>
                        </div>
                        ${!isMedia ? `
                            <div class="detail-row">
                                <span class="detail-row-label">University</span>
                                <span class="detail-row-value">${p.universityName || 'N/A'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-row-label">State</span>
                                <span class="detail-row-value">${p.state || 'N/A'}</span>
                            </div>
                        ` : `
                            <div class="detail-row">
                                <span class="detail-row-label">Focus</span>
                                <span class="detail-row-value">${p.focus || 'N/A'}</span>
                            </div>
                        `}
                        <div class="detail-row">
                            <span class="detail-row-label">Status</span>
                            <span class="detail-row-value"><span class="status-indicator ${p.status}">${p.status}</span></span>
                        </div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-card-title">Colors</div>
                        <div class="detail-row">
                            <span class="detail-row-label">Primary</span>
                            <span class="detail-row-value"><div class="color-swatch-row"><div class="color-swatch" style="background:${p.colors?.primary || '#003366'}"></div>${p.colors?.primary || '#003366'}</div></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-row-label">Secondary</span>
                            <span class="detail-row-value"><div class="color-swatch-row"><div class="color-swatch" style="background:${p.colors?.secondary || '#D4A853'}"></div>${p.colors?.secondary || '#D4A853'}</div></span>
                        </div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-card-title">Contacts</div>
                        ${(p.contacts || []).map(c => `
                            <div class="contact-card">
                                <div class="contact-name">${c.name || 'N/A'}</div>
                                <div class="contact-title">${c.title || c.type || ''}</div>
                                <div class="contact-email">${c.email || ''}</div>
                            </div>
                        `).join('') || '<p style="color:var(--text-muted)">No contacts</p>'}
                    </div>
                </div>
            `;
        }

        // ===== MESSAGING =====
        let adminPendingFiles = [];
        const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        function getFileExtension(filename) {
            return filename.split('.').pop().toUpperCase();
        }
        
        function handleAdminFileSelect(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                if (file.size > MAX_FILE_SIZE) {
                    alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
                    return;
                }
                adminPendingFiles.push(file);
            });
            renderAdminFilePreview();
            event.target.value = '';
        }
        
        function renderAdminFilePreview() {
            const container = document.getElementById('adminFilePreview');
            container.innerHTML = adminPendingFiles.map((file, index) => {
                const isImage = file.type.startsWith('image/');
                const ext = file.name.split('.').pop().toUpperCase();
                const size = formatFileSize(file.size);
                return `
                    <div class="file-preview-item">
                        ${isImage ? `<img src="${URL.createObjectURL(file)}" alt="${file.name}">` 
                                  : `<div class="file-icon">${ext}</div>`}
                        <div class="file-preview-info">
                            <div class="file-preview-name">${file.name}</div>
                            <div class="file-preview-size">${size}</div>
                        </div>
                        <button class="file-preview-remove" onclick="removeAdminFile(${index})">&times;</button>
                    </div>
                `;
            }).join('');
        }
        
        function removeAdminFile(index) {
            adminPendingFiles.splice(index, 1);
            renderAdminFilePreview();
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        async function uploadAdminFiles(files) {
            if (!files.length) return [];
            const uploadedFiles = [];
            
            for (const file of files) {
                try {
                    const base64 = await fileToBase64(file);
                    console.log(`Admin uploading file: ${file.name}, size: ${file.size}`);
                    
                    // Try to upload to R2 via API
                    try {
                        const response = await fetch(`${API_BASE}/api/admin/files/upload`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${authToken}`
                            },
                            body: JSON.stringify({
                                partnerId: currentPartner.id,
                                filename: file.name,
                                contentType: file.type,
                                data: base64,
                                size: file.size
                            })
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            console.log('R2 upload success:', result);
                            uploadedFiles.push({
                                id: result.fileId,
                                name: file.name,
                                type: file.type,
                                size: file.size,
                                url: result.url
                            });
                            continue;
                        } else {
                            const errText = await response.text();
                            console.warn('R2 upload failed:', response.status, errText);
                        }
                    } catch (r2Error) {
                        console.warn('R2 upload error:', r2Error);
                    }
                    
                    // Fallback to base64 if R2 upload fails
                    console.log('Using base64 fallback for:', file.name);
                    uploadedFiles.push({
                        id: 'local_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: base64
                    });
                    
                } catch (error) {
                    console.error('File processing error:', error);
                }
            }
            
            console.log('Admin uploaded files:', uploadedFiles.map(f => ({ name: f.name, hasUrl: !!f.url, hasData: !!f.data })));
            return uploadedFiles;
        }
        
        // Image lightbox
        function openLightbox(src) {
            let lightbox = document.getElementById('imageLightbox');
            if (!lightbox) {
                lightbox = document.createElement('div');
                lightbox.id = 'imageLightbox';
                lightbox.className = 'image-lightbox';
                lightbox.innerHTML = `
                    <button class="image-lightbox-close" onclick="closeLightbox()">&times;</button>
                    <img src="" alt="Full size">
                `;
                lightbox.addEventListener('click', (e) => {
                    if (e.target === lightbox) closeLightbox();
                });
                document.body.appendChild(lightbox);
            }
            lightbox.querySelector('img').src = src;
            lightbox.classList.add('active');
        }
        
        function closeLightbox() {
            const lightbox = document.getElementById('imageLightbox');
            if (lightbox) lightbox.classList.remove('active');
        }
        
        async function sendMessage() {
            const content = document.getElementById('composeEditor').value.trim();
            if (!content && adminPendingFiles.length === 0) return;
            if (!currentPartner) return;

            showSaveIndicator('saving');
            
            try {
                // Upload files
                let attachments = [];
                if (adminPendingFiles.length > 0) {
                    console.log('Admin: uploading files...');
                    attachments = await uploadAdminFiles(adminPendingFiles);
                    console.log('Admin: upload complete, attachments:', attachments);
                }
                
                const payload = {
                    partnerId: currentPartner.id,
                    content: content || '(File attachment)',
                    attachments: attachments
                };
                console.log('Admin: sending message payload:', { ...payload, attachments: payload.attachments.map(a => ({ name: a.name, hasUrl: !!a.url, hasData: !!a.data })) });
                
                const response = await fetch(`${API_BASE}/api/admin/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errText = await response.text();
                    console.error('Admin: send message failed:', response.status, errText);
                    throw new Error('Failed to send message');
                }
                
                const data = await response.json();
                console.log('Admin: message sent, response:', data);
                
                // Ensure attachments are preserved
                if (attachments.length > 0 && (!data.message.attachments || data.message.attachments.length === 0)) {
                    console.log('Admin: preserving local attachments');
                    data.message.attachments = attachments;
                }
                
                // Add message to local state
                if (!currentPartner.messages) currentPartner.messages = [];
                currentPartner.messages.push(data.message);
                currentPartner.lastActivity = new Date().toISOString();
                
                document.getElementById('composeEditor').value = '';
                adminPendingFiles = [];
                renderAdminFilePreview();
                
                showSaveIndicator('saved');
                renderCurrentTab();
                renderPartnerList();
                updateCounts();
                
            } catch (error) {
                console.error('Send message error:', error);
                showSaveIndicator('error');
            }
        }

        function confirmDeleteMessage(idx) {
            document.getElementById('confirmTitle').textContent = 'Delete Message?';
            document.getElementById('confirmText').textContent = 'This will permanently remove this message.';
            document.getElementById('confirmAction').onclick = () => deleteMessage(idx);
            openModal('confirmModal');
        }

        async function deleteMessage(idx) {
            if (!currentPartner || !currentPartner.messages || !currentPartner.messages[idx]) {
                closeModal('confirmModal');
                return;
            }
            
            const messageId = currentPartner.messages[idx].id;
            showSaveIndicator('saving');
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/messages/${messageId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to delete message');
                
                currentPartner.messages.splice(idx, 1);
                currentPartner.lastActivity = new Date().toISOString();
                
                showSaveIndicator('saved');
                renderCurrentTab();
                renderPartnerList();
                
            } catch (error) {
                console.error('Delete message error:', error);
                showSaveIndicator('error');
            }
            
            closeModal('confirmModal');
        }

        // ===== TEMPLATES =====
        function processTemplate(template, partner) {
            return template
                .replace(/\{\{partnerName\}\}/g, partner.recipientName || '')
                .replace(/\{\{schoolName\}\}/g, partner.schoolName || partner.recipientName || '')
                .replace(/\{\{universityName\}\}/g, partner.universityName || '')
                .replace(/\{\{outletName\}\}/g, partner.outletName || partner.recipientName || '')
                .replace(/\{\{focus\}\}/g, partner.focus || '')
                .replace(/\{\{state\}\}/g, partner.state || '');
        }

        function loadTemplateContent() {
            const type = document.getElementById('templateType').value;
            document.getElementById('templateEditor').value = templates[type] || '';
        }

        function saveTemplateChanges() {
            const type = document.getElementById('templateType').value;
            templates[type] = document.getElementById('templateEditor').value;
            localStorage.setItem(TEMPLATES_KEY, JSON.stringify(templates));
            closeModal('templateModal');
            if (currentPartner) renderCurrentTab();
            showSaveIndicator('saved');
        }

        function insertQuickReply(type) {
            const template = templates[type] || '';
            const processed = currentPartner ? processTemplate(template, currentPartner) : template;
            document.getElementById('composeEditor').value = processed;
            closeModal('quickReplyModal');
        }

        // ===== IMPORT/EXPORT =====
        function exportData() {
            const data = {
                partners: allPartners,
                templates: templates,
                exportDate: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `luminary-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        document.getElementById('importFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    
                    // Import partners via API
                    if (data.partners) {
                        showSaveIndicator('saving');
                        
                        // Convert to array if it's an object
                        let partnersArray = Array.isArray(data.partners) 
                            ? data.partners 
                            : Object.values(data.partners);
                        
                        const response = await fetch(`${API_BASE}/api/admin/import`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${authToken}`
                            },
                            body: JSON.stringify({ partners: partnersArray })
                        });
                        
                        if (!response.ok) throw new Error('Import failed');
                        
                        const result = await response.json();
                        console.log(`Imported ${result.insertedCount} partners`);
                        
                        // Reload data from API
                        await loadPartnerData();
                        showSaveIndicator('saved');
                    }
                    
                    // Templates still stored locally
                    if (data.templates) {
                        templates = { ...templates, ...data.templates };
                        localStorage.setItem(TEMPLATES_KEY, JSON.stringify(templates));
                    }
                    
                    alert('Data imported successfully!');
                } catch (err) {
                    console.error('Import error:', err);
                    alert('Import failed: ' + err.message);
                    showSaveIndicator('error');
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        });

        // ===== UTILITIES =====
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => showSaveIndicator('saved'));
        }

        function formatDate(d) {
            if (!d) return '';
            return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
        }

        function formatRelativeTime(d) {
            if (!d) return '';
            const diff = Date.now() - new Date(d).getTime();
            const mins = Math.floor(diff / 60000);
            if (mins < 60) return mins + 'm';
            const hrs = Math.floor(diff / 3600000);
            if (hrs < 24) return hrs + 'h';
            const days = Math.floor(diff / 86400000);
            if (days < 7) return days + 'd';
            return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function formatContent(text) {
            return text.replace(/\n/g, '<br>');
        }

        function escapeBackticks(str) {
            return str.replace(/`/g, '\\`').replace(/\$/g, '\\$');
        }

        async function markStatus() {
            if (!currentPartner) return;
            
            let newStatus;
            if (currentPartner.status === 'pending') newStatus = 'viewed';
            else if (currentPartner.status === 'viewed') newStatus = 'responded';
            else return;
            
            showSaveIndicator('saving');
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/partners/status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        partnerId: currentPartner.id,
                        status: newStatus
                    })
                });
                
                if (!response.ok) throw new Error('Failed to update status');
                
                currentPartner.status = newStatus;
                showSaveIndicator('saved');
                updateStatusButton();
                renderPartnerList();
                updateCounts();
                
            } catch (error) {
                console.error('Mark status error:', error);
                showSaveIndicator('error');
            }
        }

        function copyKey() {
            if (currentPartner) copyText(currentPartner.id);
        }

        // ===== EVENT LISTENERS =====
        document.addEventListener('DOMContentLoaded', () => {
            if (!checkAuth()) {
                document.getElementById('accessCode').focus();
            }

            // Nav items
            document.querySelectorAll('.nav-item[data-view]').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    currentView = item.dataset.view;
                    document.getElementById('listTitle').textContent = item.textContent.trim().split(/\d/)[0].trim();
                    renderPartnerList();
                });
            });

            // Actions
            document.querySelectorAll('.nav-item[data-action]').forEach(item => {
                item.addEventListener('click', () => {
                    const action = item.dataset.action;
                    if (action === 'templates') { loadTemplateContent(); openModal('templateModal'); }
                    if (action === 'export') exportData();
                    if (action === 'import') importData();
                    if (action === 'refresh') refreshData();
                });
            });

            // Filters
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    currentFilter = chip.dataset.filter;
                    renderPartnerList();
                });
            });

            // Tabs
            document.querySelectorAll('.detail-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.detail-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentTab = tab.dataset.tab;
                    renderCurrentTab();
                });
            });

            // Search
            document.getElementById('searchInput').addEventListener('input', renderPartnerList);

            // Compose
            document.getElementById('composeEditor').addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'Enter') sendMessage();
            });

            // Buttons
            document.getElementById('btnCopyKey').addEventListener('click', copyKey);
            document.getElementById('btnMarkStatus').addEventListener('click', markStatus);
            document.getElementById('btnInsertTemplate').addEventListener('click', () => openModal('quickReplyModal'));
            document.getElementById('btnSendMessage').addEventListener('click', sendMessage);
            document.getElementById('btnAttachFile').addEventListener('click', () => document.getElementById('adminFileInput').click());
            document.getElementById('adminFileInput').addEventListener('change', handleAdminFileSelect);

            // Escape to close modals
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeModal('templateModal');
                    closeModal('quickReplyModal');
                    closeModal('confirmModal');
                    closeLightbox();
                }
            });
        });
    </script>
</body>
</html>

